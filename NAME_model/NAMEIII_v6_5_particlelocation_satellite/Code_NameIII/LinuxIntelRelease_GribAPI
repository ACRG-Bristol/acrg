# Script for compiling release version of code on Linux PCs with Intel compiler

# This version of the script includes support for GRIB met files by linking with the 
# ECMWF GRIB_API software package.

if test `uname` = 'Linux'
then
 IFORTVERSION=`ifort -V 2>&1 | grep Version | sed 's/.*Version \([0-9]*\).*/\1/'`
 if test ${IFORTVERSION} -ge 11
 then
   USECONVERT='-DUseConvert'
 else
   USECONVERT=
 fi
 if test `uname -p` = 'x86_64'
 then
   ../Executables_Linux/Preprocessor_64bit.exe Mets.P90 Mets.F90
   ../Executables_Linux/Preprocessor_64bit.exe Flows.P90 Flows.F90
   EXL_ARCH=_64bit
 else
   ../Executables_Linux/Preprocessor.exe Mets.P90 Mets.F90
   ../Executables_Linux/Preprocessor.exe Flows.P90 Flows.F90
   EXL_ARCH=
 fi
else
  echo "Error: this script is only intended for compiling NAME under Linux"
  exit 1
fi

NAMEIIICODE_DIR=`pwd`
NAMEIII_BASEDIR=`dirname ${NAMEIIICODE_DIR}`
SHAREDLIB_DIR="${NAMEIII_BASEDIR}/SharedLibraries_Linux"

GRIB_API_LIB=${SHAREDLIB_DIR}/lib
GRIB_API_LIBRARY=grib_api${EXL_ARCH}
GRIB_API_F90_LIBRARY=grib_api_f90${EXL_ARCH}
GRIB_API_INCLUDE=${SHAREDLIB_DIR}/include${EXL_ARCH}

# Note: the following environment variables need to be set at runtime:
#
#export GRIB_DEFINITION_PATH=${SHAREDLIB_DIR}/local/definitions:${SHAREDLIB_DIR}/share/definitions
#export GRIB_SAMPLES_PATH=${SHAREDLIB_DIR}/share/samples
#export GRIB_API_INCLUDE=${SHAREDLIB_DIR}/include${EXL_ARCH}
#export GRIB_API_LIB=${SHAREDLIB_DIR}/lib
#
#export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:${GRIB_API_LIB}

ifort -Wp,-macro=no -O3 -w -extend_source -nbs -Vaxlib -auto -sox  -fPIC \
-DIntelLinCompiler -DGRIBsupport ${USECONVERT} \
CompilerInfo.F90 \
GlobalParameters.F90 \
ErrorAndMessage.F90 \
String.F90 System.F90 Screen.F90 Unit.F90 Time.F90 \
PhysicalUnits.F90 \
Timers.F90 \
Maths.F90 Physics.F90 \
HeadedFile.F90 ErrorAndMessageII.F90 \
CoordinateSystem.F90 GridAndDomain.F90 \
Sort.F90 \
Service.F90 \
FlowAndFlowProfile.F90 SingleSite.F90 Building.F90 \
CommonMet.F90 \
OpenMP.F90 \
NWPUtilities.F90 \
PrototypeMet.F90 SingleSiteMet.F90 NWPMet.F90 RadarMet.F90 AncillaryMet.F90 \
Mets.F90 \
IOThread.F90 \
CommonFlow.F90 \
PrototypeFlow.F90 SingleSiteFlow.F90 NWPFlow.F90 BuildingFlow.F90 RadarFlow.F90 \
LincomFlow.F90 \
Flows.F90 \
ParticleSizeDistribution.F90 Species.F90 Source.F90 \
Fluctuation.F90 \
Output.F90 \
PlumeRise.F90 IterativePlumeRiseModel.F90 \
Particle.F90 Puff.F90 \
SemiLagrangian.F90 EulerianInterface.F90 \
ChemistryScheme.F90 Chemistry.F90 Case.F90 \
Restart.F90 \
Input.F90 \
MainNameIII.F90 \
-I${GRIB_API_INCLUDE} \
-L${GRIB_API_LIB} -l${GRIB_API_F90_LIBRARY} -l${GRIB_API_LIBRARY} \
-o nameiiiGribAPI.exe

if test `uname` = 'Linux'
then
 if test `uname -p` = 'x86_64'
 then
   mv nameiiiGribAPI.exe ../Executables_Linux/nameiiiGribAPI_64bit.exe
   chmod 744 ../Executables_Linux/nameiiiGribAPI_64bit.exe
 else
   mv nameiiiGribAPI.exe ../Executables_Linux/nameiiiGribAPI.exe
   chmod 744 ../Executables_Linux/nameiiiGribAPI.exe
  fi
fi 

rm *.mod

exit 0
