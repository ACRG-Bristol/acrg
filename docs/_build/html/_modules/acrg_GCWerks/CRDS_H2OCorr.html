<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>acrg_GCWerks.CRDS_H2OCorr &#8212; acrg  documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for acrg_GCWerks.CRDS_H2OCorr</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Thu Jun 11 12:24:37 2015</span>

<span class="sd">@author: as13988</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">acrg_GCWerks</span> <span class="k">import</span> <span class="n">acrg_read_GCwerks</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> 
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">ticker</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">curve_fit</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">listdir</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">isfile</span><span class="p">,</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">groupby</span>
<span class="kn">from</span> <span class="nn">scipy.odr</span> <span class="k">import</span> <span class="n">ODR</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Data</span><span class="p">,</span> <span class="n">RealData</span>

<span class="c1"># Read in the data for a given list of sites and list of years</span>
<span class="c1"># calculate the fits and do the plotting</span>
<span class="c1"># defaults to a dry_cutoff of 0.0001</span>
<span class="c1"># h2o_sd is a filter based on h2o standard deviation</span>
<span class="c1"># co2_sd is a filter based on co2 standard deviation</span>
<span class="c1"># ch4_sd is a filter based on ch4 standard deviation</span>
<span class="c1"># ignore first ignores the first x mins of the wet section defaults to 5</span>
<span class="c1"># use_drygaps = set if you want to identify the wet periods as the &quot;non dry&quot; bits</span>
<span class="c1"># h2o_jump = set to the gap between consecutive h2o measurments that&#39;s used to identify the start of wet section defaults to 0.4</span>
<span class="c1"># H2Orange = set the H2O x axis range on the residual plots</span>
<div class="viewcode-block" id="calcread_multi"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.calcread_multi">[docs]</a><span class="k">def</span> <span class="nf">calcread_multi</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">years</span><span class="p">,</span> <span class="n">basedir</span> <span class="o">=</span> <span class="s1">&#39;/Users/as13988/Documents/Work/Picarro/H2OCorr/&#39;</span><span class="p">,</span> <span class="n">dir_suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">quick_plot</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> \
<span class="n">h2o_jump</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">ignorefirst</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">dry_cutoff</span> <span class="o">=</span> <span class="mf">0.005</span><span class="p">,</span> <span class="n">h2o_sd</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">co2_sd</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ch4_sd</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span>  <span class="n">H2O_Range</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">No_plots</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sd_flag</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">means_all</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1">#loop through the sites</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
        <span class="c1">#loop through the years</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
            <span class="c1">#find the files</span>
            <span class="nb">print</span> <span class="s1">&#39;Processing &#39;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">raw_files</span> <span class="o">=</span> <span class="n">find_files</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">indir</span> <span class="o">=</span> <span class="n">basedir</span> <span class="o">+</span> <span class="s1">&#39;raw/&#39;</span><span class="o">+</span><span class="n">dir_suffix</span><span class="p">)</span>
            <span class="n">instcorr_files</span> <span class="o">=</span> <span class="n">find_files</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">indir</span> <span class="o">=</span> <span class="n">basedir</span> <span class="o">+</span> <span class="s1">&#39;inbuiltcorr/&#39;</span><span class="o">+</span><span class="n">dir_suffix</span><span class="p">)</span>

            <span class="c1"># if there are separate wet and dry files process the old way</span>
            <span class="k">if</span> <span class="n">raw_files</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1">#read in the data</span>
                <span class="n">wet_raw</span> <span class="o">=</span> <span class="n">read_data_multi</span><span class="p">(</span><span class="n">raw_files</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">wet_instcorr</span> <span class="o">=</span> <span class="n">read_data_multi</span><span class="p">(</span><span class="n">instcorr_files</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">dry_data</span> <span class="o">=</span> <span class="n">read_data_multi</span><span class="p">(</span><span class="n">raw_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># or process the new way</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="n">wet_raw</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">dry_data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">wet_instcorr</span> <span class="o">=</span> <span class="p">[]</span>
                
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">item_k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">raw_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">wet_k</span><span class="p">,</span> <span class="n">dry_k</span> <span class="o">=</span> <span class="n">define_wetdry</span><span class="p">(</span><span class="n">basedir</span> <span class="o">+</span> <span class="s1">&#39;raw/&#39;</span><span class="o">+</span><span class="n">dir_suffix</span> <span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span> <span class="n">item_k</span><span class="p">,</span> <span class="n">quick_plot</span><span class="o">=</span><span class="n">quick_plot</span><span class="p">,</span> <span class="n">ignorefirst</span> <span class="o">=</span> <span class="n">ignorefirst</span><span class="p">,</span> <span class="n">h2o_jump</span> <span class="o">=</span> <span class="n">h2o_jump</span><span class="p">,</span> <span class="n">dry_cutoff</span> <span class="o">=</span> <span class="n">dry_cutoff</span><span class="p">,</span> <span class="n">h2o_sd</span> <span class="o">=</span> <span class="n">h2o_sd</span><span class="p">,</span> <span class="n">co2_sd</span> <span class="o">=</span> <span class="n">co2_sd</span><span class="p">)</span>
                    <span class="n">instwet_k</span><span class="p">,</span> <span class="n">instdry_k</span> <span class="o">=</span> <span class="n">define_wetdry</span><span class="p">(</span><span class="n">basedir</span> <span class="o">+</span> <span class="s1">&#39;inbuiltcorr/&#39;</span><span class="o">+</span><span class="n">dir_suffix</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span> <span class="n">item_k</span><span class="p">,</span> <span class="n">ignorefirst</span> <span class="o">=</span> <span class="n">ignorefirst</span><span class="p">,</span> <span class="n">h2o_jump</span> <span class="o">=</span> <span class="n">h2o_jump</span><span class="p">,</span> <span class="n">dry_cutoff</span> <span class="o">=</span> <span class="n">dry_cutoff</span><span class="p">,</span> <span class="n">h2o_sd</span> <span class="o">=</span> <span class="n">h2o_sd</span><span class="p">,</span> <span class="n">co2_sd</span> <span class="o">=</span> <span class="n">co2_sd</span><span class="p">)</span>
                
                    <span class="c1"># check that there was dry data for the run</span>
                    <span class="c1"># if so keep the data</span>
                    <span class="c1"># if not just discard it</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dry_k</span><span class="o">.</span><span class="n">co2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">wet_raw</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">wet_k</span><span class="p">)</span>    
                        <span class="n">dry_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">dry_k</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wet_k</span><span class="p">))])</span>
                        <span class="n">wet_instcorr</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">instwet_k</span><span class="p">)</span>          
                                    
            <span class="c1"># calculate the fits and plot individual runs</span>
            <span class="c1"># THIS ASSUMES THAT THERE ARE THE SAME NUMBER OF INSTCORR FILES AS THERE ARE NORMAL FILES!</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">means</span> <span class="o">=</span> <span class="n">plot_ratio_multi</span><span class="p">(</span><span class="n">wet_raw</span><span class="p">,</span> <span class="n">dry_data</span><span class="p">,</span> <span class="n">wet_instcorr</span><span class="p">,</span> <span class="n">dir_suffix</span> <span class="o">=</span> <span class="n">dir_suffix</span><span class="p">,</span> <span class="n">No_plots</span> <span class="o">=</span> <span class="n">No_plots</span><span class="p">,</span> <span class="n">sd_flag</span> <span class="o">=</span> <span class="n">sd_flag</span><span class="p">)</span>
            
            <span class="c1"># plot the change from the built in residual for ALL runs</span>
            <span class="n">plot_residual</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">wet_raw</span><span class="p">,</span> <span class="n">wet_instcorr</span><span class="p">,</span> <span class="n">dry_data</span><span class="p">,</span> <span class="n">saveas</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dir_suffix</span> <span class="o">=</span> <span class="n">dir_suffix</span><span class="p">,</span> <span class="n">useinbuilt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">H2O_Range</span> <span class="o">=</span> <span class="n">H2O_Range</span><span class="p">,</span> <span class="n">sd_flag</span> <span class="o">=</span> <span class="n">sd_flag</span><span class="p">)</span>
            
            <span class="n">outputs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">output</span>
            <span class="n">means_all</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">means</span>
    
    <span class="k">return</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">means_all</span></div>


<span class="c1"># Read in a file that contains both wet and dry data</span>
<span class="c1"># Identify the dry periods based on a given H2O tolerance</span>
<span class="c1"># The identify the wet periods and how many &quot;runs&quot; there have been in the episode.</span>
<span class="c1"># defaults to a dry_cutoff of 0.0001</span>
<span class="c1"># h2o_sd is a filter based on h2o standard deviation</span>
<span class="c1"># co2_sd is a filter based on co2 standard deviation</span>
<span class="c1"># ch4_sd is a filter based on ch4 standard deviation</span>
<span class="c1"># ignore first ignores the first x mins of the wet section defaults to 5</span>
<span class="c1"># use_drygaps = set if you want to identify the wet periods as the &quot;non dry&quot; bits</span>
<span class="c1"># h2o_jump = set to the gap between consecutive h2o measurments that&#39;s used to identify the start of wet section defaults to 0.4</span>
<div class="viewcode-block" id="define_wetdry"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.define_wetdry">[docs]</a><span class="k">def</span> <span class="nf">define_wetdry</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">dry_cutoff</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="n">h2o_sd</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">h2o_jump</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">co2_sd</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ch4_sd</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">ignorefirst</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>\
 <span class="n">use_drygaps</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">quick_plot</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

    <span class="c1"># read in the data</span>
    <span class="n">data_all</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>

    <span class="c1"># Extract the good H2O, CO2 and CH4 data and datetimes</span>
    <span class="n">good</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">data_all</span><span class="o">.</span><span class="n">co2flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">h2o_sd</span> <span class="o">&gt;</span> <span class="n">data_all</span><span class="o">.</span><span class="n">h2osd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">co2_sd</span> <span class="o">&gt;</span> <span class="n">data_all</span><span class="o">.</span><span class="n">co2sd</span><span class="p">)</span><span class="o">&amp;</span> <span class="p">(</span><span class="n">ch4_sd</span> <span class="o">&gt;</span> <span class="n">data_all</span><span class="o">.</span><span class="n">ch4sd</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">good</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;There are no good points in file: &#39;</span> <span class="o">+</span> <span class="n">infile</span>
    <span class="n">h2o</span> <span class="o">=</span> <span class="n">data_all</span><span class="o">.</span><span class="n">h2o</span><span class="p">[</span><span class="n">good</span><span class="p">]</span>
    
    <span class="n">datetime</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_all</span><span class="o">.</span><span class="n">datetime</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">good</span><span class="p">]</span>    
    
    <span class="c1"># use the dry_sections class to extract these</span>
    <span class="n">dry_data</span> <span class="o">=</span> <span class="n">dry_sections</span><span class="p">(</span><span class="n">data_all</span><span class="p">,</span> <span class="n">dry_cutoff</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dry_data</span><span class="o">.</span><span class="n">co2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;There was no data with H2O &lt; &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dry_cutoff</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; for file &#39;</span> <span class="o">+</span> <span class="n">data_all</span><span class="o">.</span><span class="n">filename</span>
        
    <span class="c1"># This determines the runs based on intervening dry sections but not every test run has dry bewtween it</span>
    <span class="k">if</span> <span class="n">use_drygaps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Find the gaps</span>
        <span class="n">diff_days</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">days</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dry_datetime</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">dry_datetime</span><span class="p">,</span> <span class="mi">1</span><span class="p">))]</span>
        <span class="n">diff_seconds</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">seconds</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dry_datetime</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">dry_datetime</span><span class="p">,</span> <span class="mi">1</span><span class="p">))]</span>
        
        <span class="n">diff_minutes</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">diff_days</span><span class="p">)</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">diff_seconds</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
    
        <span class="c1"># gaps will be where the difference is &gt;1</span>
        <span class="c1"># this index is the FIRST point of each block</span>
        <span class="n">gaps_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">diff_minutes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="n">gaps_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">diff_minutes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">diff_minutes</span><span class="p">)]))</span>
    
    <span class="c1"># else do it based on where rapid periods of increase in H2O occurs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># find where the H2O has increased rapidly</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">h2o</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">h2o</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">h2o_jump</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># check if it&#39;s accidentally picked up the last point</span>
        <span class="c1"># If so discard it</span>
        <span class="k">if</span> <span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">h2o</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># find where these increases are grouped together</span>
        <span class="n">gaps_start</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="k">lambda</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">):</span><span class="n">i</span><span class="o">-</span><span class="n">x</span><span class="p">):</span>
            <span class="n">group</span> <span class="o">=</span>  <span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">g</span><span class="p">)</span>
            <span class="c1">#print group</span>
            <span class="n">gaps_start</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="c1"># define the end of the run</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gaps_start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">gaps_end</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gaps_start</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">h2o</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gaps_end</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">h2o</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>                

        <span class="c1"># need to remove blocks of very short length</span>
        <span class="n">gap_length</span> <span class="o">=</span> <span class="p">[</span><span class="n">gaps_end</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">gaps_start</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gaps_start</span><span class="p">))]</span>
        
        <span class="n">big_gap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gap_length</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">gaps_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gaps_start</span><span class="p">)[</span><span class="n">big_gap</span><span class="p">]</span>
        <span class="n">gaps_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gaps_end</span><span class="p">)[</span><span class="n">big_gap</span><span class="p">]</span>

        <span class="c1"># DECIDED TO IGNORE THE FIRST 15 MINS OF EACH RUN</span>
        <span class="n">gaps_start</span> <span class="o">=</span> <span class="n">gaps_start</span> <span class="o">+</span> <span class="n">ignorefirst</span>



        <span class="nb">print</span> <span class="s1">&#39;Have identified &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gaps_start</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; runs&#39;</span>
        
    <span class="c1"># Extract the data for each run</span>
    <span class="n">wet_runs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">start_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gaps_start</span><span class="p">):</span>
        
        <span class="c1"># use the wet_sections class to extract these</span>
        <span class="n">run_i</span> <span class="o">=</span> <span class="n">wet_sections</span><span class="p">(</span><span class="n">data_all</span><span class="p">,</span> <span class="n">start_i</span><span class="p">,</span> <span class="n">gaps_end</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">co2_sd</span> <span class="o">=</span> <span class="n">co2_sd</span><span class="p">,</span> <span class="n">h2o_sd</span> <span class="o">=</span> <span class="n">h2o_sd</span><span class="p">)</span>
        <span class="n">wet_runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run_i</span><span class="p">)</span> 

    <span class="c1"># Do a quick plot of the H2O data to show if the separate runs have been identified</span>
    <span class="k">if</span> <span class="n">quick_plot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">h2o</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># find the number of runs</span>
        <span class="n">no_runs</span> <span class="o">=</span>  <span class="nb">len</span><span class="p">(</span><span class="n">wet_runs</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">no_runs</span><span class="p">):</span>    
            <span class="n">run_i</span> <span class="o">=</span> <span class="n">wet_runs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">blue</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">no_runs</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">run_i</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">run_i</span><span class="o">.</span><span class="n">h2o</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="n">blue</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="n">blue</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dry_data</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">dry_data</span><span class="o">.</span><span class="n">h2o</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">wet_runs</span><span class="p">,</span> <span class="n">dry_data</span></div>


<span class="c1"># extract the dry sections</span>
<div class="viewcode-block" id="dry_sections"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.dry_sections">[docs]</a><span class="k">class</span> <span class="nc">dry_sections</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_all</span><span class="p">,</span> <span class="n">dry_cutoff</span><span class="p">):</span>
        <span class="n">good</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_all</span><span class="o">.</span><span class="n">co2flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">h2o</span> <span class="o">=</span> <span class="n">data_all</span><span class="o">.</span><span class="n">h2o</span><span class="p">[</span><span class="n">good</span><span class="p">]</span>
    
        <span class="c1"># Find the &quot;dry&quot; sections</span>
        <span class="n">dry_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">h2o</span> <span class="o">&lt;</span> <span class="n">dry_cutoff</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># want to replicate the class structure of data_all         </span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_all</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># if it&#39;s a numpy array then extract the data using the index</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">data_all</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">data_all</span><span class="p">,</span> <span class="n">i</span><span class="p">)[</span><span class="n">good</span><span class="p">][</span><span class="n">dry_index</span><span class="p">])</span>
                
            <span class="c1"># if it&#39;s a list then extract the data using the list syntax and the index</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">data_all</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">dummy_1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">data_all</span><span class="p">,</span> <span class="n">i</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">good</span><span class="p">]</span>             
                <span class="n">dummy_2</span> <span class="o">=</span> <span class="p">[</span><span class="n">dummy_1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dry_index</span><span class="p">]</span> 
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dummy_2</span><span class="p">)</span>
                                                
            <span class="c1"># if it&#39;s anything else keep it all</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">data_all</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">data_all</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="nb">list</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">data_all</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span></div>

        
<span class="c1"># extract the wet sections</span>
<div class="viewcode-block" id="wet_sections"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.wet_sections">[docs]</a><span class="k">class</span> <span class="nc">wet_sections</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_all</span><span class="p">,</span> <span class="n">start_gap</span><span class="p">,</span> <span class="n">end_gap</span><span class="p">,</span> <span class="n">h2o_sd</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">co2_sd</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    
        <span class="n">good</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">data_all</span><span class="o">.</span><span class="n">co2flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">h2o_sd</span> <span class="o">&gt;</span> <span class="n">data_all</span><span class="o">.</span><span class="n">h2osd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">co2_sd</span> <span class="o">&gt;</span> <span class="n">data_all</span><span class="o">.</span><span class="n">co2sd</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># want to replicate the class structure of data_all         </span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_all</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># if it&#39;s a numpy array then extract the data using the start and ends of the gaps</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">data_all</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">data_all</span><span class="p">,</span> <span class="n">i</span><span class="p">)[</span><span class="n">good</span><span class="p">][</span><span class="n">start_gap</span><span class="p">:</span><span class="n">end_gap</span><span class="p">])</span>
                
            <span class="c1"># if it&#39;s a list then extract the data using the list syntax and the  start and ends of the gaps</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">data_all</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">dummy_1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">data_all</span><span class="p">,</span> <span class="n">i</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">good</span><span class="p">]</span>       
                <span class="n">dummy_2</span> <span class="o">=</span> <span class="p">[</span><span class="n">dummy_1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">end_gap</span> <span class="o">-</span> <span class="n">start_gap</span><span class="p">)</span><span class="o">+</span><span class="n">start_gap</span><span class="p">)]</span> 
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dummy_2</span><span class="p">)</span>
                                                
            <span class="c1"># if it&#39;s anything else keep it all</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">data_all</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">data_all</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="nb">list</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">data_all</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span></div>


<span class="c1"># Find the files for a given site</span>
<span class="c1"># Syntax: dryfiles, wetfiles = CRDS_H2OCorr.findfiles(site)</span>
<div class="viewcode-block" id="find_files"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.find_files">[docs]</a><span class="k">def</span> <span class="nf">find_files</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">indir</span><span class="o">=</span><span class="s1">&#39;/Users/as13988/Documents/Work/Picarro/H2OCorr/Raw/&#39;</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> 
    
    <span class="n">onlyfiles</span> <span class="o">=</span> <span class="p">[</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">indir</span><span class="p">)</span> <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span><span class="n">f</span><span class="p">))</span> <span class="p">]</span>
    <span class="n">sitefiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">onlyfiles</span> <span class="k">if</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">n</span><span class="p">]</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sitefiles</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sitefiles</span><span class="p">,</span><span class="n">dates</span><span class="p">)</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="ow">in</span> <span class="n">g</span><span class="p">]</span>
    <span class="n">dry_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">indir</span> <span class="o">+</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="s1">&#39;dry&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
    <span class="n">wet_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">indir</span> <span class="o">+</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="s1">&#39;wet&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>    
       
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">wet_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">files</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>       
        <span class="k">return</span> <span class="n">dry_files</span><span class="p">,</span> <span class="n">wet_files</span></div>

<span class="c1"># Read multiple runs in</span>
<div class="viewcode-block" id="read_data_multi"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.read_data_multi">[docs]</a><span class="k">def</span> <span class="nf">read_data_multi</span><span class="p">(</span><span class="n">datafilelist</span><span class="p">):</span> 
    
    <span class="n">datalist</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datafilelist</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">datafilelist</span> <span class="o">=</span> <span class="n">datafilelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">datafilelist</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">acrg_read_GCwerks</span><span class="o">.</span><span class="n">read_gcexport_crds</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>   
        <span class="n">datalist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">datalist</span></div>

<span class="c1"># Reads in the GCWerks output</span>
<div class="viewcode-block" id="read_data"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.read_data">[docs]</a><span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">datafile</span><span class="p">):</span> 
    
    <span class="n">data</span> <span class="o">=</span> <span class="n">acrg_read_GCwerks</span><span class="o">.</span><span class="n">read_gcexport_crds</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">data</span></div>
    
<span class="c1"># Plot the raw CO2, CH4 and H2O data</span>
<div class="viewcode-block" id="plot_raw"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.plot_raw">[docs]</a><span class="k">def</span> <span class="nf">plot_raw</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">=</span> <span class="s1">&#39;/Users/as13988/Documents/Work/Picarro/H2OCorr/Plots/&#39;</span><span class="p">):</span>
   
    <span class="nb">print</span> <span class="s1">&#39;Plotting: &#39;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">filename</span>
    
    <span class="n">splitstr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">site</span> <span class="o">=</span> <span class="p">(</span><span class="n">splitstr</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">testdate</span> <span class="o">=</span> <span class="n">splitstr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">splitstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">co2flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">plot_dt</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">dt_date</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">]</span>
    
    <span class="n">x_formatter</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s1">&#39;%H:%M&#39;</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
    
    <span class="c1"># Plot CO2</span>
    <span class="n">labelx</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
        
    <span class="n">plt1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_dt</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">co2_dry</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>  <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">plt1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_dt</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">co2_wet</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>  <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">plt1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">site</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">testdate</span><span class="o">+</span> <span class="s1">&#39; H2O Test&#39;</span><span class="p">)</span>
    <span class="n">plt1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;CO$_2$ raw&#39;</span><span class="p">)</span>
    <span class="n">plt1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">x_formatter</span><span class="p">)</span>
    <span class="n">y_formatter</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">ScalarFormatter</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plt1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">y_formatter</span><span class="p">)</span>
    <span class="n">plt1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="n">labelx</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        
    <span class="c1"># Plot CH4</span>
    <span class="n">plt2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_dt</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">ch4_dry</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_dt</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">ch4_wet</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;CH$_4$ raw&#39;</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">x_formatter</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">y_formatter</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="n">labelx</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    
    <span class="c1"># Plot H2O</span>
    <span class="n">plt3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">plt3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_dt</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">h2o</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>
    <span class="n">plt3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;H$_2$O raw&#39;</span><span class="p">)</span>
    <span class="n">plt3</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">x_formatter</span><span class="p">)</span>
    <span class="n">plt3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">y_formatter</span><span class="p">)</span>
    <span class="n">plt3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="n">labelx</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
   
    <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.82</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;Dry = solid&#39;</span> <span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.82</span><span class="p">,</span> <span class="mf">0.17</span><span class="p">,</span> <span class="s1">&#39;Wet = dashed&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>       

    <span class="nb">print</span> <span class="s1">&#39;Plot saved as: &#39;</span> <span class="o">+</span> <span class="n">outdir</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">site</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="s1">&#39;Raw_&#39;</span><span class="o">+</span><span class="n">tag</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">site</span><span class="o">+</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">testdate</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">site</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="s1">&#39;Raw_&#39;</span><span class="o">+</span><span class="n">tag</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">site</span><span class="o">+</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">testdate</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">return</span> </div>

<span class="c1"># Plot the raw data against the H2O</span>
<span class="c1"># syntax: CRDS_H2OCorr.plot_H2O(data)</span>
<div class="viewcode-block" id="plot_H2O"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.plot_H2O">[docs]</a><span class="k">def</span> <span class="nf">plot_H2O</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">=</span> <span class="s1">&#39;/Users/as13988/Documents/Work/Picarro/H2OCorr/Plots/&#39;</span><span class="p">,</span> <span class="n">species</span> <span class="o">=</span><span class="s1">&#39;co2&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    
    <span class="n">splitstr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">site</span> <span class="o">=</span> <span class="p">(</span><span class="n">splitstr</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">testdate</span> <span class="o">=</span> <span class="n">splitstr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">splitstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">co2flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>

    <span class="c1"># Set the correct gas </span>
    <span class="n">wet_key</span> <span class="o">=</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;_wet&#39;</span>
    <span class="n">dry_key</span> <span class="o">=</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;_dry&#39;</span>
    <span class="n">wetsd_key</span> <span class="o">=</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;sd&#39;</span>


    <span class="n">labels_1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;co2&#39;</span> <span class="p">:</span> <span class="s1">&#39;CO$_2$ wet&#39;</span><span class="p">,</span> <span class="s1">&#39;ch4&#39;</span> <span class="p">:</span><span class="s1">&#39;CH$_4$ wet&#39;</span><span class="p">}</span>
    <span class="n">labels_2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;co2&#39;</span> <span class="p">:</span> <span class="s1">&#39;CO$_2$ raw&#39;</span><span class="p">,</span> <span class="s1">&#39;ch4&#39;</span> <span class="p">:</span><span class="s1">&#39;CH$_4$ raw&#39;</span><span class="p">}</span>
   
    
    
    <span class="c1"># Plot dry vs CO2 wet</span>
    <span class="n">plt1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">wetdata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wet_key</span><span class="p">)</span>
    <span class="n">wetsddata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wetsd_key</span><span class="p">)</span>
    
    <span class="n">plt1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">h2o</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">wetdata</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>  <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">plt1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">labels_1</span><span class="p">[</span><span class="n">species</span><span class="p">])</span>
    <span class="n">plt1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;H$_2$O&#39;</span><span class="p">)</span>
    <span class="n">y_formatter</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">ScalarFormatter</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plt1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">y_formatter</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.27</span><span class="p">,</span> <span class="mf">0.58</span><span class="p">,</span><span class="s1">&#39;Raw data - no correction&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    
    <span class="c1"># Plot dry vs H2O</span>
    <span class="n">plt2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">drydata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dry_key</span><span class="p">)</span>
    <span class="c1">#plt2.plot(data.h2o[index], drydata[index], &#39;o&#39;, color = &#39;green&#39;)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">h2o</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">drydata</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span> <span class="n">wetsddata</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">labels_2</span><span class="p">[</span><span class="n">species</span><span class="p">])</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;H$_2$O raw&#39;</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">y_formatter</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.27</span><span class="p">,</span> <span class="mf">0.42</span><span class="p">,</span> <span class="s1">&#39;Raw data - built in correction&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span> 
 
    <span class="nb">print</span> <span class="s1">&#39;Plot saved as: &#39;</span> <span class="o">+</span> <span class="n">outdir</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">site</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="s1">&#39;VsH2O_&#39;</span><span class="o">+</span><span class="n">tag</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">site</span><span class="o">+</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">testdate</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="n">species</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">site</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="s1">&#39;VsH2O_&#39;</span><span class="o">+</span><span class="n">tag</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">site</span><span class="o">+</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">testdate</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">return</span> </div>


<span class="c1"># plot multiple run ratios for both CO2 and CH4</span>
<span class="c1"># NB: wetdata and drydata are lists containing the data as read in using read_data_multi</span>
<span class="c1"># nocorrdata is the data without the instrument specific correction applied</span>
<div class="viewcode-block" id="plot_ratio_multi"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.plot_ratio_multi">[docs]</a><span class="k">def</span> <span class="nf">plot_ratio_multi</span><span class="p">(</span><span class="n">wetdata</span><span class="p">,</span> <span class="n">drydata</span><span class="p">,</span> <span class="n">nocorrdata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">=</span> <span class="s1">&#39;/Users/as13988/Documents/Work/Picarro/H2OCorr/Plots/&#39;</span><span class="p">,</span> <span class="n">dir_suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">h2o_tag</span> <span class="o">=</span> <span class="s1">&#39;h2o&#39;</span><span class="p">,</span> <span class="n">No_plots</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sd_flag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">gases</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CO2&#39;</span><span class="p">,</span> <span class="s1">&#39;CH4&#39;</span><span class="p">]</span>
    <span class="n">species</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;co2&#39;</span><span class="p">,</span><span class="s1">&#39;ch4&#39;</span><span class="p">]</span>
    
    <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
                 
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gases</span><span class="p">)):</span>
        <span class="n">params</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">corr</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">err</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">h2o</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">sd</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">h2o_sd</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">filenames</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">dates</span><span class="o">=</span><span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wetdata</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">nocorrdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nocorrdata_i</span> <span class="o">=</span> <span class="n">nocorrdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nocorrdata_i</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># optional to use different dry periods</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">drydata</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>            
                <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">f</span> <span class="o">=</span> <span class="n">plot_ratio</span><span class="p">(</span><span class="n">wetdata</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">drydata</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nocorrdata</span> <span class="o">=</span> <span class="n">nocorrdata_i</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">dir_suffix</span> <span class="o">=</span> <span class="n">dir_suffix</span><span class="p">,</span> <span class="n">species</span> <span class="o">=</span> <span class="n">species</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">h2o_tag</span><span class="o">=</span><span class="n">h2o_tag</span><span class="p">,</span> <span class="n">No_plots</span> <span class="o">=</span> <span class="n">No_plots</span><span class="p">,</span> <span class="n">sd_flag</span> <span class="o">=</span> <span class="n">sd_flag</span><span class="p">)</span>
            
            <span class="c1"># Use all dry data as a single dry period       </span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">e</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">plot_ratio</span><span class="p">(</span><span class="n">wetdata</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">drydata</span><span class="p">,</span> <span class="n">nocorrdata</span> <span class="o">=</span>  <span class="n">nocorrdata_i</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">dir_suffix</span> <span class="o">=</span> <span class="n">dir_suffix</span><span class="p">,</span> <span class="n">species</span> <span class="o">=</span> <span class="n">species</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">h2o_tag</span><span class="o">=</span><span class="n">h2o_tag</span><span class="p">,</span> <span class="n">No_plots</span> <span class="o">=</span> <span class="n">No_plots</span><span class="p">,</span> <span class="n">sd_flag</span> <span class="o">=</span> <span class="n">sd_flag</span><span class="p">)</span>
   
            
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">corr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>            
            <span class="n">h2o</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">err</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">sd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">h2o_sd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wetdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wetdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            
        <span class="n">gas_j</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;params&#39;</span> <span class="p">:</span> <span class="n">params</span><span class="p">,</span>\
                    <span class="s1">&#39;corr&#39;</span> <span class="p">:</span> <span class="n">corr</span><span class="p">,</span> \
                    <span class="s1">&#39;residual&#39;</span> <span class="p">:</span> <span class="n">err</span><span class="p">,</span> \
                    <span class="s1">&#39;sd&#39;</span> <span class="p">:</span> <span class="n">sd</span><span class="p">,</span> \
                    <span class="s1">&#39;h2o&#39;</span> <span class="p">:</span> <span class="n">h2o</span><span class="p">,</span> \
                    <span class="s1">&#39;h2o_sd&#39;</span> <span class="p">:</span> <span class="n">h2o_sd</span><span class="p">,</span> \
                    <span class="s1">&#39;filenames&#39;</span> <span class="p">:</span> <span class="n">filenames</span><span class="p">,</span> \
                    <span class="s1">&#39;dates&#39;</span> <span class="p">:</span> <span class="n">dates</span><span class="p">}</span>


        <span class="n">output</span><span class="p">[</span><span class="n">gases</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">gas_j</span>
    
    <span class="c1"># Print out the fits</span>
    <span class="nb">print</span> <span class="s1">&#39;Fit Y =  1 + a*X + b*(X*X)&#39;</span>
    <span class="nb">print</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;CO2&#39;</span><span class="p">][</span><span class="s1">&#39;filenames&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="nb">print</span> <span class="s1">&#39;CO2 parameters&#39;</span>
    <span class="nb">print</span> <span class="s1">&#39;datetime, a, a_sd, b, b_sd&#39;</span>
    <span class="n">a_co2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">b_co2</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;CO2&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]):</span>
        <span class="nb">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;CO2&#39;</span><span class="p">][</span><span class="s1">&#39;dates&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> \
                    <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.7f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span><span class="s1">&#39;, &#39;</span> \
                    <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.7f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;CO2&#39;</span><span class="p">][</span><span class="s1">&#39;corr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> \
                    <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.7f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> \
                    <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.7f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;CO2&#39;</span><span class="p">][</span><span class="s1">&#39;corr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">a_co2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">b_co2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">mean_a_co2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a_co2</span><span class="p">))</span>
    <span class="n">stdev_a_co2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a_co2</span><span class="p">))</span>
    <span class="n">mean_b_co2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b_co2</span><span class="p">))</span>
    <span class="n">stdev_b_co2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b_co2</span><span class="p">))</span>
    
    <span class="nb">print</span> <span class="s1">&#39;&#39;</span>
    <span class="nb">print</span> <span class="s1">&#39;mean&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> \
        <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.7f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mean_a_co2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> \
        <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.7f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stdev_a_co2</span><span class="p">)</span> <span class="o">+</span>  <span class="s1">&#39;, &#39;</span> \
        <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.7f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mean_b_co2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> \
        <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.7f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stdev_b_co2</span><span class="p">)</span>
       
    
    <span class="nb">print</span> <span class="s1">&#39;&#39;</span>
    <span class="nb">print</span> <span class="s1">&#39;&#39;</span>
    <span class="nb">print</span> <span class="s1">&#39;CH4 parameters&#39;</span>
    <span class="nb">print</span> <span class="s1">&#39;datetime, a, a_sd, b, b_sd&#39;</span>
    <span class="n">a_ch4</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">b_ch4</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;CH4&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]):</span>
        <span class="nb">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;CH4&#39;</span><span class="p">][</span><span class="s1">&#39;dates&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> \
                    <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.6f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span><span class="s1">&#39;, &#39;</span> \
                    <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.6f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;CH4&#39;</span><span class="p">][</span><span class="s1">&#39;corr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> \
                    <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.6f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> \
                    <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.6f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;CH4&#39;</span><span class="p">][</span><span class="s1">&#39;corr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">a_ch4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">b_ch4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
    <span class="n">mean_a_ch4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a_ch4</span><span class="p">))</span>
    <span class="n">stdev_a_ch4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a_ch4</span><span class="p">))</span>
    <span class="n">mean_b_ch4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b_ch4</span><span class="p">))</span>
    <span class="n">stdev_b_ch4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b_ch4</span><span class="p">))</span>
    
    <span class="nb">print</span> <span class="s1">&#39;&#39;</span>
    <span class="nb">print</span> <span class="s1">&#39;mean&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> \
            <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.7f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mean_a_ch4</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> \
            <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.7f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stdev_a_ch4</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> \
            <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.7f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mean_b_ch4</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> \
            <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.7f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stdev_b_ch4</span><span class="p">)</span>

    <span class="n">means</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a_co2&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">mean_a_co2</span><span class="p">],</span> \
            <span class="s2">&quot;a_co2_sd&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">stdev_a_co2</span><span class="p">],</span> \
            <span class="s2">&quot;b_co2&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">mean_b_co2</span><span class="p">],</span> \
            <span class="s2">&quot;b_co2_sd&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">stdev_b_co2</span><span class="p">],</span> \
            <span class="s2">&quot;a_ch4&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">mean_a_ch4</span><span class="p">],</span> \
            <span class="s2">&quot;a_ch4_sd&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">stdev_a_ch4</span><span class="p">],</span> \
            <span class="s2">&quot;b_ch4&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">mean_b_ch4</span><span class="p">],</span> \
            <span class="s2">&quot;b_ch4_sd&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">stdev_b_ch4</span><span class="p">],</span> \
            <span class="s2">&quot;site&quot;</span> <span class="p">:</span> <span class="n">wetdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>\
            <span class="s1">&#39;date&#39;</span> <span class="p">:</span> <span class="n">wetdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]}</span>

    <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">means</span></div>

<span class="c1"># Plot the ratio against the H2O and fit</span>
<span class="c1"># syntax: fit = CRDS_H2OCorr.plot_ratio(wetdata, drydata)</span>
<div class="viewcode-block" id="plot_ratio"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.plot_ratio">[docs]</a><span class="k">def</span> <span class="nf">plot_ratio</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">drydata</span><span class="p">,</span> <span class="n">nocorrdata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">=</span> <span class="s1">&#39;/Users/as13988/Documents/Work/Picarro/H2OCorr/Plots/&#39;</span><span class="p">,</span> <span class="n">dir_suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">species</span> <span class="o">=</span><span class="s1">&#39;co2&#39;</span><span class="p">,</span> <span class="n">h2o_tag</span> <span class="o">=</span> <span class="s1">&#39;h2o&#39;</span><span class="p">,</span> <span class="n">No_plots</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sd_flag</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
 
    <span class="n">splitstr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">site</span> <span class="o">=</span> <span class="p">(</span><span class="n">splitstr</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">testdate</span> <span class="o">=</span> <span class="n">splitstr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">splitstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">co2flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># optional index based on co2 standard deviation</span>
    <span class="k">if</span> <span class="n">sd_flag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">co2flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">co2sd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sd_flag</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">wet_key</span> <span class="o">=</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;_wet&#39;</span>
    <span class="n">dry_key</span> <span class="o">=</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;_dry&#39;</span>
    <span class="n">sd_key</span> <span class="o">=</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;sd&#39;</span>
    
    
    <span class="n">dry_means</span> <span class="o">=</span> <span class="n">calc_dry</span><span class="p">(</span><span class="n">drydata</span><span class="p">)</span>
    <span class="n">wet_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wet_key</span><span class="p">))[</span><span class="n">index</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">nocorrdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">instcorr_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">nocorrdata</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dry_key</span><span class="p">))[</span><span class="n">index</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">instcorr_data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sd_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sd_key</span><span class="p">))[</span><span class="n">index</span><span class="p">])</span>
    <span class="n">h2o_sd</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">h2osd</span><span class="p">)[</span><span class="n">index</span><span class="p">])</span>    
     
    <span class="c1"># pull out the correct h2o column</span>
    <span class="c1"># NB: GCWerks use &quot;h2o&quot; and ICOS &quot;h2o_reported&quot;</span>
    <span class="n">h2o</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">h2o_tag</span><span class="p">))[</span><span class="n">index</span><span class="p">]</span>

    <span class="c1"># NOTE using the &quot;wet&quot; valve from the dry means as this is uncorrected using the in built correction</span>
    <span class="c1"># and as it&#39;s dry it shouldn&#39;t need correcting</span>
    <span class="n">ratio</span> <span class="o">=</span> <span class="n">wet_data</span><span class="o">/</span><span class="n">dry_means</span><span class="p">[</span><span class="n">wet_key</span><span class="p">]</span>     

    
    <span class="c1"># new fitting with x weights as well as y weights</span>
    <span class="c1"># copied example from https://stackoverflow.com/questions/26058792/correct-fitting-with-scipy-curve-fit-including-errors-in-x</span>
    <span class="n">dataforfit</span> <span class="o">=</span> <span class="n">RealData</span><span class="p">(</span><span class="n">h2o</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">sx</span><span class="o">=</span><span class="n">h2o_sd</span><span class="p">,</span> <span class="n">sy</span><span class="o">=</span><span class="n">sd_data</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">ODRfunc</span><span class="p">)</span>
    
    <span class="n">odr</span> <span class="o">=</span> <span class="n">ODR</span><span class="p">(</span><span class="n">dataforfit</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">odr</span><span class="o">.</span><span class="n">set_job</span><span class="p">(</span><span class="n">fit_type</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">odr</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    
    <span class="c1">#print output.pprint()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">beta</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">sd_beta</span><span class="p">)</span>
    <span class="c1"># Original fitting</span>
    <span class="c1">#params, corr = scipy.optimize.curve_fit(fitfunc, h2o, ratio, [1,1], sd_data)</span>


    <span class="n">fit</span> <span class="o">=</span> <span class="n">fitfunc</span><span class="p">(</span><span class="n">h2o</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    
    
    <span class="n">labels_1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;co2&#39;</span> <span class="p">:</span> <span class="s1">&#39;CO$_2$ wet/CO$_2$ dry&#39;</span><span class="p">,</span> <span class="s1">&#39;ch4&#39;</span> <span class="p">:</span><span class="s1">&#39;CH$_4$ wet/CH$_4$ dry&#39;</span><span class="p">}</span>
    <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;H$_2$O&#39;</span>
    
    <span class="k">if</span> <span class="n">h2o_tag</span> <span class="o">==</span> <span class="s1">&#39;h2o_reported&#39;</span><span class="p">:</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;H$_2$O reported&#39;</span>
    
    <span class="k">if</span> <span class="n">No_plots</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Plot the ratio</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mf">4.2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">)</span>
        
        <span class="c1"># Plot CO2 wet/ CO2 dry vs H2O</span>
        <span class="n">plt3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">h2o</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>
        <span class="c1">#plt3.errorbar(h2o, ratio, yerr = sd_data, fmt= &#39;o&#39;, color = &#39;blue&#39;)</span>
        <span class="n">plt3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">plt3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">labels_1</span><span class="p">[</span><span class="n">species</span><span class="p">])</span>
        <span class="n">y_formatter</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">ScalarFormatter</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">y_formatter</span><span class="p">)</span>
        
     
        
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">h2o</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
     
        <span class="n">fit_str</span> <span class="o">=</span> <span class="s1">&#39;y = &#39;</span> <span class="o">+</span> <span class="s1">&#39;1 + &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;x + &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;x^2&#39;</span>
        <span class="nb">print</span> <span class="n">fit_str</span>
        <span class="nb">print</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">fit_str</span> <span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
     
        <span class="n">outname</span> <span class="o">=</span> <span class="s1">&#39;Ratio_&#39;</span><span class="o">+</span><span class="n">tag</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">site</span><span class="o">+</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">testdate</span><span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
        <span class="k">if</span> <span class="n">h2o_tag</span> <span class="o">==</span> <span class="s1">&#39;h2o_reported&#39;</span><span class="p">:</span> 
           <span class="n">outname</span> <span class="o">=</span> <span class="s1">&#39;Ratio_&#39;</span><span class="o">+</span><span class="n">tag</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">site</span><span class="o">+</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">testdate</span><span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;_ICOS.png&#39;</span>

        <span class="nb">print</span> <span class="s1">&#39;Plot saved as: &#39;</span> <span class="o">+</span> <span class="n">outdir</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">site</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">dir_suffix</span><span class="o">+</span><span class="n">outname</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">site</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">dir_suffix</span><span class="o">+</span><span class="n">outname</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
            
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="c1"># PLot the fit of the new correction compared to the in build correction</span>
    <span class="n">outname</span> <span class="o">=</span> <span class="s1">&#39;Corr_&#39;</span><span class="o">+</span><span class="n">tag</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">site</span><span class="o">+</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">testdate</span><span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
    <span class="k">if</span> <span class="n">h2o_tag</span> <span class="o">==</span> <span class="s1">&#39;h2o_reported&#39;</span><span class="p">:</span> 
       <span class="n">outname</span> <span class="o">=</span> <span class="s1">&#39;Corr_&#39;</span><span class="o">+</span><span class="n">tag</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">site</span><span class="o">+</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">testdate</span><span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;_ICOS.png&#39;</span>

    <span class="n">h2o</span><span class="p">,</span> <span class="n">err_new_fit</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">h2o_sd</span> <span class="o">=</span> <span class="n">plot_fit</span><span class="p">(</span><span class="n">wet_data</span><span class="p">,</span> <span class="n">h2o</span><span class="p">,</span> <span class="n">dry_means</span><span class="p">[</span><span class="n">wet_key</span><span class="p">],</span> <span class="n">params</span><span class="p">,</span> <span class="n">sd_data</span><span class="p">,</span> <span class="n">h2o_sd</span><span class="p">,</span> <span class="n">instcorrdata</span> <span class="o">=</span> <span class="n">instcorr_data</span><span class="p">,</span> <span class="n">saveas</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">site</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">dir_suffix</span><span class="o">+</span> <span class="n">outname</span><span class="p">,</span> <span class="n">No_plots</span> <span class="o">=</span> <span class="n">No_plots</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
    
    <span class="c1">#return fit_params</span>
    <span class="k">return</span> <span class="n">params</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">corr</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">corr</span><span class="p">))],</span> <span class="n">h2o</span><span class="p">,</span> <span class="n">err_new_fit</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">h2o_sd</span></div>

<div class="viewcode-block" id="fitfunc"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.fitfunc">[docs]</a><span class="k">def</span> <span class="nf">fitfunc</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">b1</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">X</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">a</span><span class="o">*</span><span class="n">X</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">X</span><span class="o">*</span><span class="n">X</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">b1</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="ODRfunc"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.ODRfunc">[docs]</a><span class="k">def</span> <span class="nf">ODRfunc</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">X1</span><span class="p">):</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">X</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">a</span><span class="o">*</span><span class="n">X</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">X</span><span class="o">*</span><span class="n">X</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">b1</span><span class="p">)</span></div>
    
<span class="c1"># syntax: CRDS_H2OCorr.plot_fit(wetdata[0].co2_wet, data_nocorr[0].co2_dry, wetdata[0].h2o, np.mean(drydata[0].co2_wet), fit, wetdata[0].co2sd)</span>
<div class="viewcode-block" id="plot_fit"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.plot_fit">[docs]</a><span class="k">def</span> <span class="nf">plot_fit</span><span class="p">(</span><span class="n">rawwetdata</span><span class="p">,</span> <span class="n">h2o</span><span class="p">,</span> <span class="n">drymean</span><span class="p">,</span> <span class="n">fit_params</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">h2o_sd</span><span class="p">,</span> <span class="n">instcorrdata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">saveas</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">colour</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">No_plots</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="c1">#f = 1 + a*X + b*(X*X)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">fitfunc</span><span class="p">(</span><span class="n">h2o</span><span class="p">,</span> <span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fit_params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>    
    
    <span class="n">CO2_corr</span> <span class="o">=</span> <span class="n">rawwetdata</span><span class="o">/</span><span class="n">fit</span>
    <span class="c1"># err = 100 - (correct value/dry raw value * 100 )</span>
    <span class="n">err_new_fit</span> <span class="o">=</span> <span class="n">CO2_corr</span> <span class="o">-</span> <span class="n">drymean</span>
    <span class="k">if</span> <span class="n">instcorrdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>    
        <span class="n">err_inst_fit</span> <span class="o">=</span> <span class="n">instcorrdata</span><span class="o">-</span> <span class="n">drymean</span>
    
    <span class="k">if</span> <span class="n">No_plots</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Plot the corrected output</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mf">4.2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">)</span>
    
        <span class="c1"># Plot CO2 wet/ CO2 dry vs H2O</span>
        <span class="n">plt3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">instcorrdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">plt3</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">h2o</span><span class="p">,</span> <span class="n">err_inst_fit</span><span class="p">,</span> <span class="n">yerr</span> <span class="o">=</span> <span class="n">sd</span><span class="p">,</span> <span class="n">xerr</span> <span class="o">=</span> <span class="n">h2o_sd</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>

        <span class="n">plt3</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">h2o</span><span class="p">,</span> <span class="n">err_new_fit</span><span class="p">,</span> <span class="n">yerr</span> <span class="o">=</span> <span class="n">sd</span><span class="p">,</span> <span class="n">xerr</span> <span class="o">=</span> <span class="n">h2o_sd</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colour</span><span class="p">)</span>
     
        <span class="n">plt3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;H$_2$O raw&#39;</span><span class="p">)</span>
        <span class="n">plt3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;corrected - dry mean&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;Dry conc = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">drymean</span><span class="p">),</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="s1">&#39;Instrument specific correction&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colour</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="s1">&#39;In built correction&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
        
        <span class="n">y_formatter</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">ScalarFormatter</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">y_formatter</span><span class="p">)</span>
        <span class="n">plt3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>     
        <span class="c1"># Set y ranges</span>
        <span class="k">if</span> <span class="s1">&#39;co2&#39;</span> <span class="ow">in</span> <span class="n">saveas</span><span class="p">:</span>
            <span class="n">plt3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>             
             
        <span class="k">if</span> <span class="s1">&#39;ch4&#39;</span> <span class="ow">in</span> <span class="n">saveas</span><span class="p">:</span>
            <span class="n">plt3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>             
             
        <span class="k">if</span> <span class="n">saveas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Plot saved as: &#39;</span> <span class="o">+</span> <span class="n">saveas</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">saveas</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
            
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
    
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        # quick plot of the relationship between sd and residual</span>
<span class="sd">        if isinstance(time, list) :</span>
<span class="sd">            since = [(i -time[0]).total_seconds()/60 for i in time]</span>
<span class="sd">            plt.scatter(since, h2o, c=err_new_fit, lw =0.1)</span>
<span class="sd">            plt.ylabel(&#39;h2o&#39;)</span>
<span class="sd">            plt.xlabel(&#39;Minutes since start of run&#39;)</span>
<span class="sd">            plt.xlim()</span>
<span class="sd">            plt.savefig(&#39;/Users/as13988/Documents/Work/Picarro/H2OCorr/temp/&#39;+ saveas.split(&#39;/&#39;)[-1])</span>
<span class="sd">            plt.show()</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">h2o</span><span class="p">,</span> <span class="n">err_new_fit</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">h2o_sd</span></div>

<span class="kn">import</span> <span class="nn">colorsys</span>
<span class="c1"># Make a list of N distinct colours</span>
<div class="viewcode-block" id="get_colours"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.get_colours">[docs]</a><span class="k">def</span> <span class="nf">get_colours</span><span class="p">(</span><span class="n">num_colours</span><span class="p">):</span>
    <span class="n">colours</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">360.</span><span class="p">,</span> <span class="mf">360.</span> <span class="o">/</span> <span class="n">num_colours</span><span class="p">):</span>
        <span class="n">hue</span> <span class="o">=</span> <span class="n">i</span><span class="o">/</span><span class="mf">360.</span>
        <span class="n">lightness</span> <span class="o">=</span> <span class="p">(</span><span class="mi">50</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="mf">100.</span>
        <span class="n">saturation</span> <span class="o">=</span> <span class="p">(</span><span class="mi">90</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="mf">100.</span>
        <span class="n">colours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colorsys</span><span class="o">.</span><span class="n">hls_to_rgb</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">lightness</span><span class="p">,</span> <span class="n">saturation</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">colours</span></div>


<span class="c1"># Uses the output of plot_ratio_multi</span>
<div class="viewcode-block" id="plot_residual_multi"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.plot_residual_multi">[docs]</a><span class="k">def</span> <span class="nf">plot_residual_multi</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">=</span> <span class="s1">&#39;/Users/as13988/Documents/Work/Picarro/H2OCorr/Plots/&#39;</span><span class="p">,</span> <span class="n">saveas</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span><span class="p">):</span>
        
    <span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">plt1</span><span class="p">,</span> <span class="n">plt2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Generate colours</span>
    <span class="n">colours</span> <span class="o">=</span> <span class="n">get_colours</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;CO2&#39;</span><span class="p">][</span><span class="s1">&#39;h2o&#39;</span><span class="p">]))</span>

    <span class="n">CO2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;CO2&#39;</span><span class="p">]</span>
    <span class="n">CH4</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;CH4&#39;</span><span class="p">]</span>    
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;CO2&#39;</span><span class="p">][</span><span class="s1">&#39;h2o&#39;</span><span class="p">])):</span>
        <span class="n">plt1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">CO2</span><span class="p">[</span><span class="s1">&#39;h2o&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">CO2</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">CO2</span><span class="p">[</span><span class="s1">&#39;sd&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">fmt</span><span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colours</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">plt2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">CH4</span><span class="p">[</span><span class="s1">&#39;h2o&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">CH4</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">CH4</span><span class="p">[</span><span class="s1">&#39;sd&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colours</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">plt2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;H$_2$O raw&#39;</span><span class="p">)</span>
    <span class="n">plt1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;CO2&#39;</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;CH4&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.82</span><span class="p">,</span> <span class="s1">&#39;Residual = |corrected - dry mean|&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    


    <span class="n">y_formatter</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">ScalarFormatter</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plt1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">y_formatter</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">y_formatter</span><span class="p">)</span>
         
    <span class="k">if</span> <span class="n">saveas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
       <span class="nb">print</span> <span class="s1">&#39;Plot saved as: &#39;</span> <span class="o">+</span> <span class="n">outdir</span> <span class="o">+</span> <span class="n">saveas</span>
       <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span><span class="n">saveas</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    </div>
    

<span class="c1"># Uses the &quot;means&quot; outputs of plot_ratio_multi and the wet and dry data as read in using read_data_multi</span>
<span class="c1"># The co2_dry output of GCWerks  the co2_dry parameters from the CRDS if there&#39;s a water corrections file</span>
<span class="c1"># need to extract the data after removing the water corrections file to get the inbuilt correction</span>
<span class="c1"># and read it in as a second &quot;wet_data&quot; file</span>
<div class="viewcode-block" id="plot_residual"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.plot_residual">[docs]</a><span class="k">def</span> <span class="nf">plot_residual</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">wet_data</span><span class="p">,</span> <span class="n">wet_data_nocorr</span><span class="p">,</span> <span class="n">dry_data</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">=</span> <span class="s1">&#39;/Users/as13988/Documents/Work/Picarro/H2OCorr/Plots/&#39;</span><span class="p">,</span> <span class="n">dir_suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">saveas</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">useinbuilt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">H2O_Range</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sd_flag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="c1"># extract the wet data and concatenate it into one large data blob</span>
    <span class="n">co2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">co2_inbuilt</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">co2_sd</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ch4</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ch4_inbuilt</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ch4_sd</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">h2o</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">h2o_sd</span> <span class="o">=</span><span class="p">[]</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wet_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wet_data</span><span class="p">):</span>
            <span class="n">co2</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">co2_wet</span><span class="p">)</span>
            <span class="n">ch4</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">ch4_wet</span><span class="p">)</span>
            <span class="n">co2_inbuilt</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">wet_data_nocorr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">co2_dry</span><span class="p">)</span>
            <span class="n">ch4_inbuilt</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">wet_data_nocorr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ch4_dry</span><span class="p">)</span>
            
            <span class="n">ch4_sd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">ch4sd</span><span class="p">)</span>    
            <span class="n">co2_sd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">co2sd</span><span class="p">)</span>
            <span class="n">h2o_sd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">h2osd</span><span class="p">)</span>
            
            <span class="n">flags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">co2flags</span><span class="p">)</span>
        
            <span class="n">h2o</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">h2o</span><span class="p">)</span>
    
    
    <span class="c1"># extract the dry data and calculate the mean</span>
    <span class="n">co2_dry</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ch4_dry</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dry_flags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dry_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dry_data</span><span class="p">):</span>
            <span class="n">co2_dry</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">co2_wet</span><span class="p">)</span>
            <span class="n">ch4_dry</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">ch4_wet</span><span class="p">)</span>
            <span class="n">dry_flags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">co2flags</span><span class="p">)</span>

    <span class="c1"># exclude flagged data</span>
    <span class="n">dry_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dry_flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">co2_dry_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">co2_dry</span><span class="p">)[</span><span class="n">dry_index</span><span class="p">])</span>
    <span class="n">ch4_dry_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ch4_dry</span><span class="p">)[</span><span class="n">dry_index</span><span class="p">])</span>

    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span> <span class="s1">&#39;No. good flagged data points: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    
    <span class="c1"># optional SD flag</span>
    <span class="k">if</span> <span class="n">sd_flag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">co2_sd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sd_flag</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="nb">print</span> <span class="s1">&#39;No. data points used: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
            
    <span class="n">co2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">co2</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">ch4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ch4</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">h2o</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">h2o</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">co2_inbuilt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">co2_inbuilt</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">ch4_inbuilt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ch4_inbuilt</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">co2_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">co2_sd</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">ch4_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ch4_sd</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">h2o_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">h2o_sd</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span>

    <span class="c1"># calculate the corrected data and the residual</span>
    <span class="n">co2_res</span> <span class="o">=</span> <span class="n">co2</span><span class="o">/</span><span class="p">(</span><span class="n">fitfunc</span><span class="p">(</span><span class="n">h2o</span><span class="p">,</span> <span class="n">means</span><span class="p">[</span><span class="s1">&#39;a_co2&#39;</span><span class="p">],</span> <span class="n">means</span><span class="p">[</span><span class="s1">&#39;b_co2&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="n">co2_dry_mean</span>
    <span class="n">ch4_res</span> <span class="o">=</span> <span class="n">ch4</span><span class="o">/</span><span class="p">(</span><span class="n">fitfunc</span><span class="p">(</span><span class="n">h2o</span><span class="p">,</span> <span class="n">means</span><span class="p">[</span><span class="s1">&#39;a_ch4&#39;</span><span class="p">],</span> <span class="n">means</span><span class="p">[</span><span class="s1">&#39;b_ch4&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="n">ch4_dry_mean</span>

    <span class="n">co2_res_inbuilt</span> <span class="o">=</span> <span class="n">co2_inbuilt</span> <span class="o">-</span> <span class="n">co2_dry_mean</span>
    <span class="n">ch4_res_inbuilt</span> <span class="o">=</span> <span class="n">ch4_inbuilt</span> <span class="o">-</span> <span class="n">ch4_dry_mean</span>
        
    <span class="c1"># plot it</span>
    <span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">plt1</span><span class="p">,</span> <span class="n">plt2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">f</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>    

    <span class="k">if</span> <span class="n">useinbuilt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">h2o</span><span class="p">,</span> <span class="n">co2_res_inbuilt</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">co2_sd</span><span class="p">,</span> <span class="n">xerr</span> <span class="o">=</span> <span class="n">h2o_sd</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mec</span> <span class="o">=</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">mfc</span> <span class="o">=</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">ecolor</span> <span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">plt2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">h2o</span><span class="p">,</span> <span class="n">ch4_res_inbuilt</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ch4_sd</span><span class="p">,</span> <span class="n">xerr</span> <span class="o">=</span> <span class="n">h2o_sd</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mec</span> <span class="o">=</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">mfc</span> <span class="o">=</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">ecolor</span> <span class="o">=</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>        
    
    <span class="n">plt1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">h2o</span><span class="p">,</span> <span class="n">co2_res</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">co2_sd</span><span class="p">,</span> <span class="n">xerr</span> <span class="o">=</span> <span class="n">h2o_sd</span><span class="p">,</span>  <span class="n">fmt</span><span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mec</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">mfc</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">ecolor</span> <span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">h2o</span><span class="p">,</span> <span class="n">ch4_res</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ch4_sd</span><span class="p">,</span> <span class="n">xerr</span> <span class="o">=</span> <span class="n">h2o_sd</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">mec</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">mfc</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">ecolor</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">plt1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>

    <span class="n">plt1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        
    <span class="n">plt1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="o">-</span><span class="mf">0.1</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>               

  
    <span class="c1"># option to print means for a given range</span>
    <span class="k">if</span> <span class="n">H2O_Range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
       <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">h2o</span> <span class="o">&lt;</span> <span class="n">H2O_Range</span><span class="p">)</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
       <span class="n">index_rest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">h2o</span> <span class="o">&gt;=</span> <span class="n">H2O_Range</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
       
       <span class="nb">print</span> <span class="s1">&#39;Residual mean H2O &lt; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">H2O_Range</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span>
       <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">index</span><span class="p">,</span> <span class="n">index_rest</span><span class="p">]):</span>
           <span class="n">co2_LT_mean_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">co2_res</span><span class="p">[</span><span class="n">item</span><span class="p">]))</span>
           <span class="n">co2_LT_sd_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">co2_res</span><span class="p">[</span><span class="n">item</span><span class="p">]))</span>
           <span class="n">co2_LT_mean_O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">co2_res_inbuilt</span><span class="p">[</span><span class="n">item</span><span class="p">]))</span>
           <span class="n">co2_LT_sd_O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">co2_res_inbuilt</span><span class="p">[</span><span class="n">item</span><span class="p">]))</span>
           
           <span class="n">ch4_LT_mean_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ch4_res</span><span class="p">[</span><span class="n">item</span><span class="p">]))</span>
           <span class="n">ch4_LT_sd_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ch4_res</span><span class="p">[</span><span class="n">item</span><span class="p">]))</span>      
           <span class="n">ch4_LT_mean_O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ch4_res_inbuilt</span><span class="p">[</span><span class="n">item</span><span class="p">]))</span>
           <span class="n">ch4_LT_sd_O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ch4_res_inbuilt</span><span class="p">[</span><span class="n">item</span><span class="p">]))</span>   
        
           <span class="nb">print</span> <span class="s1">&#39;CO2 new mean  1SD = &#39;</span> <span class="o">+</span>  <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">co2_LT_mean_N</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">co2_LT_sd_N</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;mumol/mol&#39;</span>
           <span class="nb">print</span> <span class="s1">&#39;CO2 inbuilt mean  1SD = &#39;</span> <span class="o">+</span>  <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">co2_LT_mean_O</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">co2_LT_sd_O</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;mumol/mol&#39;</span>
           <span class="nb">print</span> <span class="s1">&#39;CH4 new mean  1SD = &#39;</span> <span class="o">+</span>  <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ch4_LT_mean_N</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ch4_LT_sd_N</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;nmol/mol&#39;</span>
           <span class="nb">print</span> <span class="s1">&#39;CH4 inbuilt mean  1SD = &#39;</span> <span class="o">+</span>  <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ch4_LT_mean_O</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ch4_LT_sd_N</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;nmol/mol&#39;</span>
           <span class="nb">print</span> <span class="s1">&#39; &#39;</span>
           <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
               <span class="nb">print</span> <span class="s1">&#39;Residual mean H2O &gt;= &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">H2O_Range</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span>
       
    <span class="n">labelx</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>

    <span class="n">plt1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">])</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
    <span class="n">plt1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span> 

    <span class="n">plt2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;H$_2$O raw&#39;</span><span class="p">)</span>
    <span class="n">plt1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[CO$_2$] residual&quot;&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="sa">r</span><span class="s2">&quot;($\mu$mol/mol)&quot;</span><span class="p">)</span>
    <span class="n">plt1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="n">labelx</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    
    <span class="n">plt2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;[CH$_4$] residual</span><span class="se">\n</span><span class="s1">(nmol/mol)&#39;</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="n">labelx</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;Residual = corrected - dry mean&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.58</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\bar</span><span class="si">{x}</span><span class="s1">$$\pm 1 \sigma = &#39;</span> <span class="o">+</span>  <span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">co2_res</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;\pm&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">co2_res</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;\,  \mu mol/mol$&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\bar</span><span class="si">{x}</span><span class="s1">$$\pm 1 \sigma = &#39;</span> <span class="o">+</span>  <span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ch4_res</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;\pm&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ch4_res</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;\, nmol/mol$&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">useinbuilt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.61</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\bar</span><span class="si">{x}</span><span class="s1">$$\pm 1 \sigma = &#39;</span> <span class="o">+</span>  <span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">co2_res_inbuilt</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;\pm&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">co2_res_inbuilt</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;\,  \mu mol/mol$&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;grey&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.23</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\bar</span><span class="si">{x}</span><span class="s1">$$\pm 1 \sigma = &#39;</span> <span class="o">+</span>  <span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ch4_res_inbuilt</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;\pm&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ch4_res_inbuilt</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;\, nmol/mol$&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;grey&#39;</span><span class="p">)</span>
    

    <span class="n">y_formatter</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">ScalarFormatter</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plt1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">y_formatter</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">y_formatter</span><span class="p">)</span>
         
    <span class="k">if</span> <span class="n">saveas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outname</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span><span class="n">means</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span> <span class="n">dir_suffix</span><span class="o">+</span> <span class="n">means</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">means</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_RunResiduals.png&#39;</span>
        <span class="k">if</span> <span class="n">useinbuilt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outname</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span><span class="n">means</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span> <span class="n">dir_suffix</span><span class="o">+</span> <span class="n">means</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">means</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_RunResiduals_InBuiltCorr.png&#39;</span>
            
        <span class="nb">print</span> <span class="s1">&#39;Plot saved as: &#39;</span> <span class="o">+</span> <span class="n">outdir</span> <span class="o">+</span>  <span class="n">outname</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span>  <span class="n">outname</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    # Quick plot of the relationship between the residuals and the sd of h2o, co2 and ch4.</span>
<span class="sd">    plt.scatter(co2_sd, h2o_sd, c=co2_res, lw=0)</span>
<span class="sd">    plt.xlabel(&#39;CO2 sd&#39;)</span>
<span class="sd">    plt.ylabel(&#39;H2O sd&#39;)</span>
<span class="sd">    plt.ylim([0, 0.2]) </span>
<span class="sd">    #plt.xlim([0, 0.06])             </span>
<span class="sd">    plt.savefig(&#39;/Users/as13988/Documents/Work/Picarro/H2OCorr/temp/CO2&#39;+outname.split(&#39;/&#39;)[-1])</span>
<span class="sd">    plt.show()</span>

<span class="sd">    plt.scatter(ch4_sd, h2o_sd, c=ch4_res, lw=0)</span>
<span class="sd">    plt.xlabel(&#39;CH4 sd&#39;)</span>
<span class="sd">    plt.ylabel(&#39;H2O sd&#39;)</span>
<span class="sd">    plt.ylim([0, 0.2]) </span>
<span class="sd">    #plt.xlim([0, 1]) </span>
<span class="sd">    plt.savefig(&#39;/Users/as13988/Documents/Work/Picarro/H2OCorr/temp/CH4&#39;+outname.split(&#39;/&#39;)[-1])</span>
<span class="sd">    plt.show()</span>
<span class="sd">    &quot;&quot;&quot;</span></div>
    
<span class="c1"># data =  the set of wet data that you want the different fits to be applied to</span>
<span class="c1"># drydata = list of means. You need to have the same number of means as you have sets of fit_parameters. </span>
<span class="c1"># These can be the same mean or can vary with the fit parameters</span>
<span class="c1"># fit_params = a list of outputs from plot_ratio one per fit that you want to compare</span>
<div class="viewcode-block" id="compare_fits"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.compare_fits">[docs]</a><span class="k">def</span> <span class="nf">compare_fits</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">drydata</span><span class="p">,</span> <span class="n">fit_params</span><span class="p">,</span>  <span class="n">outdir</span> <span class="o">=</span> <span class="s1">&#39;/Users/as13988/Documents/Work/Picarro/H2OCorr/Plots/&#39;</span><span class="p">,</span> <span class="n">species</span> <span class="o">=</span><span class="s1">&#39;co2&#39;</span><span class="p">):</span>    
    
    <span class="n">splitstr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">site</span> <span class="o">=</span> <span class="p">(</span><span class="n">splitstr</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">testdate</span> <span class="o">=</span> <span class="n">splitstr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">splitstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Create key names for extraction</span>
    <span class="n">wet_key</span> <span class="o">=</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;_wet&#39;</span>
    <span class="n">dry_key</span> <span class="o">=</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;_dry&#39;</span>
    <span class="n">sd_key</span> <span class="o">=</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;sd&#39;</span>
    
    <span class="c1"># Make index for unflagged data</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">co2flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Extract the unflagged data </span>
    <span class="n">wet_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wet_key</span><span class="p">))[</span><span class="n">index</span><span class="p">])</span>
    <span class="n">dry_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dry_key</span><span class="p">))[</span><span class="n">index</span><span class="p">])</span>
    <span class="n">sd_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sd_key</span><span class="p">))[</span><span class="n">index</span><span class="p">])</span>
    <span class="n">h2o</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">h2o</span><span class="p">)[</span><span class="n">index</span><span class="p">])</span>
    
    <span class="n">colours</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;pink&#39;</span><span class="p">,</span> <span class="s1">&#39;magenta&#39;</span><span class="p">]</span>

    <span class="c1"># PLot the fit  of the new correction compared to the in build correction</span>

    <span class="c1"># calculate parameters</span>
    <span class="n">err_inst_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dry_data</span><span class="o">-</span><span class="n">drydata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    
    <span class="c1"># Plot the corrected output</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mf">4.2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">)</span>
    
    <span class="c1"># Plot CO2 wet/ CO2 dry vs H2O</span>
    <span class="n">plt3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">plt3</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">h2o</span><span class="p">,</span> <span class="n">err_inst_fit</span><span class="p">,</span> <span class="n">yerr</span> <span class="o">=</span> <span class="n">sd_data</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>

    <span class="n">nofits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fit_params</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fit_params</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">nofits</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nofits</span><span class="p">):</span>
        <span class="n">fit_params_i</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fit_params</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">fit_params_i</span> <span class="o">=</span> <span class="n">fit_params</span>
            
        <span class="n">fit</span> <span class="o">=</span> <span class="n">fitfunc</span><span class="p">(</span><span class="n">h2o</span><span class="p">,</span> <span class="n">fit_params_i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fit_params_i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>       
        
        <span class="n">CO2_corr</span> <span class="o">=</span> <span class="n">wet_data</span><span class="o">/</span><span class="n">fit</span>
        
        <span class="c1"># err = 100 - (correct value/dry raw value * 100 )</span>
        <span class="n">err_new_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">CO2_corr</span><span class="o">-</span><span class="n">drydata</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        
        <span class="n">plt3</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">h2o</span><span class="p">,</span> <span class="n">err_new_fit</span><span class="p">,</span> <span class="n">yerr</span> <span class="o">=</span> <span class="n">sd_data</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colours</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.2</span> <span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mf">0.04</span><span class="p">,</span> <span class="s1">&#39;New correction &#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colours</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>


    <span class="n">plt3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;H$_2$O raw&#39;</span><span class="p">)</span>
    <span class="n">plt3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;|corrected - dry mean|&#39;</span><span class="p">)</span>
    <span class="n">y_formatter</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">ScalarFormatter</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plt3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">y_formatter</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="s1">&#39;Built in correction&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
    
    <span class="nb">print</span> <span class="s1">&#39;Plot saved as: &#39;</span> <span class="o">+</span> <span class="n">outdir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">site</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span> <span class="s1">&#39;FitComparison_&#39;</span> <span class="o">+</span> <span class="n">tag</span><span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">site</span> <span class="o">+</span> <span class="n">testdate</span> <span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">site</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;FitComparison_&#39;</span> <span class="o">+</span> <span class="n">tag</span><span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">site</span> <span class="o">+</span> <span class="n">testdate</span> <span class="o">+</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="c1"># plots each run on the same plot along with the fit</span>
<div class="viewcode-block" id="compare_runs"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.compare_runs">[docs]</a><span class="k">def</span> <span class="nf">compare_runs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">drydata</span><span class="p">,</span>  <span class="n">outdir</span> <span class="o">=</span> <span class="s1">&#39;/Users/as13988/Documents/Work/Picarro/H2OCorr/Plots/&#39;</span><span class="p">,</span> <span class="n">species</span> <span class="o">=</span><span class="s1">&#39;co2&#39;</span><span class="p">):</span>
    
    <span class="n">splitstr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">site</span> <span class="o">=</span> <span class="p">(</span><span class="n">splitstr</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">testdate</span> <span class="o">=</span> <span class="n">splitstr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">splitstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
   
    <span class="c1"># Create key names for extraction</span>
    <span class="n">wet_key</span> <span class="o">=</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;_wet&#39;</span>
    <span class="n">sd_key</span> <span class="o">=</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;sd&#39;</span>
    
    <span class="n">colours</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">]</span>    
    
    <span class="n">labels_1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;co2&#39;</span> <span class="p">:</span> <span class="s1">&#39;CO$_2$ wet/CO$_2$ dry&#39;</span><span class="p">,</span> <span class="s1">&#39;ch4&#39;</span> <span class="p">:</span><span class="s1">&#39;CH$_4$ wet/CH$_4$ dry&#39;</span><span class="p">}</span>    
    
    <span class="c1"># want to do an overall fit so I need to collate the data    </span>
    <span class="n">h2o_all</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ratio_all</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sigma_all</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="c1"># Make index for unflagged data</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">co2flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Extract the unflagged data </span>
        <span class="n">wet_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wet_key</span><span class="p">))[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">sd_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sd_key</span><span class="p">))[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">h2o</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">h2o</span><span class="p">)[</span><span class="n">index</span><span class="p">])</span>
   
        <span class="c1"># calculate the ratio for that run     </span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">wet_data</span><span class="o">/</span><span class="n">drydata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
        <span class="c1"># Append all data together to do an overall fit</span>
        <span class="n">h2o_all</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">h2o</span><span class="p">)</span>    
        <span class="n">ratio_all</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
        <span class="n">sigma_all</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sd_data</span><span class="p">)</span>
        
        <span class="c1"># Calculate the fit</span>
        <span class="n">fit_params</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">responsefn</span><span class="p">,</span> <span class="n">h2o</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">sd_data</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Plot the ratio</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mf">4.2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">)</span>
            
            <span class="c1"># Plot CO2 wet/ CO2 dry vs H2O</span>
            <span class="n">plt3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            
        <span class="n">plt3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">h2o</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">markerfacecolor</span> <span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span> <span class="o">=</span> <span class="n">colours</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
       
        <span class="n">fit_str</span> <span class="o">=</span> <span class="s1">&#39;y = &#39;</span> <span class="o">+</span> <span class="s1">&#39;1 + &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;x + &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;x^2&#39;</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.18</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">fit_str</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colours</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

    <span class="c1"># calculate a fit to all the data</span>
    <span class="n">fit_params</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">responsefn</span><span class="p">,</span> <span class="n">h2o_all</span><span class="p">,</span> <span class="n">ratio_all</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma_all</span> <span class="p">)</span>
    
    <span class="n">fit_str</span> <span class="o">=</span> <span class="s1">&#39;y = &#39;</span> <span class="o">+</span> <span class="s1">&#39;1 + &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;x + &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;x^2 Fit to all data&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="n">fit_str</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

   
    <span class="n">plt3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;H$_2$O raw&#39;</span><span class="p">)</span>
    <span class="n">plt3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">labels_1</span><span class="p">[</span><span class="n">species</span><span class="p">])</span>
    <span class="n">y_formatter</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">ScalarFormatter</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plt3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">y_formatter</span><span class="p">)</span>
 
    <span class="nb">print</span> <span class="s1">&#39;Plot saved as: &#39;</span> <span class="o">+</span> <span class="n">outdir</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">site</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="s1">&#39;RatioComparison&#39;</span><span class="o">+</span><span class="n">site</span><span class="o">+</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">testdate</span><span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="o">+</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">site</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="s1">&#39;RatioComparison&#39;</span><span class="o">+</span><span class="n">site</span><span class="o">+</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">testdate</span><span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="o">+</span> <span class="n">species</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="calc_dry"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.calc_dry">[docs]</a><span class="k">def</span> <span class="nf">calc_dry</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ignoreindex</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">co2flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>    
    
    <span class="k">if</span> <span class="n">ignoreindex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">co2wet_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">co2_wet</span><span class="p">)[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">co2dry_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">co2_dry</span><span class="p">)[</span><span class="n">index</span><span class="p">])</span>
    
        <span class="n">ch4wet_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">ch4_wet</span><span class="p">)[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">ch4dry_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">ch4_dry</span><span class="p">)[</span><span class="n">index</span><span class="p">])</span>
    
        <span class="n">h2o_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">h2o</span><span class="p">)[</span><span class="n">index</span><span class="p">])</span>

        <span class="n">co2wet_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">co2_wet</span><span class="p">)[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">co2dry_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">co2_dry</span><span class="p">)[</span><span class="n">index</span><span class="p">])</span>
    
        <span class="n">ch4wet_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">ch4_wet</span><span class="p">)[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">ch4dry_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">ch4_dry</span><span class="p">)[</span><span class="n">index</span><span class="p">])</span>
    
        <span class="n">h2o_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">h2o</span><span class="p">)[</span><span class="n">index</span><span class="p">])</span>

    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">co2wet_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">co2_wet</span><span class="p">)</span>
        <span class="n">co2dry_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">co2_dry</span><span class="p">)</span>
    
        <span class="n">ch4wet_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ch4_wet</span><span class="p">)</span>
        <span class="n">ch4dry_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ch4_dry</span><span class="p">)</span>
    
        <span class="n">h2o_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">h2o</span><span class="p">)</span>

        <span class="n">co2wet_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">co2_wet</span><span class="p">)</span>
        <span class="n">co2dry_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">co2_dry</span><span class="p">)</span>
    
        <span class="n">ch4wet_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ch4_wet</span><span class="p">)</span>
        <span class="n">ch4dry_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ch4_dry</span><span class="p">)</span>
    
        <span class="n">h2o_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">h2o</span><span class="p">)</span>

    <span class="n">means</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;co2_wet&#39;</span> <span class="p">:</span> <span class="n">co2wet_mean</span><span class="p">,</span> \
            <span class="s1">&#39;co2_dry&#39;</span> <span class="p">:</span> <span class="n">co2dry_mean</span><span class="p">,</span> \
            <span class="s1">&#39;ch4_wet&#39;</span> <span class="p">:</span> <span class="n">ch4wet_mean</span><span class="p">,</span> \
            <span class="s1">&#39;ch4_dry&#39;</span><span class="p">:</span> <span class="n">ch4dry_mean</span><span class="p">,</span> \
            <span class="s1">&#39;h2o&#39;</span> <span class="p">:</span> <span class="n">h2o_mean</span><span class="p">,</span> \
            <span class="s1">&#39;co2_wet_sd&#39;</span> <span class="p">:</span> <span class="n">co2wet_sd</span><span class="p">,</span> \
            <span class="s1">&#39;co2_dry_sd&#39;</span> <span class="p">:</span> <span class="n">co2dry_sd</span><span class="p">,</span> \
            <span class="s1">&#39;ch4_wet_sd&#39;</span> <span class="p">:</span> <span class="n">ch4wet_sd</span><span class="p">,</span> \
            <span class="s1">&#39;ch4_dry_sd&#39;</span><span class="p">:</span> <span class="n">ch4dry_sd</span><span class="p">,</span> \
            <span class="s1">&#39;h2o_sd&#39;</span> <span class="p">:</span> <span class="n">h2o_sd</span><span class="p">}</span>
    
    <span class="k">return</span> <span class="n">means</span></div>


<span class="c1"># Plot the raw data against the H2O</span>
<div class="viewcode-block" id="plot_drymeans"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.plot_drymeans">[docs]</a><span class="k">def</span> <span class="nf">plot_drymeans</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">outdir</span> <span class="o">=</span> <span class="s1">&#39;/Users/as13988/Documents/Work/Picarro/H2OCorr/Plots/&#39;</span><span class="p">):</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>      
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">means</span><span class="p">)):</span>
     
        <span class="n">data</span> <span class="o">=</span> <span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>        
        
        <span class="c1"># Plot CO2 wet</span>
        <span class="n">plt1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">plt1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;co2_wet&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;co2_wet_sd&#39;</span><span class="p">],</span>  <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">y_formatter</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">ScalarFormatter</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">y_formatter</span><span class="p">)</span>
        
        <span class="c1"># Plot CH4 wet</span>
        <span class="n">plt2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">plt2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ch4_wet&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ch4_wet_sd&#39;</span><span class="p">],</span>  <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="n">plt2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">y_formatter</span><span class="p">)</span>

        <span class="c1"># Plot H2O</span>
        <span class="n">plt3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">plt3</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;h2o&#39;</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;h2o_sd&#39;</span><span class="p">],</span>  <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>
        <span class="n">plt3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">y_formatter</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span> 
    
    <span class="n">plt1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;CO$_2$&#39;</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;CH$_4$&#39;</span><span class="p">)</span>
    <span class="n">plt3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;H$_2$O&#39;</span><span class="p">)</span>
 
    <span class="nb">print</span> <span class="s1">&#39;Plot saved as: &#39;</span> <span class="o">+</span> <span class="n">outdir</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">site</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="s1">&#39;drymeans.png&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outdir</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">site</span><span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="s1">&#39;drymeans.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">return</span> </div>


<div class="viewcode-block" id="responsefn"><a class="viewcode-back" href="../../api/acrg_GCWerks.html#acrg_GCWerks.CRDS_H2OCorr.responsefn">[docs]</a><span class="k">def</span> <span class="nf">responsefn</span><span class="p">(</span><span class="n">H2O</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
    
    <span class="n">ratio</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">A</span><span class="o">*</span><span class="n">H2O</span> <span class="o">+</span> <span class="n">B</span><span class="o">*</span><span class="n">H2O</span><span class="o">*</span><span class="n">H2O</span>
    
    <span class="k">return</span> <span class="n">ratio</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, mrghg.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>