<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>acrg_name.process &#8212; acrg  documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for acrg_name.process</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Thu May  7 10:34:25 2015</span>

<span class="sd">To use this script, you will need to have a directory, labeled as:</span>
<span class="sd">DOMAIN_SITE_HEIGHT (e.g. EUROPE_MHD_10magl), with the following structure:</span>

<span class="sd">Met/</span>
<span class="sd">Fields_files/</span>
<span class="sd">Particle_files/</span>
<span class="sd">Processed_Fields_files/</span>
<span class="sd">Observations/ (satellite/column footprints only)</span>

<span class="sd">Each file in Fields_files/ and Particle_files/ must end with a date string</span>
<span class="sd">(format YYYYMMDD) which must be present in both folders </span>
<span class="sd">e.g. fields_file_YYYYMMDD.txt.gz.</span>

<span class="sd">To process all files in a folder run:</span>

<span class="sd">process_all(&quot;DOMAIN&quot;, &quot;SITE&quot;)</span>

<span class="sd">Output netCDF files are created one file per month, per domain, per site</span>
<span class="sd">in the Processed_Fields_files directory.</span>

<span class="sd">@author: chxmr</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">netCDF4</span> <span class="k">import</span> <span class="n">Dataset</span>
<span class="kn">import</span> <span class="nn">netCDF4</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.constants</span> <span class="k">as</span> <span class="nn">const</span>
<span class="kn">from</span> <span class="nn">acrg_grid</span> <span class="k">import</span> <span class="n">areagrid</span>
<span class="kn">from</span> <span class="nn">acrg_time.convert</span> <span class="k">import</span> <span class="n">time2sec</span><span class="p">,</span> <span class="n">sec2time</span>
<span class="kn">import</span> <span class="nn">acrg_time.convert</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">split</span><span class="p">,</span> <span class="n">realpath</span><span class="p">,</span> <span class="n">exists</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xray</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">dirsync</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">scipy</span>


<span class="c1">#Default NAME output file version</span>
<span class="c1">#This is changed depending on presence of &quot;Fields:&quot; line in files</span>
<span class="n">namever</span><span class="o">=</span><span class="mi">3</span>

<span class="c1">#Time formats</span>
<span class="n">UTC_format</span> <span class="o">=</span> <span class="s1">&#39;%H%M%Z </span><span class="si">%d</span><span class="s1">/%m/%Y&#39;</span>
<span class="n">NAMEIII_short_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y  %H:%M %Z&#39;</span>

<span class="c1"># Define default met parameters. The keys are the column headings</span>
<span class="c1">#  in the Pandas dataframe that is created by read_met,</span>
<span class="c1">#  the values are the search strings that are used in read_met</span>
<span class="c1">#  to read the column headings</span>
<span class="n">met_default</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;             T&quot;</span><span class="p">,</span>
               <span class="s2">&quot;press&quot;</span><span class="p">:</span> <span class="s2">&quot;Pressure (Pa)&quot;</span><span class="p">,</span>
               <span class="s2">&quot;temp&quot;</span><span class="p">:</span> <span class="s2">&quot;Temperature (C)&quot;</span><span class="p">,</span>
               <span class="s2">&quot;PBLH&quot;</span><span class="p">:</span> <span class="s2">&quot;Boundary layer depth&quot;</span><span class="p">,</span>
               <span class="s2">&quot;wind&quot;</span><span class="p">:</span> <span class="s2">&quot;Wind speed&quot;</span><span class="p">,</span>
               <span class="s2">&quot;wind_direction&quot;</span><span class="p">:</span> <span class="s2">&quot;Wind direction&quot;</span><span class="p">,</span>
               <span class="s2">&quot;release_lon&quot;</span><span class="p">:</span> <span class="s2">&quot;xxxxxxx&quot;</span><span class="p">,</span>
               <span class="s2">&quot;release_lat&quot;</span><span class="p">:</span> <span class="s2">&quot;yyyyyyy&quot;</span><span class="p">}</span>

<span class="n">timestep_for_output</span> <span class="o">=</span> <span class="mf">0.</span>

<span class="c1"># Default to home directory, but update if proper directory is specified</span>
<span class="n">directory_status_log</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;HOME&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="load_NAME"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.load_NAME">[docs]</a><span class="k">def</span> <span class="nf">load_NAME</span><span class="p">(</span><span class="n">file_lines</span><span class="p">,</span> <span class="n">namever</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads the Met Office&#39;s NAME III grid output files returning</span>
<span class="sd">    headers, column definitions and data arrays as 3 separate lists.</span>
<span class="sd">    </span>
<span class="sd">    For a technical specification see </span>
<span class="sd">    http://www-hc.metoffice.com/~apdg/nameiii/ModelDocumentation/md2_4_v2%28Output%29.pdf</span>
<span class="sd">    </span>
<span class="sd">    Inputs to this routine are a list of file text lines (extracted using</span>
<span class="sd">    the extract_file_lines routine), and the NAME version.</span>

<span class="sd">    Where I&#39;ve modified the original Met Office routine to accept file_lines, </span>
<span class="sd">    rather than the file itself, I&#39;ve put the initials MLR</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># loading a file gives a generator of lines which can be progressed using the next() method. </span>
    <span class="c1"># This will come in handy as we wish to progress through the file line by line.</span>
<span class="c1">#    file_handle = file(filename)</span>
    
    <span class="c1"># define a dictionary which can hold the header metadata about this file</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># skip the NAME header of the file which looks something like &#39;NAME III (version X.X.X)&#39;</span>
<span class="c1">#    file_handle.next()</span>
    <span class="c1">#MLR</span>
    <span class="n">file_lines</span><span class="o">=</span><span class="n">file_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    
    <span class="c1"># read the next 16 lines of header information, putting the form &quot;header name:    header value&quot; into a dictionary</span>
    <span class="k">if</span> <span class="n">namever</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">nlines</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="k">elif</span> <span class="n">namever</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">nlines</span> <span class="o">=</span> <span class="mi">17</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span>
<span class="c1">#        header_name, header_value = file_handle.next().split(&#39;:&#39;,1)</span>
        <span class="c1">#MLR        </span>
        <span class="n">header_name</span><span class="p">,</span> <span class="n">header_value</span> <span class="o">=</span> <span class="n">file_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">file_lines</span><span class="o">=</span><span class="n">file_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        
        <span class="c1"># strip off any spurious space characters in the header name and value</span>
        <span class="n">header_name</span> <span class="o">=</span> <span class="n">header_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">header_value</span> <span class="o">=</span> <span class="n">header_value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># cast some headers into floats or integers if they match a given header name</span>
        <span class="k">if</span> <span class="n">header_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;X grid origin&#39;</span><span class="p">,</span> <span class="s1">&#39;Y grid origin&#39;</span><span class="p">,</span> <span class="s1">&#39;X grid resolution&#39;</span><span class="p">,</span> <span class="s1">&#39;Y grid resolution&#39;</span><span class="p">]:</span>
            <span class="n">header_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">header_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;X grid size&#39;</span><span class="p">,</span> <span class="s1">&#39;Y grid size&#39;</span><span class="p">,</span> <span class="s1">&#39;Number of fields&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Number of preliminary cols&#39;</span><span class="p">,</span><span class="s1">&#39;Number of field cols&#39;</span><span class="p">]:</span>
            <span class="n">header_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header_value</span><span class="p">)</span>
        <span class="c1"># Commented out date formatting as Start and End of release can be infinity</span>
        <span class="c1">#elif header_name in [&#39;Run time&#39;, &#39;Start of release&#39;, &#39;End of release&#39;]:</span>
            <span class="c1"># convert the time (currently only works for name 2 format) to python datetimes</span>
            <span class="c1">#if namever==2:</span>
               <span class="c1">#header_value = datetime.datetime.strptime(header_value, UTC_format)</span>

        <span class="n">headers</span><span class="p">[</span><span class="n">header_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">header_value</span>

    <span class="c1"># skip the next blank line in the file.    </span>
<span class="c1">#    file_handle.next()    </span>
    <span class="c1">#MLR</span>
    <span class="n">file_lines</span><span class="o">=</span><span class="n">file_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c1"># Read the lines of column definitions</span>
    <span class="k">if</span> <span class="n">namever</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">column_headings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">column_header_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;species_category&#39;</span><span class="p">,</span> <span class="s1">&#39;species&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_measure&#39;</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;z_level&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">]:</span>
<span class="c1">#            column_headings[column_header_name] = [col.strip() for col in file_handle.next().split(&#39;,&#39;)][:-1]</span>
            <span class="c1">#MLR</span>
            <span class="n">column_headings</span><span class="p">[</span><span class="n">column_header_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">file_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">file_lines</span><span class="o">=</span><span class="n">file_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            
    <span class="k">elif</span> <span class="n">namever</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># skip the next line (contains the word Fields:) in the file.    </span>
<span class="c1">#        file_handle.next()</span>
        <span class="c1">#MLR</span>
        <span class="n">file_lines</span><span class="o">=</span><span class="n">file_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">column_headings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">column_header_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;species&#39;</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">,</span><span class="s1">&#39;source&#39;</span><span class="p">,</span><span class="s1">&#39;ensemble&#39;</span><span class="p">,</span><span class="s1">&#39;time_averaging&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;horiz_averaging&#39;</span><span class="p">,</span><span class="s1">&#39;vert_averaging&#39;</span><span class="p">,</span><span class="s1">&#39;prob_percentile&#39;</span><span class="p">,</span><span class="s1">&#39;prob_percentile_ensemble&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;prob_percentile_time&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;z_level&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">]:</span>
<span class="c1">#            column_headings[column_header_name] = [col.strip() for col in file_handle.next().split(&#39;,&#39;)][:-1]  </span>
            <span class="n">column_headings</span><span class="p">[</span><span class="n">column_header_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">file_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">file_lines</span><span class="o">=</span><span class="n">file_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c1"># convert the time to python datetimes</span>
    <span class="n">new_time_column_header</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">column_headings</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]):</span>
        <span class="c1"># the first 4 columns aren&#39;t time at all, so don&#39;t convert them to datetimes</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">namever</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">new_time_column_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">UTC_format</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">namever</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">new_time_column_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">NAMEIII_short_format</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_time_column_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        
    <span class="n">column_headings</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_time_column_header</span>
        
    <span class="c1"># skip the blank line after the column headers</span>
<span class="c1">#    file_handle.next()</span>
    <span class="c1">#MLR</span>
    <span class="n">file_lines</span><span class="o">=</span><span class="n">file_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    
    <span class="c1"># make a list of data arrays to hold the data for each column </span>
    <span class="n">data_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Y grid size&#39;</span><span class="p">],</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X grid size&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">namever</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">data_arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Number of fields&#39;</span><span class="p">])]</span>
    <span class="k">elif</span> <span class="n">namever</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">data_arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Number of field cols&#39;</span><span class="p">])]</span>
      
    <span class="c1"># iterate over the remaining lines which represent the data in a column form</span>
<span class="c1">#    for line in file_handle:</span>
    <span class="c1">#MLR</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file_lines</span><span class="p">:</span>
        
        <span class="c1"># split the line by comma, removing the last empty column caused by the trailing comma</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># cast the x and y grid positions to floats and convert them to zero based indices</span>
        <span class="c1"># (the numbers are 1 based grid positions where 0.5 represents half a grid point.)</span>
        <span class="k">if</span> <span class="n">namever</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mf">1.5</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mf">1.5</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">namever</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># populate the data arrays (i.e. all columns but the leading 4) </span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data_array</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_arrays</span><span class="p">):</span>
            <span class="n">data_array</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">headers</span><span class="p">,</span> <span class="n">column_headings</span><span class="p">,</span> <span class="n">data_arrays</span></div>
    

<div class="viewcode-block" id="extract_file_lines"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.extract_file_lines">[docs]</a><span class="k">def</span> <span class="nf">extract_file_lines</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Determine whether file is zipped or not, and then extract text into</span>
<span class="sd">    file_lines variable.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="n">fname</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.GZ&quot;</span><span class="p">:</span>
        <span class="c1">#Unzip file</span>
        <span class="n">f</span><span class="o">=</span><span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">file_text</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">file_lines</span><span class="o">=</span><span class="n">file_text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_lines</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>

    <span class="k">return</span> <span class="n">file_lines</span></div>


<div class="viewcode-block" id="read_file"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.read_file">[docs]</a><span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Read a given fields file and break into header, column_headings and data_arrays</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">global</span> <span class="n">namever</span>
    
    <span class="c1">#Extract line-by-line file contents from either txt.gz or txt file    </span>
    <span class="n">file_lines</span><span class="o">=</span><span class="n">extract_file_lines</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

    <span class="c1">#Determine NAME version</span>
    <span class="k">if</span> <span class="n">file_lines</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;FIELDS:&#39;</span><span class="p">:</span>
        <span class="n">namever</span><span class="o">=</span><span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">namever</span><span class="o">=</span><span class="mi">2</span>
    
    <span class="c1">#Load header, column headings and data using Andrew Jones script</span>
    <span class="n">header</span><span class="p">,</span> <span class="n">column_headings</span><span class="p">,</span> <span class="n">data_arrays</span> <span class="o">=</span> \
        <span class="n">load_NAME</span><span class="p">(</span><span class="n">file_lines</span><span class="p">,</span> <span class="n">namever</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">column_headings</span><span class="p">,</span> <span class="n">data_arrays</span></div>


<div class="viewcode-block" id="define_grid"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.define_grid">[docs]</a><span class="k">def</span> <span class="nf">define_grid</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">column_headings</span><span class="p">,</span> <span class="n">satellite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Largely taken from Met Office Python code.</span>
<span class="sd">    </span>
<span class="sd">    Define output grid using file header information.</span>
<span class="sd">    </span>
<span class="sd">    For satellite instructions, see satellite_vertical_profile.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">#Get file info</span>
    <span class="n">z_level</span><span class="o">=</span><span class="n">column_headings</span><span class="p">[</span><span class="s1">&#39;z_level&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">:]</span>
    <span class="n">time</span><span class="o">=</span><span class="n">column_headings</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">namever</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">species_name</span><span class="o">=</span><span class="n">column_headings</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">species_name</span><span class="o">=</span><span class="n">column_headings</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">:]</span>

    <span class="k">if</span> <span class="n">namever</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">timeFormat</span><span class="o">=</span><span class="n">UTC_format</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">timeFormat</span><span class="o">=</span><span class="n">NAMEIII_short_format</span>


    <span class="c1">#Longitude and latitude    </span>
    <span class="c1">#Co-ordinates OF CENTRE OF CELL</span>
    <span class="n">Xcount</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;X grid size&#39;</span><span class="p">]</span>
    <span class="n">Xstep</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;X grid resolution&#39;</span><span class="p">]</span>
    <span class="n">Xstart</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;X grid origin&#39;</span><span class="p">]</span>
    
    <span class="n">Ycount</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Y grid size&#39;</span><span class="p">]</span>
    <span class="n">Ystep</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Y grid resolution&#39;</span><span class="p">]</span>
    <span class="n">Ystart</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;Y grid origin&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">namever</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">lons</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Xstart</span><span class="p">,</span><span class="n">Xstart</span><span class="o">+</span><span class="n">Xcount</span><span class="o">*</span><span class="n">Xstep</span><span class="o">-</span><span class="mf">0.01</span><span class="o">*</span><span class="n">Xstep</span><span class="p">,</span><span class="n">Xstep</span><span class="p">)</span> <span class="o">+</span> <span class="n">Xstep</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">lats</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Ystart</span><span class="p">,</span><span class="n">Ystart</span><span class="o">+</span><span class="n">Ycount</span><span class="o">*</span><span class="n">Ystep</span><span class="o">-</span><span class="mf">0.01</span><span class="o">*</span><span class="n">Ystep</span><span class="p">,</span><span class="n">Ystep</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ystep</span><span class="o">/</span><span class="mf">2.</span>
    <span class="k">elif</span> <span class="n">namever</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">lons</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Xstart</span><span class="p">,</span><span class="n">Xstart</span><span class="o">+</span><span class="n">Xcount</span><span class="o">*</span><span class="n">Xstep</span><span class="o">-</span><span class="mf">0.01</span><span class="o">*</span><span class="n">Xstep</span><span class="p">,</span><span class="n">Xstep</span><span class="p">)</span>
        <span class="n">lats</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Ystart</span><span class="p">,</span><span class="n">Ystart</span><span class="o">+</span><span class="n">Ycount</span><span class="o">*</span><span class="n">Ystep</span><span class="o">-</span><span class="mf">0.01</span><span class="o">*</span><span class="n">Ystep</span><span class="p">,</span><span class="n">Ystep</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Bottom-left grid point (CENTRE): &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;E, &quot;</span> <span class="o">+</span> \
               <span class="nb">str</span><span class="p">(</span><span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span>
               <span class="n">print_to_screen</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">satellite</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        
        <span class="c1">#Get levels and sort in increasing height</span>
        <span class="n">levs</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">z_level</span><span class="p">))</span>
        <span class="n">lev_sort</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">lev</span> <span class="ow">in</span> <span class="n">levs</span><span class="p">:</span>
            <span class="n">digits</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[-+]?\d*\.\d+|\d+&quot;</span><span class="p">,</span> <span class="n">lev</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">digits</span><span class="p">:</span>
                <span class="n">lev_sort</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">10000000.</span><span class="p">)</span> <span class="c1">#PUT STUFF LIKE BOUNDARY LAYER TO END</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lev_sort</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">digits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    
        <span class="n">levs</span><span class="o">=</span><span class="p">[</span><span class="n">lev</span> <span class="k">for</span> <span class="p">(</span><span class="n">sort</span><span class="p">,</span> <span class="n">lev</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lev_sort</span><span class="p">,</span> <span class="n">levs</span><span class="p">))]</span>
        <span class="n">nlevs</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">levs</span><span class="p">)</span>
    
        <span class="c1">#Time</span>
        <span class="c1">#ESTIMATE NUMBER OF TIMESTEPS PER FILE: ASSUMES ONLY ONE SPECIES PER FILE</span>
        <span class="n">ntime</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">/</span><span class="n">nlevs</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Assume only ONE TIME STEP per file</span>
        <span class="c1">#Levels</span>
        <span class="n">nlevs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_level</span><span class="p">)</span>
        <span class="n">levs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlevs</span><span class="p">)</span>
        <span class="n">ntime</span> <span class="o">=</span> <span class="mi">1</span>


    <span class="c1">#Time steps    </span>
    <span class="n">timeRef</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;End of release&#39;</span><span class="p">],</span> <span class="n">timeFormat</span><span class="p">)</span>
    <span class="n">timeEnd</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Start of release&#39;</span><span class="p">],</span> <span class="n">timeFormat</span><span class="p">)</span>
    
    <span class="c1"># Timestep in hours</span>
    <span class="n">timeStep</span><span class="o">=</span><span class="p">(</span><span class="n">timeEnd</span> <span class="o">-</span> <span class="n">timeRef</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">3600.</span><span class="o">/</span><span class="n">ntime</span>
    
    <span class="c1"># Labelling time steps at START of each time period!</span>
    <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">timeRef</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">timeStep</span><span class="o">*</span><span class="n">i</span><span class="p">)</span> \
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntime</span><span class="p">)]</span>
    
    <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Timestep: </span><span class="si">%d</span><span class="s2"> minutes&quot;</span> <span class="o">%</span> <span class="nb">round</span><span class="p">(</span><span class="n">timeStep</span><span class="o">*</span><span class="mi">60</span><span class="p">),</span>
               <span class="n">print_to_screen</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Levels: </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">nlevs</span><span class="p">,</span>
               <span class="n">print_to_screen</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;NAME version: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">namever</span><span class="p">,</span>
               <span class="n">print_to_screen</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">levs</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">timeStep</span></div>


<div class="viewcode-block" id="met_empty"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.met_empty">[docs]</a><span class="k">def</span> <span class="nf">met_empty</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create an empty Met dictionary. Not recommended.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">met</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="mf">0.</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">met_default</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;time&quot;</span><span class="p">},</span>
                          <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1900</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
    <span class="n">met</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;time&quot;</span>
    <span class="n">met</span><span class="p">[</span><span class="s2">&quot;press&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">100000.</span><span class="p">,</span> <span class="mf">100000.</span><span class="p">]</span> <span class="c1">#Pa</span>
    <span class="n">met</span><span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">]</span>    <span class="c1">#C</span>
    
    <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;NO MET&quot;</span><span class="p">,</span> <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">met</span></div>


<div class="viewcode-block" id="read_met"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.read_met">[docs]</a><span class="k">def</span> <span class="nf">read_met</span><span class="p">(</span><span class="n">fnames</span><span class="p">,</span> <span class="n">met_def_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vertical_profile</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    For a given list of filenames, extract site meteorology and concatenate</span>
<span class="sd">    into a Pandas dataframe.</span>
<span class="sd">    </span>
<span class="sd">    A dictionary of output column names and met file header search strings</span>
<span class="sd">    is given in the met_default dictionary at the top of this file.</span>
<span class="sd">    &#39;&#39;&#39;</span>


    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fnames</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">fnames</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fnames</span><span class="o">=</span><span class="p">[</span><span class="n">fnames</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">met_def_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># overwrite met_default with custom list for prcessing vertical profile met</span>
        <span class="n">met_default2</span> <span class="o">=</span> <span class="n">met_def_dict</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">met_default2</span> <span class="o">=</span> <span class="n">met_default</span>
        <span class="c1">#column_indices = {key: -1 for key, value in met_def_dict.iteritems()}</span>
    <span class="c1">#else:</span>
    <span class="n">column_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">met_default2</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()}</span>
    
    <span class="n">output_df</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
        
        <span class="c1">#This should now check for column headings</span>
        <span class="c1">#Mark&#39;s met file output is daily and backwards</span>
        <span class="n">met</span> <span class="o">=</span> <span class="n">extract_file_lines</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;.GZ&#39;</span><span class="p">:</span>
            <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">compression</span><span class="o">=</span><span class="kc">None</span>

        <span class="c1">#Get rid of top of file</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">met</span><span class="p">)):</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">met</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">a</span><span class="o">=</span><span class="n">i</span>
                <span class="k">break</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">skiprows</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> 
                            <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="n">m</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="n">Xcol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Ycol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">X_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Y_file</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1">#Find columns with header names</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">coli</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                    
                    <span class="c1">#Work out column indices by searching through met_default</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">met_default2</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">met_default2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
                            <span class="n">column_indices</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">coli</span>

                    <span class="c1"># Check whether there is an X and Y column</span>
                    <span class="k">if</span> <span class="s2">&quot;X (Lat-Long)&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
                        <span class="n">Xcol</span> <span class="o">=</span> <span class="n">coli</span>
                    <span class="k">if</span> <span class="s2">&quot;Y (Lat-Long)&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
                        <span class="n">Ycol</span> <span class="o">=</span> <span class="n">coli</span>

                    <span class="c1"># Check whether X and Y is in col header</span>
                    <span class="k">if</span> <span class="s2">&quot;X = &quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
                        <span class="n">X_file</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s2">&quot;Y = &quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
                        <span class="n">Y_file</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
                    
        <span class="c1">#Find where data starts</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">break</span>
        
        <span class="n">m2</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>
        
        <span class="c1">#Create arrays/lists to store release locations</span>
        <span class="k">if</span> <span class="n">Xcol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X</span><span class="o">=</span><span class="n">m2</span><span class="p">[:,</span> <span class="n">Xcol</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">Y</span><span class="o">=</span><span class="n">m2</span><span class="p">[:,</span> <span class="n">Ycol</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">X_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">X_file</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m2</span><span class="p">[:,</span> <span class="n">column_indices</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]]]</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="p">[</span><span class="n">Y_file</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m2</span><span class="p">[:,</span> <span class="n">column_indices</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]]]</span>
        
        <span class="c1">#Construct dictionary</span>
        <span class="n">met_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">met_default2</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">column_indices</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span>
                <span class="n">met_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">m2</span><span class="p">[:,</span> <span class="n">column_indices</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">met_dict</span><span class="p">[</span><span class="s2">&quot;release_lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>
        <span class="n">met_dict</span><span class="p">[</span><span class="s2">&quot;release_lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y</span>

        <span class="c1">#Construct dataframe</span>
        <span class="n">output_df_file</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">met_dict</span><span class="p">,</span>
                          <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">pandas</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">dayfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">m2</span><span class="p">[:,</span><span class="n">column_indices</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]]])</span>

        <span class="n">output_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_df_file</span><span class="p">)</span>
    
        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Read Met file... &quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="c1"># Concatenate list of data frames</span>
    <span class="n">output_df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">output_df</span><span class="p">)</span>
    
    <span class="c1"># Check for missing values</span>
    <span class="k">if</span> <span class="n">vertical_profile</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">output_df</span> <span class="o">=</span> <span class="n">output_df</span><span class="p">[</span><span class="n">output_df</span><span class="p">[</span><span class="s2">&quot;press20&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_df</span> <span class="o">=</span> <span class="n">output_df</span><span class="p">[</span><span class="n">output_df</span><span class="p">[</span><span class="s2">&quot;press&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">]</span>
    <span class="n">output_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Remove duplicate indices (if found)</span>
    <span class="n">output_df</span> <span class="o">=</span> <span class="n">output_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>

    <span class="c1"># Sort the dataframe by time</span>
    <span class="n">output_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    
    <span class="n">output_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;time&quot;</span>
    
    <span class="k">return</span> <span class="n">output_df</span></div>


<div class="viewcode-block" id="particle_locations"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.particle_locations">[docs]</a><span class="k">def</span> <span class="nf">particle_locations</span><span class="p">(</span><span class="n">particle_file</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">levs</span><span class="p">,</span> <span class="n">heights</span><span class="p">,</span>
                       <span class="n">id_is_lev</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Read and process a particle location file.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">particle_location_edges</span><span class="p">(</span><span class="n">xvalues</span><span class="p">,</span> <span class="n">yvalues</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        
        <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xedges</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">dx</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">yedges</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">dy</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dy</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        
        <span class="n">hist</span><span class="p">,</span> <span class="n">xe</span><span class="p">,</span> <span class="n">ye</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">xvalues</span><span class="p">,</span> <span class="n">yvalues</span><span class="p">,</span>
                                         <span class="n">bins</span> <span class="o">=</span> <span class="p">(</span><span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">hist</span>
    
    <span class="n">edge_lons</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">lons</span><span class="p">)]</span>
    <span class="n">edge_lats</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">lats</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">lats</span><span class="p">)]</span>
    <span class="n">dlons</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dlats</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">hist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">particles</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">hist</span> <span class="o">=</span> <span class="n">xray</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s2">&quot;pl_n&quot;</span><span class="p">:([</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;lev&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">],</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">levs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">heights</span><span class="p">)))),</span>
                         <span class="s2">&quot;pl_e&quot;</span><span class="p">:([</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;lev&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">],</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">levs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">heights</span><span class="p">)))),</span>
                         <span class="s2">&quot;pl_s&quot;</span><span class="p">:([</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;lev&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">],</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">levs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">heights</span><span class="p">)))),</span>
                         <span class="s2">&quot;pl_w&quot;</span><span class="p">:([</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;lev&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">],</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">levs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">heights</span><span class="p">))))},</span>
                        <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">lats</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span><span class="n">lons</span><span class="p">,</span> <span class="s2">&quot;lev&quot;</span><span class="p">:</span><span class="n">levs</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">:</span><span class="n">heights</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span><span class="n">time</span><span class="p">})</span>

    <span class="c1">#Variables to check domain extents</span>
    <span class="n">particle_extremes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">90.</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">360.</span> <span class="p">,</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="mf">90.</span><span class="p">,</span><span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="mf">360.</span><span class="p">}</span>
    
    <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Particle locations &quot;</span> <span class="o">+</span> <span class="n">particle_file</span><span class="p">,</span> <span class="n">print_to_screen</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">particle_file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;.GZ&#39;</span><span class="p">:</span>
        <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">compression</span><span class="o">=</span><span class="kc">None</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">particle_file</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">)</span>
    
    <span class="n">particles_record</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">])):</span>
        
        <span class="k">if</span> <span class="n">id_is_lev</span><span class="p">:</span>
            <span class="c1"># Only one time step allowed at the moment</span>
            <span class="n">slice_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;lev&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slice_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]}</span>
            
        <span class="c1">#Northern edge</span>
        <span class="n">dfe</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Lat&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_lats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dlats</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">)]</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">pl_n</span><span class="p">[</span><span class="n">slice_dict</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">particle_location_edges</span><span class="p">(</span><span class="n">dfe</span><span class="p">[</span><span class="s2">&quot;Long&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dfe</span><span class="p">[</span><span class="s2">&quot;Ht&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                    <span class="n">lons</span><span class="p">,</span> <span class="n">heights</span><span class="p">)</span>

        <span class="c1">#Eastern edge</span>
        <span class="n">dfe</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Long&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_lons</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dlons</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">)]</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">pl_e</span><span class="p">[</span><span class="n">slice_dict</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">particle_location_edges</span><span class="p">(</span><span class="n">dfe</span><span class="p">[</span><span class="s2">&quot;Lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dfe</span><span class="p">[</span><span class="s2">&quot;Ht&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                    <span class="n">lats</span><span class="p">,</span> <span class="n">heights</span><span class="p">)</span>

        <span class="c1">#Southern edge</span>
        <span class="n">dfe</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Lat&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">edge_lats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dlats</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">)]</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">pl_s</span><span class="p">[</span><span class="n">slice_dict</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">particle_location_edges</span><span class="p">(</span><span class="n">dfe</span><span class="p">[</span><span class="s2">&quot;Long&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dfe</span><span class="p">[</span><span class="s2">&quot;Ht&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                    <span class="n">lons</span><span class="p">,</span> <span class="n">heights</span><span class="p">)</span>

        <span class="c1">#Western edge</span>
        <span class="n">dfe</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Long&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">edge_lons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dlons</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">)]</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">pl_w</span><span class="p">[</span><span class="n">slice_dict</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">particle_location_edges</span><span class="p">(</span><span class="n">dfe</span><span class="p">[</span><span class="s2">&quot;Lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dfe</span><span class="p">[</span><span class="s2">&quot;Ht&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                    <span class="n">lats</span><span class="p">,</span> <span class="n">heights</span><span class="p">)</span>

        <span class="c1">#Calculate total particles and normalise</span>
        <span class="n">hist_sum</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="n">slice_dict</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">particles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">hist_sum</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">hist_sum</span><span class="o">.</span><span class="n">keys</span><span class="p">()]))</span>
        <span class="n">particles_record</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">particles</span><span class="p">))</span>

<span class="c1">#        print(&quot;Number of particles reaching edge: %f02&quot; %particles)</span>

        <span class="k">if</span> <span class="n">particles</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">hist</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">hist</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">slice_dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">slice_dict</span><span class="p">]</span><span class="o">/</span>\
                                                <span class="n">particles</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;No particles have reached edge&quot;</span><span class="p">,</span>
                       <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Copying lower level/previous time step&quot;</span><span class="p">,</span>
                           <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">id_is_lev</span><span class="p">:</span>
                    <span class="n">slice_dict_prev</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;lev&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">slice_dict_prev</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]}</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">hist</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">hist</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">slice_dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">slice_dict_prev</span><span class="p">]</span>
        
        <span class="c1"># Store extremes</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Lat&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">particle_extremes</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]:</span>
            <span class="n">particle_extremes</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Lat&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Lat&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">particle_extremes</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]:</span>
            <span class="n">particle_extremes</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Lat&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Long&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">particle_extremes</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">]:</span>
            <span class="n">particle_extremes</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Long&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Long&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">particle_extremes</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]:</span>
            <span class="n">particle_extremes</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Long&quot;</span><span class="p">])</span>

    <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Number of particles reaching edge: &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">particles_record</span><span class="p">),</span>
               <span class="n">print_to_screen</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    
    <span class="c1">#Check extremes</span>
    <span class="k">if</span> <span class="n">particle_extremes</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">edge_lats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dlats</span><span class="o">/</span><span class="mf">2.</span><span class="p">:</span>
        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;CHECK DOMAIN EDGE TO NORTH&quot;</span><span class="p">,</span> <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">,</span>
                   <span class="n">print_to_screen</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">particle_extremes</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">edge_lons</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dlons</span><span class="o">/</span><span class="mf">2.</span><span class="p">:</span>
        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;CHECK DOMAIN EDGE TO EAST&quot;</span><span class="p">,</span> <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">,</span>
                   <span class="n">print_to_screen</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">particle_extremes</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_lats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dlats</span><span class="o">/</span><span class="mf">2.</span><span class="p">:</span>
        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;CHECK DOMAIN EDGE TO SOUTH&quot;</span><span class="p">,</span> <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">,</span>
                   <span class="n">print_to_screen</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">particle_extremes</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_lons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dlons</span><span class="o">/</span><span class="mf">2.</span><span class="p">:</span>
        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;CHECK DOMAIN EDGE TO WEST&quot;</span><span class="p">,</span> <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">,</span>
                   <span class="n">print_to_screen</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hist</span></div>


<div class="viewcode-block" id="footprint_array"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.footprint_array">[docs]</a><span class="k">def</span> <span class="nf">footprint_array</span><span class="p">(</span><span class="n">fields_file</span><span class="p">,</span> 
                    <span class="n">particle_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">met</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">satellite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">time_step</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert text output from a given file files into arrays in an </span>
<span class="sd">    xray dataset.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">global</span> <span class="n">timestep_for_output</span>

    <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Reading... &quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fields_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">header</span><span class="p">,</span> <span class="n">column_headings</span><span class="p">,</span> <span class="n">data_arrays</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">fields_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">met</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">met</span> <span class="o">=</span> <span class="n">met_empty</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">met</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">met</span> <span class="o">=</span> <span class="p">[</span><span class="n">met</span><span class="p">]</span>

    <span class="c1"># Define grid, including output heights    </span>
    <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">levs</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">timeStep</span> <span class="o">=</span> <span class="n">define_grid</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">column_headings</span><span class="p">,</span>
                                                   <span class="n">satellite</span> <span class="o">=</span> <span class="n">satellite</span><span class="p">)</span>
                                 
    <span class="c1"># If time_step is input, overwrite value from NAME output file</span>
    <span class="k">if</span> <span class="n">time_step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">timeStep</span> <span class="o">=</span> <span class="n">time_step</span>
    
    <span class="n">timestep_for_output</span> <span class="o">=</span> <span class="n">timeStep</span>

    <span class="n">dheights</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">heights</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">19001</span><span class="p">,</span> <span class="n">dheights</span><span class="p">)</span> <span class="o">+</span> <span class="n">dheights</span><span class="o">/</span><span class="mf">2.</span>

    <span class="c1"># Get area of each grid cell</span>
    <span class="n">area</span><span class="o">=</span><span class="n">areagrid</span><span class="p">(</span><span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">)</span>
    
    <span class="c1"># Get particle locations</span>
    <span class="k">if</span> <span class="n">particle_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">particle_hist</span> <span class="o">=</span> <span class="n">particle_locations</span><span class="p">(</span><span class="n">particle_file</span><span class="p">,</span>
                                           <span class="n">time</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">levs</span><span class="p">,</span>
                                           <span class="n">heights</span><span class="p">,</span> <span class="n">id_is_lev</span> <span class="o">=</span> <span class="n">satellite</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;No particle location file corresponding to &quot;</span> <span class="o">+</span> <span class="n">fields_file</span><span class="p">,</span>
                   <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
    
    <span class="n">nlon</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span>
    <span class="n">nlat</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
    <span class="n">nlev</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">levs</span><span class="p">)</span>
    <span class="n">ntime</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Time steps in file: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ntime</span><span class="p">,</span> <span class="n">print_to_screen</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    
    <span class="n">z_level</span><span class="o">=</span><span class="n">column_headings</span><span class="p">[</span><span class="s1">&#39;z_level&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">:]</span>
    <span class="n">time_column</span><span class="o">=</span><span class="n">column_headings</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">:]</span>
    
    <span class="c1"># Set up footprint dataset</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">xray</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s2">&quot;fp&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;lev&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">],</span>
                              <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntime</span><span class="p">,</span> <span class="n">nlev</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nlon</span><span class="p">)))},</span>
                        <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">lats</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span><span class="n">lons</span><span class="p">,</span> <span class="s2">&quot;lev&quot;</span><span class="p">:</span> <span class="n">levs</span><span class="p">,</span> 
                                <span class="s2">&quot;time&quot;</span><span class="p">:</span><span class="n">time</span><span class="p">})</span>

    <span class="n">fp</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;(mol/mol)/(mol/m2/s)&quot;</span><span class="p">}</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;degrees_east&quot;</span><span class="p">}</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;degrees_north&quot;</span><span class="p">}</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;start of time period&quot;</span><span class="p">}</span>
    
    
    <span class="c1"># Add in met data</span>
    <span class="n">met_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span> <span class="p">:</span> <span class="p">([</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;lev&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">levs</span><span class="p">))))</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">met</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">met_ds</span> <span class="o">=</span> <span class="n">xray</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">met_dict</span><span class="p">,</span>
                          <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">time</span><span class="p">),</span>
                                    <span class="s2">&quot;lev&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;lev&quot;</span><span class="p">],</span> <span class="n">levs</span><span class="p">)})</span>
    
    <span class="k">for</span> <span class="n">levi</span><span class="p">,</span> <span class="n">lev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">levs</span><span class="p">):</span>
        <span class="c1"># If there is only one level in the met list</span>
        <span class="c1"># but more levels in the NAME output, just use the same met level</span>
        <span class="c1"># for all NAME levels. This is probably a bad idea.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">met</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">levi_met</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">levs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;ONLY ONE MET LEVEL. &quot;</span> <span class="o">+</span> \
                           <span class="s2">&quot;ASSUMING MET CONSTANT WITH HEIGHT!&quot;</span><span class="p">,</span>
                           <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">levi_met</span> <span class="o">=</span> <span class="n">levi</span>

        <span class="n">metr</span> <span class="o">=</span> <span class="n">met</span><span class="p">[</span><span class="n">levi_met</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">time</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;pad&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">met</span><span class="p">[</span><span class="n">levi_met</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">met_ds</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="nb">dict</span><span class="p">(</span><span class="n">lev</span> <span class="o">=</span> <span class="p">[</span><span class="n">levi</span><span class="p">])]</span> <span class="o">=</span> \
                <span class="n">metr</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Merge met dataset into footprint dataset</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">met_ds</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>


    <span class="c1"># Add in particle locations</span>
    <span class="k">if</span> <span class="n">particle_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">particle_hist</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Extract footprint from columns</span>
    <span class="k">def</span> <span class="nf">convert_to_ppt</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">slice_dict</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="n">molm3</span><span class="o">=</span><span class="n">fp</span><span class="p">[</span><span class="s2">&quot;press&quot;</span><span class="p">][</span><span class="n">slice_dict</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">/</span><span class="n">const</span><span class="o">.</span><span class="n">R</span><span class="o">/</span>\
            <span class="n">const</span><span class="o">.</span><span class="n">C2K</span><span class="p">(</span><span class="n">fp</span><span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">][</span><span class="n">slice_dict</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">fp</span><span class="p">[</span><span class="n">slice_dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_arrays</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">area</span><span class="o">/</span> \
            <span class="p">(</span><span class="mf">3600.</span><span class="o">*</span><span class="n">timeStep</span><span class="o">*</span><span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="n">molm3</span>
        <span class="c1">#The 1 assumes 1g/s emissions rate</span>
        <span class="k">return</span> <span class="n">fp</span>

    <span class="k">if</span> <span class="n">satellite</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">levs</span><span class="p">)):</span>
            <span class="n">slice_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lev</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">convert_to_ppt</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">slice_dict</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)):</span>
            <span class="n">slice_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lev</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">convert_to_ppt</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">slice_dict</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">fp</span></div>
    
    
<div class="viewcode-block" id="footprint_concatenate"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.footprint_concatenate">[docs]</a><span class="k">def</span> <span class="nf">footprint_concatenate</span><span class="p">(</span><span class="n">fields_prefix</span><span class="p">,</span> 
                          <span class="n">particle_prefix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="n">datestr</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
                          <span class="n">met</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="n">satellite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">time_step</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    For a given file search string (fields_prefix), find all fields and particle</span>
<span class="sd">    files, read them and concatenate the output arrays.</span>
<span class="sd">    </span>
<span class="sd">    Returns an xray dataset.</span>
<span class="sd">    </span>
<span class="sd">    Example:</span>
<span class="sd">    </span>
<span class="sd">    fp_dataset = footprint_concatenate(&quot;/dagage2/agage/metoffice/NAME_output/MY_FOOTPRINTS_FOLDER/Fields_Files/filename_prefix&quot;)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    

    <span class="c1"># If no meteorology, get null values</span>
    <span class="c1"># THIS IS NOT RECOMMENDED. ERRORS of ~ ±10%.</span>
    <span class="k">if</span> <span class="n">met</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">met</span> <span class="o">=</span> <span class="n">met_empty</span><span class="p">()</span>

    <span class="c1"># Find footprint files and MATCHING particle location files</span>
    <span class="c1"># These files are identified by their date string. Make sure this is right!</span>
    <span class="k">if</span> <span class="n">satellite</span><span class="p">:</span>
        <span class="c1"># Modified: 06/03/2018 - problems when # files &gt; 100, point 10 was matching multiple</span>
        <span class="n">fields_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">fields_prefix</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span>
                             <span class="n">datestr</span> <span class="o">+</span> <span class="s2">&quot;.txt*&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fields_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">fields_prefix</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span>
                             <span class="n">datestr</span> <span class="o">+</span> <span class="s2">&quot;*.txt*&quot;</span><span class="p">))</span>
                             

    <span class="c1"># Search for particle files                             </span>
    <span class="n">file_datestrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fields_prefix</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.txt&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> \
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields_files</span><span class="p">]</span>

    <span class="n">particle_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">particle_prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">file_datestr</span> <span class="ow">in</span> <span class="n">file_datestrs</span><span class="p">:</span>
            
            <span class="n">particle_file_search_string</span> <span class="o">=</span> \
                <span class="n">particle_prefix</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="n">file_datestr</span> <span class="o">+</span> <span class="s2">&quot;*.txt*&quot;</span>
            <span class="n">particle_file_search</span> <span class="o">=</span> \
                <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">particle_file_search_string</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">particle_file_search</span><span class="p">:</span>
                <span class="n">particle_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">particle_file_search</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can&#39;t find particle file &quot;</span> <span class="o">+</span> \
                      <span class="n">particle_file_search_string</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
                
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">particle_files</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields_files</span><span class="p">):</span>
            <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Particle files don&#39;t match fields files. SKIPPING.&quot;</span><span class="p">,</span>
                       <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">particle_files</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields_files</span><span class="p">]</span>


    <span class="c1"># Create a list of xray datasets</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">fields_file</span><span class="p">,</span> <span class="n">particle_file</span> <span class="ow">in</span> \
            <span class="nb">zip</span><span class="p">(</span><span class="n">fields_files</span><span class="p">,</span> <span class="n">particle_files</span><span class="p">):</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">footprint_array</span><span class="p">(</span><span class="n">fields_file</span><span class="p">,</span>
                                          <span class="n">particle_file</span> <span class="o">=</span> <span class="n">particle_file</span><span class="p">,</span>
                                          <span class="n">met</span> <span class="o">=</span> <span class="n">met</span><span class="p">,</span>
                                          <span class="n">satellite</span> <span class="o">=</span> <span class="n">satellite</span><span class="p">,</span>
                                          <span class="n">time_step</span> <span class="o">=</span> <span class="n">time_step</span><span class="p">))</span>                                  
    <span class="c1"># Concatenate</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">xray</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">fp</span></div>


<div class="viewcode-block" id="write_netcdf"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.write_netcdf">[docs]</a><span class="k">def</span> <span class="nf">write_netcdf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">levs</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pressure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">wind_speed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wind_direction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">PBLH</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="s2">&quot;fp&quot;</span><span class="p">,</span>
            <span class="n">release_lon</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">release_lat</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">particle_locations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">particle_heights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">global_attributes</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">lapse_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lapse_error</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This routine writes a netCDF file with footprints, particle locations</span>
<span class="sd">    meteorology, and release locations.</span>
<span class="sd">    </span>
<span class="sd">    NOTE that netCDF4 is required, as we make use of compression.    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">time_seconds</span><span class="p">,</span> <span class="n">time_reference</span> <span class="o">=</span> <span class="n">time2sec</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    
    <span class="c1">#Write NetCDF file</span>
    <span class="n">ncF</span><span class="o">=</span><span class="n">Dataset</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">ncF</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">))</span>
    <span class="n">ncF</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">))</span>
    <span class="n">ncF</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">))</span>
    <span class="n">ncF</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># pass any global attributes in fp to the netcdf file</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">global_attributes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">ncF</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">global_attributes</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="n">ncF</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">())</span>
    <span class="n">ncF</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="s2">&quot;created&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
    
    
    <span class="n">nctime</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,))</span>
    <span class="n">nclon</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,))</span>
    <span class="n">nclat</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,))</span>
    <span class="n">nclev</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lev&#39;</span><span class="p">,))</span>
    <span class="n">ncfp</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">zlib</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">least_significant_digit</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
    
    <span class="n">nctime</span><span class="p">[:]</span><span class="o">=</span><span class="n">time_seconds</span>
    <span class="n">nctime</span><span class="o">.</span><span class="n">long_name</span><span class="o">=</span><span class="s1">&#39;time&#39;</span>
    <span class="n">nctime</span><span class="o">.</span><span class="n">standard_name</span><span class="o">=</span><span class="s1">&#39;time&#39;</span>
    <span class="n">nctime</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;seconds since &#39;</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="n">time_reference</span><span class="p">)</span>
    <span class="n">nctime</span><span class="o">.</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
    <span class="n">nctime</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestep_for_output</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; hours&quot;</span>
    <span class="n">nctime</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;time stamp corresponds to the beginning of each averaging period&#39;</span>
    <span class="n">nctime</span><span class="o">.</span><span class="n">calendar</span><span class="o">=</span><span class="s1">&#39;gregorian&#39;</span>

    <span class="n">nclon</span><span class="p">[:]</span><span class="o">=</span><span class="n">lons</span>
    <span class="n">nclon</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;Degrees_east&#39;</span>
    
    <span class="n">nclat</span><span class="p">[:]</span><span class="o">=</span><span class="n">lats</span>
    <span class="n">nclat</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;Degrees_north&#39;</span>

    <span class="n">nclev</span><span class="p">[:]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">levs</span><span class="p">)</span>
    
    <span class="n">ncfp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">=</span><span class="n">fp</span>
    <span class="n">ncfp</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;(mol/mol)/(mol/m2/s)&#39;</span>

    <span class="k">if</span> <span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nctemp</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="n">zlib</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">least_significant_digit</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">nctemp</span><span class="p">[:]</span><span class="o">=</span><span class="n">temperature</span>
        <span class="n">nctemp</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;K&#39;</span>

    <span class="k">if</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ncpress</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;pressure&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="n">zlib</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">least_significant_digit</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">ncpress</span><span class="p">[:]</span><span class="o">=</span><span class="n">pressure</span><span class="o">/</span><span class="mf">100.</span>
        <span class="n">ncpress</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;hPa&#39;</span>

    <span class="k">if</span> <span class="n">wind_speed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ncwind_speed</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;wind_speed&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="n">zlib</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">least_significant_digit</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">ncwind_speed</span><span class="p">[:]</span><span class="o">=</span><span class="n">wind_speed</span>
        <span class="n">ncwind_speed</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;m/s&#39;</span>

    <span class="k">if</span> <span class="n">wind_direction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ncwind_direction</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;wind_direction&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="n">zlib</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">least_significant_digit</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">ncwind_direction</span><span class="p">[:]</span><span class="o">=</span><span class="n">wind_direction</span>
        <span class="n">ncwind_direction</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;degrees&#39;</span>

    <span class="k">if</span> <span class="n">PBLH</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ncPBLH</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;PBLH&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="n">zlib</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">least_significant_digit</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">ncPBLH</span><span class="p">[:]</span><span class="o">=</span><span class="n">PBLH</span>
        <span class="n">ncPBLH</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;m&#39;</span>

    <span class="k">if</span> <span class="n">release_lon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ncRlon</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;release_lon&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="n">zlib</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">least_significant_digit</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">ncRlon</span><span class="p">[:]</span><span class="o">=</span><span class="n">release_lon</span>
        <span class="n">ncRlon</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;Degrees_east&#39;</span>

    <span class="k">if</span> <span class="n">release_lat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ncRlat</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;release_lat&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="n">zlib</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">least_significant_digit</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">ncRlat</span><span class="p">[:]</span><span class="o">=</span><span class="n">release_lat</span>
        <span class="n">ncRlat</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;Degrees_north&#39;</span>

    <span class="k">if</span> <span class="n">particle_locations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ncF</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">particle_heights</span><span class="p">))</span>
        <span class="n">ncHeight</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span>
                                   <span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,),</span>
                                    <span class="n">zlib</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">least_significant_digit</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">ncPartN</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;particle_locations_n&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span>
                                   <span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">),</span>
                                    <span class="n">zlib</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">least_significant_digit</span> <span class="o">=</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">ncPartE</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;particle_locations_e&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span>
                                   <span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">),</span>
                                    <span class="n">zlib</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">least_significant_digit</span> <span class="o">=</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">ncPartS</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;particle_locations_s&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span>
                                   <span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">),</span>
                                    <span class="n">zlib</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">least_significant_digit</span> <span class="o">=</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">ncPartW</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;particle_locations_w&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span>
                                   <span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">),</span>
                                    <span class="n">zlib</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">least_significant_digit</span> <span class="o">=</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">ncHeight</span><span class="p">[:]</span><span class="o">=</span><span class="n">particle_heights</span>
        <span class="n">ncPartN</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">=</span><span class="n">particle_locations</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span>
        <span class="n">ncPartE</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">=</span><span class="n">particle_locations</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">]</span>
        <span class="n">ncPartS</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">=</span><span class="n">particle_locations</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span>
        <span class="n">ncPartW</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">=</span><span class="n">particle_locations</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span>
        <span class="n">ncPartN</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="n">ncPartN</span><span class="o">.</span><span class="n">long_name</span><span class="o">=</span><span class="s1">&#39;Fraction of total particles leaving domain (N side)&#39;</span>
        <span class="n">ncPartE</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="n">ncPartE</span><span class="o">.</span><span class="n">long_name</span><span class="o">=</span><span class="s1">&#39;Fraction of total particles leaving domain (E side)&#39;</span>
        <span class="n">ncPartS</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="n">ncPartS</span><span class="o">.</span><span class="n">long_name</span><span class="o">=</span><span class="s1">&#39;Fraction of total particles leaving domain (S side)&#39;</span>
        <span class="n">ncPartW</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="n">ncPartW</span><span class="o">.</span><span class="n">long_name</span><span class="o">=</span><span class="s1">&#39;Fraction of total particles leaving domain (W side)&#39;</span>
    
    <span class="k">if</span> <span class="n">lapse_rate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nclapse</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lapse_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="n">zlib</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">least_significant_digit</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">nclapse</span><span class="p">[:]</span><span class="o">=</span><span class="n">lapse_rate</span>
        <span class="n">nclapse</span><span class="o">.</span><span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;Potential temperature gradient from 60 - 300 m&quot;</span>
        <span class="n">nclapse</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;K/km&#39;</span>
        
    <span class="k">if</span> <span class="n">lapse_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nclerror</span><span class="o">=</span><span class="n">ncF</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lapse_error&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="n">zlib</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">least_significant_digit</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">nclerror</span><span class="p">[:]</span><span class="o">=</span><span class="n">lapse_error</span>
        <span class="n">nclerror</span><span class="o">.</span><span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;Error in potential temperature gradient&quot;</span>
        <span class="n">nclerror</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;K/km&#39;</span>
    
    <span class="n">ncF</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Written... &quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">outfile</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="satellite_vertical_profile"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.satellite_vertical_profile">[docs]</a><span class="k">def</span> <span class="nf">satellite_vertical_profile</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">satellite_obs_file</span><span class="p">,</span> <span class="n">max_level</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Do weighted average by satellite averaging kernel and</span>
<span class="sd">    pressure weight. One time point only. Expects xray.dataset</span>
<span class="sd">    with one time point and N vertical levels.</span>
<span class="sd">    </span>
<span class="sd">    fp = footprint for ONE time point. N levels in lev dimension </span>
<span class="sd">        with footprints and particle locations defined at each level</span>
<span class="sd">    satellite_obs_file = NetCDF-format satellite observation file,</span>
<span class="sd">        one per time step</span>
<span class="sd">    max_level = the maximum vertical level of the retrieval that is included.</span>
<span class="sd">                (maximum for GOSAT to include all levels from model is 20). </span>
<span class="sd">                The remaining levels are set equal to the a priori value.</span>
<span class="sd">                </span>
<span class="sd">    Requirements for running processing satellite footprints</span>
<span class="sd">    </span>
<span class="sd">    General file naming: Files/folders need to have a date string of the form</span>
<span class="sd">        YYYYMMDD-II at the end of the file/folder name,</span>
<span class="sd">        where II is a two-digit index corresponding to the</span>
<span class="sd">        sequence of footprints throughout the day. This modifies the usual</span>
<span class="sd">        naming convention for surface sites, which are only YYYYMMDD.</span>
<span class="sd">    Met: The Met/ folder MUST contain a set of subfolders which are labeled</span>
<span class="sd">        with the YYYYMMDD-II time stamp. Each of these subfolders should then</span>
<span class="sd">        contain nLev Met output files, where nLev are the number of vertical</span>
<span class="sd">        levels in the NAME output. This is required so that we know</span>
<span class="sd">        what pressure/temperature each NAME footprint for each vertical level</span>
<span class="sd">        corresponds to. The files can be named in any way, but the file names</span>
<span class="sd">        must be in ascending order when sorted (i.e. blah_01.txt.gz, blah_02.txt.gz).</span>
<span class="sd">    Fields files:</span>
<span class="sd">        There must be ONE fields file per time stamp, labeled at the end</span>
<span class="sd">        of the file string with YYYYMMDD-II (e.g. blah_YYYYMMDD-II.txt.gz).</span>
<span class="sd">        The fields file must contain exactly nLev columns, one for each vertical</span>
<span class="sd">        level, in ascending order, left to right.</span>
<span class="sd">    Particle location files:</span>
<span class="sd">        There must be ONE fields file per time stamp, labeled at the end</span>
<span class="sd">        of the file string with YYYYMMDD-II (e.g. blah_YYYYMMDD-II.txt.gz).</span>
<span class="sd">        The ID column in this file must contain nLev values in ascending order</span>
<span class="sd">        specifying the vertical level that each particle belongs to.    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="n">max_level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;MAX LEVEL REQUIRED TO PROCESS SATELLITE FOOTPRINTS&quot;</span><span class="p">,</span>
                   <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Reading satellite obs file: &quot;</span> <span class="o">+</span> <span class="n">satellite_obs_file</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">xray</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">satellite_obs_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">sat</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sat</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">fp</span><span class="o">.</span><span class="n">release_lon</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Satellite longitude doesn&#39;t match footprints&quot;</span><span class="p">,</span>
                   <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sat</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">fp</span><span class="o">.</span><span class="n">release_lat</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Satellite latitude doesn&#39;t match footprints&quot;</span><span class="p">,</span>
                   <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sat</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">fp</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="o">*</span><span class="mf">1e9</span><span class="p">:</span>
        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Satellite time doesn&#39;t match footprints&quot;</span><span class="p">,</span>
                   <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;satellite comparison only for one time step at the moment&quot;</span><span class="p">,</span>
                   <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fp</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sat</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;ERROR: satellite comparison only for one time step at the moment&quot;</span><span class="p">,</span>
                   <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fp</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">((</span><span class="n">fp</span><span class="o">.</span><span class="n">pl_n</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">fp</span><span class="o">.</span><span class="n">pl_e</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> \
                        <span class="n">fp</span><span class="o">.</span><span class="n">pl_s</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">fp</span><span class="o">.</span><span class="n">pl_w</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span> \
                        <span class="nb">len</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">lev</span><span class="p">)):</span>
        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Particle histograms dont add up to 1 (or nlev)&quot;</span><span class="p">,</span>
                   <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Change timestamp to that from obs file</span>
    <span class="c1">#  because NAME output only has 1 minute resolution</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">reindex_like</span><span class="p">(</span><span class="n">sat</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;nearest&quot;</span><span class="p">)</span>

    <span class="c1"># Interpolate pressure levels</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fp&quot;</span><span class="p">,</span> <span class="s2">&quot;pl_n&quot;</span><span class="p">,</span> <span class="s2">&quot;pl_e&quot;</span><span class="p">,</span> <span class="s2">&quot;pl_s&quot;</span><span class="p">,</span> <span class="s2">&quot;pl_w&quot;</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lower_levels</span> <span class="o">=</span>  <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">max_level</span><span class="p">)</span>
        
    <span class="c1"># Weight levels using pressure weight and averaging kernel</span>
    <span class="n">sum_ak_pw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sat</span><span class="o">.</span><span class="n">pressure_weights</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()[</span><span class="n">lower_levels</span><span class="p">]</span> <span class="o">*</span> \
                       <span class="n">sat</span><span class="o">.</span><span class="n">xch4_averaging_kernel</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()[</span><span class="n">lower_levels</span><span class="p">])</span>
    <span class="n">sum_particle_count</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="c1"># get dimensions based on level 0</span>
        <span class="n">fp_lev</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">press</span> <span class="o">-</span> \
                            <span class="n">sat</span><span class="o">.</span><span class="n">pressure_levels</span><span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">lev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)]</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">())</span> 
        <span class="n">var</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="n">variable</span><span class="p">][{</span><span class="s2">&quot;lev&quot;</span><span class="p">:</span> <span class="n">fp_lev</span><span class="p">}]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">*</span> \
              <span class="n">sat</span><span class="o">.</span><span class="n">pressure_weights</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> \
              <span class="n">sat</span><span class="o">.</span><span class="n">xch4_averaging_kernel</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="c1"># run levels 1 - max_level (note it is reindexed to 0, therefore use lev+1)</span>
        <span class="k">for</span> <span class="n">lev</span><span class="p">,</span> <span class="n">press</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sat</span><span class="o">.</span><span class="n">pressure_levels</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="n">max_level</span><span class="p">]):</span>
                <span class="n">fp_lev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">press</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">-</span> <span class="n">press</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="n">variable</span><span class="p">][{</span><span class="s2">&quot;lev&quot;</span><span class="p">:</span> <span class="n">fp_lev</span><span class="p">}]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">*</span> \
                      <span class="n">sat</span><span class="o">.</span><span class="n">pressure_weights</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()[</span><span class="n">lev</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> \
                      <span class="n">sat</span><span class="o">.</span><span class="n">xch4_averaging_kernel</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()[</span><span class="n">lev</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">out</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">+=</span> <span class="n">var</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">variable</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pl&quot;</span><span class="p">:</span>
            <span class="n">sum_particle_count</span> <span class="o">+=</span> <span class="n">out</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Check whether particle sum makes sense</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">sum_particle_count</span><span class="p">,</span> <span class="n">sum_ak_pw</span><span class="p">):</span>
        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;ERROR: Particle fractions don&#39;t match averaging_kernel * &quot;</span> <span class="o">+</span> \
                   <span class="s2">&quot;pressure_weight&quot;</span><span class="p">,</span>
                   <span class="n">error_or_warning</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="c1"># Compress dataset to one level and store column totals</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">lev</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">fp</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span>
        
    <span class="n">fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;max_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_level</span>    
    <span class="n">fp</span><span class="p">[</span><span class="s2">&quot;lev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;column&quot;</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">fp</span></div>


<div class="viewcode-block" id="status_log"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.status_log">[docs]</a><span class="k">def</span> <span class="nf">status_log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span>
               <span class="n">directory</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">error_or_warning</span> <span class="o">=</span> <span class="s2">&quot;status&quot;</span><span class="p">,</span>
               <span class="n">print_to_screen</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Write a log of an error or a warning to file. Will append to a file </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">directory_status_log</span>

    <span class="n">date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span>
    <span class="n">month</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span>
    <span class="n">day</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">day</span>
    
    <span class="k">if</span> <span class="n">error_or_warning</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span>
                             <span class="s2">&quot;PROCESS_ERROR_LOG_</span><span class="si">%04d%02d%02d</span><span class="s2">.txt&quot;</span> <span class="o">%</span> 
                             <span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span>
                             <span class="s2">&quot;PROCESS_STATUS_LOG_</span><span class="si">%04d%02d%02d</span><span class="s2">.txt&quot;</span> <span class="o">%</span> 
                             <span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">error_or_warning</span> <span class="o">==</span> <span class="s2">&quot;warning&quot;</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;WARNING: </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">),</span> <span class="n">message</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">error_or_warning</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ERROR: </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">),</span> <span class="n">message</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">),</span> <span class="n">message</span><span class="p">))</span>
            
    <span class="k">if</span> <span class="n">print_to_screen</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">error_or_warning</span> <span class="o">==</span> <span class="s2">&quot;warning&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error_or_warning</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="process_basic"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.process_basic">[docs]</a><span class="k">def</span> <span class="nf">process_basic</span><span class="p">(</span><span class="n">fields_folder</span><span class="p">,</span> <span class="n">outfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Basic processing with no meteorology or particle files</span>
<span class="sd">    NOT recommended, but helpful for a quick check</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">fp</span> <span class="o">=</span> <span class="n">footprint_concatenate</span><span class="p">(</span><span class="n">fields_folder</span><span class="p">)</span>
    <span class="n">write_netcdf</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
                 <span class="n">fp</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> 
                 <span class="n">fp</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> 
                 <span class="n">fp</span><span class="o">.</span><span class="n">lev</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> 
                 <span class="n">fp</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">(),</span> 
                 <span class="n">outfile</span><span class="p">)</span></div>

<div class="viewcode-block" id="process"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.process">[docs]</a><span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="s2">&quot;/dagage2/agage/metoffice/NAME_output/&quot;</span><span class="p">,</span>
            <span class="n">fields_folder</span> <span class="o">=</span> <span class="s2">&quot;Fields_files&quot;</span><span class="p">,</span>
            <span class="n">particles_folder</span> <span class="o">=</span> <span class="s2">&quot;Particle_files&quot;</span><span class="p">,</span>
            <span class="n">met_folder</span> <span class="o">=</span> <span class="s2">&quot;Met&quot;</span><span class="p">,</span>
            <span class="n">force_met_empty</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">processed_folder</span> <span class="o">=</span> <span class="s2">&quot;Processed_Fields_files&quot;</span><span class="p">,</span>
            <span class="n">satellite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">max_level</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">force_update</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">perturbed_folder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">vertical_profile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">transport_model</span><span class="o">=</span><span class="s2">&quot;NAME&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Process a single month of footprints for a given domain, site, height,</span>
<span class="sd">    year, month. If you want to process all files for a given domain + site</span>
<span class="sd">    use process_all.</span>
<span class="sd">    </span>
<span class="sd">    This routine finds all fields files and particle location files which match</span>
<span class="sd">    the timestamp in the file name. The date strings are stored in the datestr</span>
<span class="sd">    variable, and these strings must match exactly for the fields and the particle</span>
<span class="sd">    locations.</span>
<span class="sd">    </span>
<span class="sd">    At the moment, the entire Met folder is read each time.</span>
<span class="sd">    </span>
<span class="sd">    Options:</span>
<span class="sd">    force_update: By default, any existing netCDF files are NOT overwritten.</span>
<span class="sd">        To explicitly over-write a file, set force_update = True</span>
<span class="sd">    satellite: Read a &quot;column&quot; of footprints. There are very particular rules</span>
<span class="sd">        about how the met, footprints and particle location files are stored</span>
<span class="sd">        and named. See extra instructions in satellite_vertical_profile. </span>
<span class="sd">    perturbed_folder: Process a subfolder which has all of the required folders</span>
<span class="sd">        (Fields_files, etc). This is for perturbed parameter ensembles for </span>
<span class="sd">        a particular site. E.g. for EUROPE_BSD_110magl/Perturbed/PARAMETERNAME_VALUE</span>
<span class="sd">        you&#39;d set:</span>
<span class="sd">            perturbed_folder = &quot;Perturbed/PARAMETERNAME_VALUE&quot;</span>
<span class="sd">    max_level: specified only for satellite data and indicates the max level to</span>
<span class="sd">        process the foorprints. levels above are replaced by the prior profile</span>
<span class="sd">    vertical_profile: If set to true will look for vertical potential temperature met file</span>
<span class="sd">        and incorporate into footprint file. </span>
<span class="sd">        NB. This is a separate file from the normal met file, and is not mandatory.</span>
<span class="sd">    transport_model: Defaults to &quot;NAME&quot;. If &quot;STILT&quot;, reads footprints in the</span>
<span class="sd">        ncdf format created by the STILT model. Other values are invalid. Not</span>
<span class="sd">        set up to read satellite column footprints from STILT format.</span>
<span class="sd">        </span>
<span class="sd">    Outputs:</span>
<span class="sd">    This routine outputs a copy of the xray dataset that is written to file.</span>
<span class="sd">    &#39;&#39;&#39;</span>
 
    <span class="k">global</span> <span class="n">directory_status_log</span>
        
    <span class="n">subfolder</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">+</span> <span class="n">domain</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">site</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">height</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
    
    <span class="n">directory_status_log</span> <span class="o">=</span> <span class="n">subfolder</span>
    
    <span class="k">if</span> <span class="n">perturbed_folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">perturbed_folder</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;/&quot;</span><span class="p">:</span>
            <span class="n">subfolder</span> <span class="o">+=</span> <span class="n">perturbed_folder</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subfolder</span> <span class="o">+=</span> <span class="n">perturbed_folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
    
    <span class="c1"># Check that the specified transport model is valid.</span>
    <span class="k">if</span> <span class="n">transport_model</span> <span class="ow">is</span> <span class="s2">&quot;STILT&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">satellite</span><span class="p">:</span>
            <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;stiltfoot_array is not set up for satellite data!&quot;</span> <span class="o">+</span>\
                       <span class="s2">&quot; Levels will be wrong!&quot;</span><span class="p">,</span> <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_met_empty</span><span class="p">:</span>
            <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;STILT neither provides nor requires met information&quot;</span> <span class="o">+</span>\
                       <span class="s2">&quot; to interpret footprints. Met will probably be set&quot;</span> <span class="o">+</span>\
                       <span class="s2">&quot; to default values. Don&#39;t rely on these values!&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">transport_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s2">&quot;NAME&quot;</span><span class="p">:</span>
        <span class="n">status_log</span><span class="p">(</span><span class="n">transport_model</span> <span class="o">+</span> <span class="s2">&quot; is not a valid transport model!&quot;</span> <span class="o">+</span>\
                   <span class="s2">&quot; Unable to read footprint information!&quot;</span><span class="p">,</span> 
                   <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check for manual timestep (if footprints are for &lt; 1min,</span>
    <span class="c1"># which is the min resolution of the NAME output file)    </span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">subfolder</span> <span class="o">+</span> <span class="s2">&quot;/time_step.txt&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">subfolder</span> <span class="o">+</span> <span class="s2">&quot;/time_step.txt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">timeStep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">timeStep</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Get date strings for file search</span>
    <span class="k">if</span> <span class="n">satellite</span><span class="p">:</span>
        <span class="n">file_search_string</span> <span class="o">=</span> <span class="n">subfolder</span> <span class="o">+</span> <span class="n">fields_folder</span> <span class="o">+</span><span class="s2">&quot;/*&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> \
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;*.txt*&quot;</span>
        <span class="n">fields_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file_search_string</span><span class="p">)</span>
        <span class="n">datestrs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">fi</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="n">fields_files</span><span class="p">])</span>

        <span class="c1"># Check that we&#39;ve found something</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datestrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;can&#39;t find files in &quot;</span> <span class="o">+</span> <span class="n">file_search_string</span><span class="p">,</span>
                       <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">transport_model</span> <span class="ow">is</span> <span class="s2">&quot;STILT&quot;</span><span class="p">:</span>
            <span class="n">datestrs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stilt&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;x&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">datestrs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>

    <span class="c1"># Output filename</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="n">subfolder</span> <span class="o">+</span> <span class="n">processed_folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">site</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">height</span> <span class="o">+</span> \
                <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">domain</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span>
 
    <span class="c1"># Check whether outfile needs updating</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">force_update</span><span class="p">:</span>
        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Testing whether file exists or needs updating: &quot;</span> <span class="o">+</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfile</span><span class="p">):</span>
            <span class="n">ncf</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
            <span class="n">time_test</span> <span class="o">=</span> <span class="n">sec2time</span><span class="p">(</span><span class="n">ncf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][:],</span>
                                 <span class="n">ncf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="mi">14</span><span class="p">:])</span>
            <span class="c1">#Find maximum day (minus 0.1s because last time is usually midnight on 1st of the next month)</span>
            <span class="n">maxday</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">time_test</span><span class="p">)</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">))</span><span class="o">.</span><span class="n">day</span>
            <span class="n">ncf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">satellite</span><span class="p">:</span>
                <span class="n">days</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">datestr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span> <span class="k">for</span> <span class="n">datestr</span> <span class="ow">in</span> <span class="n">datestrs</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">maxday</span> <span class="o">&gt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">days</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">transport_model</span> <span class="ow">is</span> <span class="s2">&quot;STILT&quot;</span><span class="p">:</span>
                    <span class="n">stilt_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">subfolder</span> <span class="o">+</span> <span class="n">fields_folder</span> <span class="o">+</span> <span class="s2">&quot;/stilt&quot;</span> <span class="o">+</span> \
                                            <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;x&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;*.nc&quot;</span><span class="p">)</span>
                    <span class="n">days</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">stilt_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> \
                            <span class="k">for</span> <span class="n">stilt_file</span> <span class="ow">in</span> <span class="n">stilt_files</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fields_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">subfolder</span> <span class="o">+</span> <span class="n">fields_folder</span> <span class="o">+</span> <span class="s2">&quot;/*&quot;</span> <span class="o">+</span> \
                                             <span class="n">datestrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;*.txt*&quot;</span><span class="p">)</span>
                    <span class="n">days</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fields_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span> \
                            <span class="k">for</span> <span class="n">fields_file</span> <span class="ow">in</span> <span class="n">fields_files</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">maxday</span> <span class="o">&gt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">days</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">None</span>
                
    <span class="n">fp</span> <span class="o">=</span> <span class="p">[]</span>
     
    <span class="k">for</span> <span class="n">datestr</span> <span class="ow">in</span> <span class="n">datestrs</span><span class="p">:</span>

        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Looking for files with date string: &quot;</span> <span class="o">+</span> <span class="n">datestr</span> <span class="o">+</span> <span class="s2">&quot; in &quot;</span> <span class="o">+</span> \
                   <span class="n">subfolder</span><span class="p">)</span>

        <span class="c1"># Get Met files</span>
        <span class="k">if</span> <span class="n">force_met_empty</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">satellite</span><span class="p">:</span>
                <span class="c1">#met_search_str = subfolder + met_folder + &quot;/*&quot; + datestr + &quot;*/*.txt*&quot;</span>
                <span class="c1"># Modified: 06/03/2018 - problems when # files &gt; 100, point 10 was matching multiple</span>
                <span class="n">met_search_str</span> <span class="o">=</span> <span class="n">subfolder</span> <span class="o">+</span> <span class="n">met_folder</span> <span class="o">+</span> <span class="s2">&quot;/*&quot;</span> <span class="o">+</span> <span class="n">datestr</span> <span class="o">+</span> <span class="s2">&quot;/*.txt*&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">met_search_str</span> <span class="o">=</span> <span class="n">subfolder</span> <span class="o">+</span> <span class="n">met_folder</span> <span class="o">+</span> <span class="s2">&quot;/*.txt*&quot;</span>
      
            <span class="n">met_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">met_search_str</span><span class="p">))</span>
        
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">met_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Can&#39;t file MET files: &quot;</span> <span class="o">+</span> <span class="n">met_search_str</span><span class="p">,</span>
                           <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">satellite</span><span class="p">:</span>
                    <span class="n">met</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">met_file</span> <span class="ow">in</span> <span class="n">met_files</span><span class="p">:</span>
                        <span class="n">met</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">read_met</span><span class="p">(</span><span class="n">met_file</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">met</span> <span class="o">=</span> <span class="n">read_met</span><span class="p">(</span><span class="n">met_files</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">met</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Get footprints</span>
        <span class="k">if</span> <span class="n">transport_model</span> <span class="ow">is</span> <span class="s2">&quot;STILT&quot;</span><span class="p">:</span>
            <span class="n">fp_file</span> <span class="o">=</span> <span class="n">stiltfoot_array</span><span class="p">(</span><span class="n">subfolder</span> <span class="o">+</span> <span class="n">fields_folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">datestr</span><span class="p">,</span> 
                                      <span class="n">met</span><span class="o">=</span><span class="n">met</span><span class="p">,</span> <span class="n">satellite</span><span class="o">=</span><span class="n">satellite</span><span class="p">,</span>
                                      <span class="n">time_step</span><span class="o">=</span><span class="n">timeStep</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># for NAME</span>
            <span class="n">fields_prefix</span> <span class="o">=</span> <span class="n">subfolder</span> <span class="o">+</span> <span class="n">fields_folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
            <span class="k">if</span> <span class="n">particles_folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">particles_prefix</span> <span class="o">=</span> <span class="n">subfolder</span> <span class="o">+</span> <span class="n">particles_folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">particles_prefix</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">fp_file</span> <span class="o">=</span> <span class="n">footprint_concatenate</span><span class="p">(</span><span class="n">fields_prefix</span><span class="p">,</span>
                                            <span class="n">datestr</span> <span class="o">=</span> <span class="n">datestr</span><span class="p">,</span> <span class="n">met</span> <span class="o">=</span> <span class="n">met</span><span class="p">,</span>
                                            <span class="n">particle_prefix</span> <span class="o">=</span> <span class="n">particles_prefix</span><span class="p">,</span>
                                            <span class="n">satellite</span> <span class="o">=</span> <span class="n">satellite</span><span class="p">,</span>
                                            <span class="n">time_step</span> <span class="o">=</span> <span class="n">timeStep</span><span class="p">)</span>
            
        <span class="c1"># Do satellite process</span>
        <span class="k">if</span> <span class="n">satellite</span><span class="p">:</span>
            <span class="c1">#satellite_obs_file = glob.glob(subfolder + &quot;Observations/*&quot; + \</span>
            <span class="c1">#                               datestr + &quot;*.nc&quot;)</span>
            <span class="c1"># Modified: 06/03/2018 - problems when # files &gt; 100, point 10 was matching multiple</span>
            <span class="n">satellite_obs_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">subfolder</span> <span class="o">+</span> <span class="s2">&quot;Observations/*&quot;</span> <span class="o">+</span> \
                                           <span class="n">datestr</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;*.nc&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">satellite_obs_file</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;There must be exactly one matching satellite &quot;</span> <span class="o">+</span> 
                           <span class="s2">&quot;file in the Observations/ folder&quot;</span><span class="p">,</span>
                           <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
                <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Files: &quot;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">satellite_obs_file</span><span class="p">),</span>
                           <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">fp_file</span> <span class="o">=</span> <span class="n">satellite_vertical_profile</span><span class="p">(</span><span class="n">fp_file</span><span class="p">,</span>
                                                 <span class="n">satellite_obs_file</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">max_level</span> <span class="o">=</span> <span class="n">max_level</span><span class="p">)</span>  
            
            <span class="k">if</span> <span class="n">fp_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
                 
        <span class="k">if</span> <span class="n">fp_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fp_file</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        
        <span class="c1"># Concatentate</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">xray</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">)</span>

        <span class="c1"># ONLY OUTPUT FIRST LEVEL FOR NOW</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">lev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">lev</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;ONLY OUTPUTTING FIRST LEVEL!&quot;</span><span class="p">,</span> <span class="n">error_or_warning</span> <span class="o">=</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s2">&quot;lev&quot;</span><span class="p">)</span>
        
        
        <span class="c1"># REMOVE ANY ZERO FOOTPRINTS        </span>
        <span class="n">fp_nonzero</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.</span>
        <span class="n">pl_nonzero</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">pl_n</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">])</span> <span class="o">+</span> \
                      <span class="n">fp</span><span class="o">.</span><span class="n">pl_e</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">])</span> <span class="o">+</span> \
                      <span class="n">fp</span><span class="o">.</span><span class="n">pl_s</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">])</span> <span class="o">+</span> \
                      <span class="n">fp</span><span class="o">.</span><span class="n">pl_w</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.</span>
        <span class="n">indices_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fp_nonzero</span> <span class="o">+</span> <span class="n">pl_nonzero</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="n">indices_nonzero</span><span class="p">)]</span>
        
        <span class="c1"># Get vertical profile met file</span>
        <span class="k">if</span> <span class="n">vertical_profile</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">vp_search_str</span> <span class="o">=</span> <span class="n">subfolder</span> <span class="o">+</span> <span class="s2">&quot;vertical_profile&quot;</span> <span class="o">+</span> <span class="s2">&quot;/*.txt*&quot;</span>     
            <span class="n">vp_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">vp_search_str</span><span class="p">))</span>
        
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vp_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Can&#39;t file Vertical Profile files: &quot;</span> <span class="o">+</span> <span class="n">vp_search_str</span><span class="p">,</span>
                           <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                    <span class="n">vp_met</span> <span class="o">=</span> <span class="n">process_vertical_profile</span><span class="p">(</span><span class="n">vp_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    
                    <span class="c1"># Merge vetical profile met into footprint file with same time index</span>
                    <span class="n">vp_reindex</span> <span class="o">=</span> <span class="n">vp_met</span><span class="o">.</span><span class="n">reindex_like</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="n">tolerance</span> <span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">lapse_in</span> <span class="o">=</span> <span class="n">vp_reindex</span><span class="o">.</span><span class="n">theta_slope</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">lapse_error_in</span><span class="o">=</span><span class="n">vp_reindex</span><span class="o">.</span><span class="n">slope_error</span><span class="o">.</span><span class="n">values</span>
                                      
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lapse_in</span><span class="o">=</span><span class="kc">None</span>
            <span class="n">lapse_error_in</span><span class="o">=</span><span class="kc">None</span>
        
        <span class="c1">#Write netCDF file</span>
        <span class="c1">#######################################</span>
        
        <span class="c1"># Define particle locations dictionary (annoying)</span>
        <span class="k">if</span> <span class="s2">&quot;pl_n&quot;</span> <span class="ow">in</span> <span class="n">fp</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">pl</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">fp</span><span class="o">.</span><span class="n">pl_n</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
                  <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="n">fp</span><span class="o">.</span><span class="n">pl_e</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
                  <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">fp</span><span class="o">.</span><span class="n">pl_s</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
                  <span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="n">fp</span><span class="o">.</span><span class="n">pl_w</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()}</span>
            <span class="n">height_out</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">height</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pl</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">height_out</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Writing file: &quot;</span> <span class="o">+</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">print_to_screen</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="c1"># Write outputs</span>
        <span class="c1">#try:</span>
        <span class="n">write_netcdf</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
                         <span class="n">fp</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
                         <span class="n">fp</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
                         <span class="n">fp</span><span class="o">.</span><span class="n">lev</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                         <span class="n">fp</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">(),</span>
                         <span class="n">outfile</span><span class="p">,</span>
                         <span class="n">temperature</span><span class="o">=</span><span class="n">fp</span><span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
                         <span class="n">pressure</span><span class="o">=</span><span class="n">fp</span><span class="p">[</span><span class="s2">&quot;press&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
                         <span class="n">wind_speed</span><span class="o">=</span><span class="n">fp</span><span class="p">[</span><span class="s2">&quot;wind&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
                         <span class="n">wind_direction</span><span class="o">=</span><span class="n">fp</span><span class="p">[</span><span class="s2">&quot;wind_direction&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
                         <span class="n">PBLH</span><span class="o">=</span><span class="n">fp</span><span class="p">[</span><span class="s2">&quot;PBLH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
                         <span class="n">release_lon</span><span class="o">=</span><span class="n">fp</span><span class="p">[</span><span class="s2">&quot;release_lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
                         <span class="n">release_lat</span><span class="o">=</span><span class="n">fp</span><span class="p">[</span><span class="s2">&quot;release_lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
                         <span class="n">particle_locations</span> <span class="o">=</span> <span class="n">pl</span><span class="p">,</span>
                         <span class="n">particle_heights</span> <span class="o">=</span> <span class="n">height_out</span><span class="p">,</span>
                         <span class="n">global_attributes</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span>
                         <span class="n">lapse_rate</span> <span class="o">=</span> <span class="n">lapse_in</span><span class="p">,</span>
                         <span class="n">lapse_error</span> <span class="o">=</span> <span class="n">lapse_error_in</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;FAILED. Couldn&#39;t seem to find any files, or some files are missing for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                   <span class="n">datestr</span><span class="p">,</span>
                   <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fp</span></div>
    

<div class="viewcode-block" id="process_all"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.process_all">[docs]</a><span class="k">def</span> <span class="nf">process_all</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span>
                <span class="n">heights</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">years_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">months_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">base_dir</span> <span class="o">=</span> <span class="s2">&quot;/dagage2/agage/metoffice/NAME_output/&quot;</span><span class="p">,</span>
                <span class="n">force_update</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">satellite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">perturbed_folder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">max_level</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">force_met_empty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">vertical_profile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">transport_model</span><span class="o">=</span><span class="s2">&quot;NAME&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    For a given domain and site, process all available fields files (including</span>
<span class="sd">    multiple heights).</span>
<span class="sd">    If you want to specify a subset of years/months to process, use the years_in</span>
<span class="sd">    or months_in kewords.</span>
<span class="sd">    </span>
<span class="sd">    Keywords:</span>
<span class="sd">    heights: If you only want to process a subset of heights, OR IF THE HEIGHT</span>
<span class="sd">        INFORMATION IS NOT CONTAINED IN acrg_site_info.json, specify a list of</span>
<span class="sd">        height strings here.</span>
<span class="sd">    years_in: If you only want to process a subset of years, specify here.</span>
<span class="sd">    months_in: Ditto for months</span>
<span class="sd">    force_update: By default, this routine will not overwrite existing netcdf</span>
<span class="sd">        files. Set force_update = True to reprocess an existing file</span>
<span class="sd">    satellite: If a column of footprints needs to be processed, set to true.</span>
<span class="sd">        See extra instructions in satellite_vertical_profile. </span>
<span class="sd">    perturbed_folder: Process a subfolder which has all of the required folders</span>
<span class="sd">        (Fields_files, etc). This is for perturbed parameter ensembles for </span>
<span class="sd">        a particular site. E.g. for EUROPE_BSD_110magl/Perturbed/PARAMETERNAME_VALUE</span>
<span class="sd">        you&#39;d set:</span>
<span class="sd">            perturbed_folder = &quot;Perturbed/PARAMETERNAME_VALUE&quot;</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">acrg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ACRG_PATH&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">acrg_path</span><span class="p">,</span> <span class="s2">&quot;acrg_site_info.json&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">site_info</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
    <span class="c1"># If no height specified, run all heights</span>
    <span class="k">if</span> <span class="n">heights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">heights</span> <span class="o">=</span> <span class="n">site_info</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s2">&quot;height_name&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">heights</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">heights</span> <span class="o">=</span> <span class="p">[</span><span class="n">heights</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">height</span> <span class="ow">in</span> <span class="n">heights</span><span class="p">:</span>
        
        <span class="n">subfolder</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">+</span> <span class="n">domain</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">site</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">height</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
        <span class="k">if</span> <span class="n">perturbed_folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">perturbed_folder</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;/&quot;</span><span class="p">:</span>
                <span class="n">subfolder</span> <span class="o">+=</span> <span class="n">perturbed_folder</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subfolder</span> <span class="o">+=</span> <span class="n">perturbed_folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
        
        <span class="k">if</span> <span class="n">years_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#Find all years and months available</span>
            <span class="c1">#Assumes fields files are processes with _YYYYMMDD.txt.gz at the end (NAME)</span>
            <span class="c1">#or ncdf files starting stiltYYYYxMMx (STILT)</span>
            <span class="n">years</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">months</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">if</span> <span class="n">transport_model</span> <span class="ow">is</span> <span class="s2">&quot;STILT&quot;</span><span class="p">:</span>
                <span class="n">fields_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">subfolder</span> <span class="o">+</span> <span class="s2">&quot;/Fields_files/stilt*.nc&quot;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">fields_file</span> <span class="ow">in</span> <span class="n">fields_files</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">fields_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">years</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">9</span><span class="p">]))</span>
                    <span class="n">months</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">12</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fields_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">subfolder</span> <span class="o">+</span> <span class="s2">&quot;/Fields_files/*.txt*&quot;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">fields_file</span> <span class="ow">in</span> <span class="n">fields_files</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">fields_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">years</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]))</span>
                    <span class="n">months</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">years</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">years_in</span><span class="p">)</span>
            <span class="n">months</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">months_in</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">months</span><span class="p">)):</span>
            <span class="c1">#try:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span>
                    <span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">force_update</span> <span class="o">=</span> <span class="n">force_update</span><span class="p">,</span>
                    <span class="n">satellite</span> <span class="o">=</span> <span class="n">satellite</span><span class="p">,</span> <span class="n">perturbed_folder</span> <span class="o">=</span> <span class="n">perturbed_folder</span><span class="p">,</span>
                    <span class="n">max_level</span> <span class="o">=</span> <span class="n">max_level</span><span class="p">,</span> <span class="n">force_met_empty</span> <span class="o">=</span> <span class="n">force_met_empty</span><span class="p">,</span>
                    <span class="n">vertical_profile</span><span class="o">=</span><span class="n">vertical_profile</span><span class="p">,</span>
                    <span class="n">transport_model</span><span class="o">=</span><span class="n">transport_model</span><span class="p">)</span></div>


<div class="viewcode-block" id="copy_processed"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.copy_processed">[docs]</a><span class="k">def</span> <span class="nf">copy_processed</span><span class="p">(</span><span class="n">domain</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Routine to copy files from:</span>
<span class="sd">        /dagage2/agage/metoffice/NAME_output/DOMAIN_SITE_HEIGHT/Processed_Fields_files</span>
<span class="sd">        to:</span>
<span class="sd">        air.chm:/data/shared/NAME/fp_netcdf/DOMAIN/</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">src_folder</span> <span class="o">=</span> <span class="s2">&quot;/dagage2/agage/metoffice/NAME_output/&quot;</span>
    <span class="n">dst_folder</span> <span class="o">=</span> <span class="s2">&quot;/data/shared/NAME/fp/&quot;</span> <span class="o">+</span> <span class="n">domain</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
    
    <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">src_folder</span> <span class="o">+</span> <span class="n">domain</span> <span class="o">+</span>
        <span class="s2">&quot;_*/Processed_Fields_files/*.nc&quot;</span><span class="p">)</span>
        
    <span class="n">folders</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Syncing &quot;</span> <span class="o">+</span> <span class="n">f</span> <span class="o">+</span> <span class="s2">&quot; and &quot;</span> <span class="o">+</span> <span class="n">dst_folder</span><span class="p">)</span>
        <span class="n">dirsync</span><span class="o">.</span><span class="n">sync</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dst_folder</span><span class="p">,</span> <span class="s2">&quot;sync&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done sync&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="test_processed_met"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.test_processed_met">[docs]</a><span class="k">def</span> <span class="nf">test_processed_met</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span>
                       <span class="n">base_dir</span> <span class="o">=</span> <span class="s2">&quot;/dagage2/agage/metoffice/NAME_output/&quot;</span><span class="p">):</span>
    
    <span class="n">subfolder</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">+</span> <span class="n">domain</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">site</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">height</span> <span class="o">+</span> \
                <span class="s2">&quot;/Processed_Fields_files/&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">subfolder</span> <span class="o">+</span> <span class="s2">&quot;*.nc&quot;</span><span class="p">))</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="p">[]</span>    
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">xray</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">as</span> <span class="n">fi</span><span class="p">:</span> 
            <span class="n">dsf</span> <span class="o">=</span> <span class="n">fi</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="n">ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dsf</span><span class="p">)</span>
    
    <span class="n">ds</span> <span class="o">=</span> <span class="n">xray</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">pressure</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Pressure&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">temperature</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Temperature&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Sum(Footprint)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">particle_locations_n</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">])</span> <span class="o">+</span> \
                      <span class="n">ds</span><span class="o">.</span><span class="n">particle_locations_e</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">])</span> <span class="o">+</span> \
                      <span class="n">ds</span><span class="o">.</span><span class="n">particle_locations_s</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">])</span> <span class="o">+</span> \
                      <span class="n">ds</span><span class="o">.</span><span class="n">particle_locations_w</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Sum(Particle locations) - should sum to 1&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">ds</span></div>

<span class="c1"># Process a list of AGAGE/DECC/GAUGE files if called as main</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">domain</span> <span class="o">=</span> <span class="s2">&quot;EUROPE&quot;</span>
    
    <span class="n">sites</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;BSD&quot;</span><span class="p">,</span> <span class="s2">&quot;TTA&quot;</span><span class="p">,</span> <span class="s2">&quot;RGL&quot;</span><span class="p">,</span> <span class="s2">&quot;MHD&quot;</span><span class="p">,</span> <span class="s2">&quot;HFD&quot;</span><span class="p">,</span> <span class="s2">&quot;TAC&quot;</span><span class="p">,</span>
             <span class="s2">&quot;GAUGE-FERRY&quot;</span><span class="p">,</span> <span class="s2">&quot;GAUGE-FAAM&quot;</span><span class="p">,</span>
             <span class="s2">&quot;EHL&quot;</span><span class="p">,</span> <span class="s2">&quot;TIL&quot;</span><span class="p">,</span> <span class="s2">&quot;GLA&quot;</span><span class="p">,</span> <span class="s2">&quot;WAO&quot;</span><span class="p">,</span> <span class="s2">&quot;HAD&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
        <span class="n">process_all</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">force_update</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        
<div class="viewcode-block" id="process_vertical_profile"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.process_vertical_profile">[docs]</a><span class="k">def</span> <span class="nf">process_vertical_profile</span><span class="p">(</span><span class="n">vp_fname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to process the site specific vertical pressure and temperature gradients.</span>
<span class="sd">    Relies on the process_met function</span>
<span class="sd">    In order to fit into this function the header information needs to be edited</span>
<span class="sd">    in the output files NAME generates. </span>
<span class="sd">    Required structure given in vp_met_dict</span>
<span class="sd">    </span>
<span class="sd">    Outputs: xarray dataset containing:</span>
<span class="sd">        theta_slope - the potential temperature gradient at each time point</span>
<span class="sd">        slope_error - the error in this calculated gradient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<span class="c1">#    vp_met_dict = {&quot;time&quot;: &quot;             T&quot;,&quot;temp20&quot;: &quot;TEMP-Z = 20.00000 m agl&quot;,</span>
<span class="c1">#               &quot;temp40&quot;: &quot;TEMP-Z = 40.00000 m agl&quot;,&quot;temp60&quot;: &quot;TEMP-Z = 60.00000 m agl&quot;,</span>
<span class="c1">#               &quot;temp80&quot;: &quot;TEMP-Z = 80.00000 m agl&quot;,&quot;temp100&quot;: &quot;TEMP-Z = 100.0000 m agl&quot;,</span>
<span class="c1">#               &quot;temp120&quot;: &quot;TEMP-Z = 120.0000 m agl&quot;,&quot;temp140&quot;: &quot;TEMP-Z = 140.0000 m agl&quot;,</span>
<span class="c1">#               &quot;temp160&quot;: &quot;TEMP-Z = 160.0000 m agl&quot;,&quot;temp180&quot;: &quot;TEMP-Z = 180.0000 m agl&quot;,</span>
<span class="c1">#               &quot;temp200&quot;: &quot;TEMP-Z = 200.0000 m agl&quot;,&quot;temp220&quot;: &quot;TEMP-Z = 220.0000 m agl&quot;,</span>
<span class="c1">#               &quot;temp240&quot;: &quot;TEMP-Z = 240.0000 m agl&quot;,&quot;temp260&quot;: &quot;TEMP-Z = 260.0000 m agl&quot;,</span>
<span class="c1">#               &quot;temp280&quot;: &quot;TEMP-Z = 280.0000 m agl&quot;,&quot;temp300&quot;: &quot;TEMP-Z = 300.0000 m agl&quot;,</span>
<span class="c1">#               &quot;press20&quot;: &quot;PRES-Z = 20.00000 m agl&quot;,&quot;press40&quot;: &quot;PRES-Z = 40.00000 m agl&quot;,</span>
<span class="c1">#               &quot;press60&quot;: &quot;PRES-Z = 60.00000 m agl&quot;,&quot;press80&quot;: &quot;PRES-Z = 80.00000 m agl&quot;,</span>
<span class="c1">#               &quot;press100&quot;: &quot;PRES-Z = 100.0000 m agl&quot;,&quot;press120&quot;: &quot;PRES-Z = 120.0000 m agl&quot;,</span>
<span class="c1">#               &quot;press140&quot;: &quot;PRES-Z = 140.0000 m agl&quot;,&quot;press160&quot;: &quot;PRES-Z = 160.0000 m agl&quot;,</span>
<span class="c1">#               &quot;press180&quot;: &quot;PRES-Z = 180.0000 m agl&quot;,&quot;press200&quot;: &quot;PRES-Z = 200.0000 m agl&quot;,</span>
<span class="c1">#               &quot;press220&quot;: &quot;PRES-Z = 220.0000 m agl&quot;,&quot;press240&quot;: &quot;PRES-Z = 240.0000 m agl&quot;,</span>
<span class="c1">#               &quot;press260&quot;: &quot;PRES-Z = 260.0000 m agl&quot;,&quot;press280&quot;: &quot;PRES-Z = 280.0000 m agl&quot;,</span>
<span class="c1">#               &quot;press300&quot;: &quot;PRES-Z = 300.0000 m agl&quot;,</span>
<span class="c1">#               &quot;theta20&quot;: &quot;THETA-Z = 20.00000 m agl&quot;,&quot;theta40&quot;: &quot;THETA-Z = 40.00000 m agl&quot;,</span>
<span class="c1">#               &quot;theta60&quot;: &quot;THETA-Z = 60.00000 m agl&quot;,&quot;theta80&quot;: &quot;THETA-Z = 80.00000 m agl&quot;,</span>
<span class="c1">#               &quot;theta100&quot;: &quot;THETA-Z = 100.0000 m agl&quot;,&quot;theta120&quot;: &quot;THETA-Z = 120.0000 m agl&quot;,</span>
<span class="c1">#               &quot;theta140&quot;: &quot;THETA-Z = 140.0000 m agl&quot;,&quot;theta160&quot;: &quot;THETA-Z = 160.0000 m agl&quot;,</span>
<span class="c1">#               &quot;theta180&quot;: &quot;THETA-Z = 180.0000 m agl&quot;,&quot;theta200&quot;: &quot;THETA-Z = 200.0000 m agl&quot;,</span>
<span class="c1">#               &quot;theta220&quot;: &quot;THETA-Z = 220.0000 m agl&quot;,&quot;theta240&quot;: &quot;THETA-Z = 240.0000 m agl&quot;,</span>
<span class="c1">#               &quot;theta260&quot;: &quot;THETA-Z = 260.0000 m agl&quot;,&quot;theta280&quot;: &quot;THETA-Z = 280.0000 m agl&quot;,</span>
<span class="c1">#               &quot;theta300&quot;: &quot;THETA-Z = 300.0000 m agl&quot;}</span>
    <span class="c1">#vp_fname = &quot;/dagage2/agage/metoffice/vertical_profiles/UKV/GLATTON_Vertical_Profile.txt.gz&quot;  </span>
    
    <span class="n">vp_met_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span><span class="s2">&quot;temp20&quot;</span><span class="p">:</span> <span class="s2">&quot;TEMP-Z = 20.00000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;temp40&quot;</span><span class="p">:</span> <span class="s2">&quot;TEMP-Z = 40.00000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;temp60&quot;</span><span class="p">:</span> <span class="s2">&quot;TEMP-Z = 60.00000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;temp80&quot;</span><span class="p">:</span> <span class="s2">&quot;TEMP-Z = 80.00000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;temp100&quot;</span><span class="p">:</span> <span class="s2">&quot;TEMP-Z = 100.0000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;temp120&quot;</span><span class="p">:</span> <span class="s2">&quot;TEMP-Z = 120.0000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;temp140&quot;</span><span class="p">:</span> <span class="s2">&quot;TEMP-Z = 140.0000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;temp160&quot;</span><span class="p">:</span> <span class="s2">&quot;TEMP-Z = 160.0000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;temp180&quot;</span><span class="p">:</span> <span class="s2">&quot;TEMP-Z = 180.0000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;temp200&quot;</span><span class="p">:</span> <span class="s2">&quot;TEMP-Z = 200.0000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;temp220&quot;</span><span class="p">:</span> <span class="s2">&quot;TEMP-Z = 220.0000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;temp240&quot;</span><span class="p">:</span> <span class="s2">&quot;TEMP-Z = 240.0000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;temp260&quot;</span><span class="p">:</span> <span class="s2">&quot;TEMP-Z = 260.0000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;temp280&quot;</span><span class="p">:</span> <span class="s2">&quot;TEMP-Z = 280.0000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;temp300&quot;</span><span class="p">:</span> <span class="s2">&quot;TEMP-Z = 300.0000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;press20&quot;</span><span class="p">:</span> <span class="s2">&quot;PRES-Z = 20.00000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;press40&quot;</span><span class="p">:</span> <span class="s2">&quot;PRES-Z = 40.00000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;press60&quot;</span><span class="p">:</span> <span class="s2">&quot;PRES-Z = 60.00000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;press80&quot;</span><span class="p">:</span> <span class="s2">&quot;PRES-Z = 80.00000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;press100&quot;</span><span class="p">:</span> <span class="s2">&quot;PRES-Z = 100.0000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;press120&quot;</span><span class="p">:</span> <span class="s2">&quot;PRES-Z = 120.0000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;press140&quot;</span><span class="p">:</span> <span class="s2">&quot;PRES-Z = 140.0000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;press160&quot;</span><span class="p">:</span> <span class="s2">&quot;PRES-Z = 160.0000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;press180&quot;</span><span class="p">:</span> <span class="s2">&quot;PRES-Z = 180.0000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;press200&quot;</span><span class="p">:</span> <span class="s2">&quot;PRES-Z = 200.0000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;press220&quot;</span><span class="p">:</span> <span class="s2">&quot;PRES-Z = 220.0000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;press240&quot;</span><span class="p">:</span> <span class="s2">&quot;PRES-Z = 240.0000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;press260&quot;</span><span class="p">:</span> <span class="s2">&quot;PRES-Z = 260.0000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;press280&quot;</span><span class="p">:</span> <span class="s2">&quot;PRES-Z = 280.0000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;press300&quot;</span><span class="p">:</span> <span class="s2">&quot;PRES-Z = 300.0000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;theta20&quot;</span><span class="p">:</span> <span class="s2">&quot;THETA-Z = 20.00000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;theta40&quot;</span><span class="p">:</span> <span class="s2">&quot;THETA-Z = 40.00000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;theta60&quot;</span><span class="p">:</span> <span class="s2">&quot;THETA-Z = 60.00000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;theta80&quot;</span><span class="p">:</span> <span class="s2">&quot;THETA-Z = 80.00000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;theta100&quot;</span><span class="p">:</span> <span class="s2">&quot;THETA-Z = 100.0000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;theta120&quot;</span><span class="p">:</span> <span class="s2">&quot;THETA-Z = 120.0000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;theta140&quot;</span><span class="p">:</span> <span class="s2">&quot;THETA-Z = 140.0000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;theta160&quot;</span><span class="p">:</span> <span class="s2">&quot;THETA-Z = 160.0000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;theta180&quot;</span><span class="p">:</span> <span class="s2">&quot;THETA-Z = 180.0000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;theta200&quot;</span><span class="p">:</span> <span class="s2">&quot;THETA-Z = 200.0000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;theta220&quot;</span><span class="p">:</span> <span class="s2">&quot;THETA-Z = 220.0000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;theta240&quot;</span><span class="p">:</span> <span class="s2">&quot;THETA-Z = 240.0000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;theta260&quot;</span><span class="p">:</span> <span class="s2">&quot;THETA-Z = 260.0000 m agl&quot;</span><span class="p">,</span><span class="s2">&quot;theta280&quot;</span><span class="p">:</span> <span class="s2">&quot;THETA-Z = 280.0000 m agl&quot;</span><span class="p">,</span>
               <span class="s2">&quot;theta300&quot;</span><span class="p">:</span> <span class="s2">&quot;THETA-Z = 300.0000 m agl&quot;</span><span class="p">}</span>

    <span class="n">vp_met_df</span><span class="o">=</span><span class="n">read_met</span><span class="p">(</span><span class="n">vp_fname</span><span class="p">,</span> <span class="n">met_def_dict</span><span class="o">=</span><span class="n">vp_met_dict</span><span class="p">,</span> <span class="n">vertical_profile</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">lapse_ds</span><span class="o">=</span><span class="n">xray</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">vp_met_df</span><span class="p">)</span>
    
    <span class="n">v_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">320</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">x_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span>
     <span class="n">lapse_ds</span><span class="o">.</span><span class="n">theta60</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">lapse_ds</span><span class="o">.</span><span class="n">theta80</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">lapse_ds</span><span class="o">.</span><span class="n">theta100</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
     <span class="n">lapse_ds</span><span class="o">.</span><span class="n">theta120</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">lapse_ds</span><span class="o">.</span><span class="n">theta140</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">lapse_ds</span><span class="o">.</span><span class="n">theta160</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
     <span class="n">lapse_ds</span><span class="o">.</span><span class="n">theta180</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">lapse_ds</span><span class="o">.</span><span class="n">theta200</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">lapse_ds</span><span class="o">.</span><span class="n">theta220</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
     <span class="n">lapse_ds</span><span class="o">.</span><span class="n">theta240</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">lapse_ds</span><span class="o">.</span><span class="n">theta260</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">lapse_ds</span><span class="o">.</span><span class="n">theta280</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
     <span class="n">lapse_ds</span><span class="o">.</span><span class="n">theta300</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>

    <span class="n">slope_all</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">lapse_ds</span><span class="o">.</span><span class="n">time</span><span class="p">)))</span>
    <span class="n">std_all</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">lapse_ds</span><span class="o">.</span><span class="n">time</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lapse_ds</span><span class="o">.</span><span class="n">time</span><span class="p">)):</span>                                                              
        <span class="n">slope_all</span><span class="p">[</span><span class="n">ti</span><span class="p">],</span> <span class="n">dum</span><span class="p">,</span> <span class="n">dum2</span><span class="p">,</span> <span class="n">dum3</span><span class="p">,</span> <span class="n">std_all</span><span class="p">[</span><span class="n">ti</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span>
                                                    <span class="n">v_all</span><span class="p">,</span><span class="n">x_all</span><span class="p">[:,</span><span class="n">ti</span><span class="p">])</span>
    
    <span class="n">lapse_time</span><span class="o">=</span><span class="n">lapse_ds</span><span class="o">.</span><span class="n">time</span>
            
    <span class="n">lapse_ds2</span> <span class="o">=</span> <span class="n">xray</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;theta_slope&#39;</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">slope_all</span><span class="o">*</span><span class="mf">1000.</span><span class="p">),</span>
                              <span class="s1">&#39;slope_error&#39;</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">std_all</span><span class="o">*</span><span class="mf">1000.</span><span class="p">)},</span>
                                    <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">lapse_time</span><span class="p">)})</span>
    <span class="c1">#ost_mcmc.coords[&quot;sites&quot;]=sites</span>
    <span class="n">lapse_ds2</span><span class="o">.</span><span class="n">theta_slope</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;K/km&quot;</span>
    <span class="n">lapse_ds2</span><span class="o">.</span><span class="n">slope_error</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;K/km&quot;</span>    
    <span class="n">lapse_ds2</span><span class="o">.</span><span class="n">theta_slope</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Potential temperature gradient from 60 - 300 m&quot;</span>
    
    <span class="k">return</span> <span class="n">lapse_ds2</span></div>


<div class="viewcode-block" id="release_point"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.release_point">[docs]</a><span class="k">def</span> <span class="nf">release_point</span><span class="p">(</span><span class="n">nc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the time and location of release from STILT output based on the</span>
<span class="sd">    identifier string. nc should be a netCDF4.Dataset in STILT format.    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ident</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">chartostring</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;ident&#39;</span><span class="p">][:])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ident</span> <span class="o">=</span> <span class="n">ident</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span><span class="o">==</span><span class="mi">8</span><span class="p">:</span>
        <span class="n">ident</span> <span class="o">=</span> <span class="n">ident</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">ident</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">ident</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>
        <span class="n">release_lat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ident</span><span class="p">[</span><span class="mi">4</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">ident</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
        <span class="n">release_lat</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">ident</span><span class="p">[</span><span class="mi">4</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">ident</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span>
        <span class="n">release_lon</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ident</span><span class="p">[</span><span class="mi">5</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">ident</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
        <span class="n">release_lon</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">ident</span><span class="p">[</span><span class="mi">5</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        
    <span class="n">release_ht</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ident</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
        
    <span class="n">time</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ident</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">ident</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:00&quot;</span>
    <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">acrg_time</span><span class="o">.</span><span class="n">convert</span><span class="o">.</span><span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">time</span><span class="p">)]</span>
    <span class="n">time_seconds</span><span class="p">,</span> <span class="n">time_reference</span> <span class="o">=</span> <span class="n">time2sec</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">release_lat</span><span class="p">,</span> <span class="n">release_lon</span><span class="p">,</span> <span class="n">release_ht</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">time_seconds</span><span class="p">,</span> <span class="n">time_reference</span></div>

<div class="viewcode-block" id="stilt_part"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.stilt_part">[docs]</a><span class="k">def</span> <span class="nf">stilt_part</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">domain_N</span><span class="p">,</span> <span class="n">domain_S</span><span class="p">,</span> <span class="n">domain_E</span><span class="p">,</span> <span class="n">domain_W</span><span class="p">,</span> <span class="n">exitfile</span><span class="p">,</span> <span class="n">append</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract particle data from STILT output and assign it the given Id.</span>
<span class="sd">    nc should be a netCDF4.Dataset in STILT format; Id should be an integer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">part</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;part&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">partnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">netCDF4</span><span class="o">.</span><span class="n">chartostring</span><span class="p">(</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;partnames&#39;</span><span class="p">][:]))</span>
    <span class="n">part</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">partnames</span>
    <span class="n">part</span><span class="p">[</span><span class="s1">&#39;Id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Id</span>
            
    <span class="c1"># clean up particle dataframe</span>
    
    <span class="n">part</span><span class="o">=</span><span class="n">part</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;partno&#39;</span><span class="p">})</span>
    <span class="n">part</span><span class="p">[</span><span class="s1">&#39;partno&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">part</span><span class="p">[</span><span class="s1">&#39;partno&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
    
    <span class="c1"># set up domain boundaries</span>
    
    <span class="n">north</span> <span class="o">=</span> <span class="p">(</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">domain_N</span><span class="p">)</span>
    <span class="n">south</span> <span class="o">=</span> <span class="p">(</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">domain_S</span><span class="p">)</span>
    <span class="n">east</span> <span class="o">=</span> <span class="p">(</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">domain_E</span><span class="p">)</span> 
    <span class="n">west</span> <span class="o">=</span> <span class="p">(</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">domain_W</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">north</span> <span class="o">|</span> <span class="n">south</span> <span class="o">|</span> <span class="n">east</span> <span class="o">|</span> <span class="n">west</span>
    <span class="n">part</span><span class="p">[</span><span class="s1">&#39;out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
    
    <span class="c1"># compute domain exit timestep for particles that exit</span>
    <span class="n">outpart</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">out</span><span class="p">,:]</span>
    <span class="n">exittime</span> <span class="o">=</span> <span class="n">outpart</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Id&#39;</span><span class="p">,</span> <span class="s1">&#39;partno&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span><span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">argmin</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">exittime</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">exittime</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1">#otherwise it will become a DataFrame</span>
    
    <span class="c1"># compute last timestep for particles that do not exit</span>
    <span class="n">gp</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Id&#39;</span><span class="p">,</span> <span class="s1">&#39;partno&#39;</span><span class="p">])</span>
    <span class="n">lasttime</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span><span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">argmin</span><span class="p">())</span>
    <span class="n">leaves</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;out&#39;</span> <span class="p">:</span> <span class="nb">any</span><span class="p">})</span>
    <span class="n">lasttime</span> <span class="o">=</span> <span class="n">lasttime</span><span class="p">[</span><span class="o">~</span><span class="n">leaves</span><span class="p">[</span><span class="s1">&#39;out&#39;</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">lasttime</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">lasttime</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1">#otherwise it will become a DataFrame</span>
    
    <span class="c1"># combine particles that do and do not exit</span>
    
    <span class="n">end</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">exittime</span><span class="p">,</span> <span class="n">lasttime</span><span class="p">])</span>
    <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">end</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
    <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;Id&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span><span class="s1">&#39;agl&#39;</span><span class="p">]]</span>
    <span class="n">part</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Id&#39;</span><span class="p">,</span><span class="s1">&#39;Lat&#39;</span><span class="p">,</span><span class="s1">&#39;Long&#39;</span><span class="p">,</span><span class="s1">&#39;Ht&#39;</span><span class="p">]</span>
    
    <span class="c1"># write particle locations to csv</span>
    <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">header</span><span class="o">=</span><span class="kc">True</span>
        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span>
    <span class="n">part</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">exitfile</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">part</span><span class="p">,</span> <span class="n">partnames</span></div>

<div class="viewcode-block" id="stiltfoot_array"><a class="viewcode-back" href="../../api/acrg_name.html#acrg_name.process.stiltfoot_array">[docs]</a><span class="k">def</span> <span class="nf">stiltfoot_array</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> 
                    <span class="n">exitfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">met</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">satellite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">time_step</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read data from STILT netcdf output files into arrays in an xray dataset.</span>
<span class="sd">    The corresponding function for NAME output is footprint_array.</span>
<span class="sd">    This function reads multiple files at once because STILT output is stored</span>
<span class="sd">    as a separate file for each release time. To read a month of output, give</span>
<span class="sd">    a prefix like stilt2016x07x.</span>
<span class="sd">    Arguments:</span>
<span class="sd">        prefix: file pattern prefix (including path) for output files to read</span>
<span class="sd">        exitfile: file in which to temporarily store particle data</span>
<span class="sd">        met: not used to interpret STILT footprints, which are already given</span>
<span class="sd">            in ppm/(mol/m^2/s), but can be included if available.</span>
<span class="sd">        satellite: not implemented; will produce error if True</span>
<span class="sd">        time_step: ignored; not needed to interpret STILT footprints.</span>
<span class="sd">    Returns:</span>
<span class="sd">        fp: an xray dataset as from footprint_concatenate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">exitfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">exitfile</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;stilt_particle_data_temp.csv&quot;</span>

    <span class="k">if</span> <span class="n">satellite</span><span class="p">:</span>
        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;stiltfoot_array is not set up for satellite data!&quot;</span> <span class="o">+</span>\
                   <span class="s2">&quot; Levels will be wrong!&quot;</span><span class="p">,</span> <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
    
    <span class="n">stiltfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;*.nc&quot;</span><span class="p">)</span>
    <span class="n">stiltfiles</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">patternfile</span> <span class="o">=</span> <span class="n">stiltfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># set up lat/lon grid and release location</span>
    
    <span class="n">ncin</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">patternfile</span><span class="p">)</span>
    
    <span class="n">lats</span> <span class="o">=</span> <span class="n">ncin</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;footlat&#39;</span><span class="p">][:]</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="n">ncin</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;footlon&#39;</span><span class="p">][:]</span>
    <span class="n">nlon</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span>
    <span class="n">nlat</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
    
    <span class="n">domain_N</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
    <span class="n">domain_S</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
    <span class="n">domain_E</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span>
    <span class="n">domain_W</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span>
    
    <span class="n">release_lat</span><span class="p">,</span> <span class="n">release_lon</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">time_reference</span> <span class="o">=</span> <span class="n">release_point</span><span class="p">(</span><span class="n">ncin</span><span class="p">)</span>
    
    <span class="n">levs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">]</span>
    <span class="n">nlev</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">levs</span><span class="p">)</span>
    
    <span class="c1"># set up footprint array and particle dataframe</span>
    
    <span class="n">fparrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ncin</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;foot&#39;</span><span class="p">][:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
    
    <span class="n">part</span><span class="p">,</span> <span class="n">partnames</span> <span class="o">=</span> <span class="n">stilt_part</span><span class="p">(</span><span class="n">ncin</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">domain_N</span><span class="p">,</span> <span class="n">domain_S</span><span class="p">,</span> <span class="n">domain_E</span><span class="p">,</span> <span class="n">domain_W</span><span class="p">,</span>
                                 <span class="n">exitfile</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># extract data from remaining files</span>
    
    <span class="n">n</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">stiltfiles</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Loading &quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">ncin</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="n">this_lat</span><span class="p">,</span> <span class="n">this_lon</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">this_time</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">this_reference</span> <span class="o">=</span> <span class="n">release_point</span><span class="p">(</span><span class="n">ncin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">this_reference</span> <span class="o">!=</span> <span class="n">time_reference</span><span class="p">:</span>
            <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Warning! Inconsistent time reference in &quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">,</span> \
                               <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">this_lat</span> <span class="o">!=</span> <span class="n">release_lat</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">this_lon</span> <span class="o">!=</span> <span class="n">release_lon</span><span class="p">):</span>
            <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Warning! Inconsistent release location in &quot;</span> <span class="o">+</span> <span class="n">f</span> <span class="o">+</span> \
                               <span class="s2">&quot;. Skipping.&quot;</span><span class="p">,</span> <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">this_grid_lats</span> <span class="o">=</span> <span class="n">ncin</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;footlat&#39;</span><span class="p">,</span> <span class="p">[])[:]</span>
        <span class="n">this_grid_lons</span> <span class="o">=</span> <span class="n">ncin</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;footlon&#39;</span><span class="p">,</span> <span class="p">[])[:]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">this_grid_lats</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">this_grid_lons</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Warning! Footprint grid missing in &quot;</span> <span class="o">+</span> <span class="n">f</span> <span class="o">+</span> \
                       <span class="s2">&quot;. Skipping.&quot;</span><span class="p">,</span> <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">this_grid_lats</span><span class="p">)</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">this_grid_lons</span><span class="p">)</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">)):</span>
            <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Warning! Inconsistent domain in &quot;</span> <span class="o">+</span> <span class="n">f</span> <span class="o">+</span> \
                               <span class="s2">&quot;. Skipping.&quot;</span><span class="p">,</span> <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">lats</span><span class="o">!=</span><span class="n">this_grid_lats</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">lons</span><span class="o">!=</span><span class="n">this_grid_lons</span><span class="p">)):</span>
            <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Warning! Inconsistent domain in &quot;</span> <span class="o">+</span> <span class="n">f</span> <span class="o">+</span> \
                               <span class="s2">&quot;. Skipping.&quot;</span><span class="p">,</span> <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        
        <span class="n">p</span><span class="p">,</span> <span class="n">pnames</span> <span class="o">=</span> <span class="n">stilt_part</span><span class="p">(</span><span class="n">ncin</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">domain_N</span><span class="p">,</span> <span class="n">domain_S</span><span class="p">,</span> <span class="n">domain_E</span><span class="p">,</span> <span class="n">domain_W</span><span class="p">,</span>
                               <span class="n">exitfile</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pnames</span><span class="o">!=</span><span class="n">partnames</span><span class="p">:</span>
            <span class="n">status_log</span><span class="p">(</span><span class="s2">&quot;Warning! Inconsistent particle variables in &quot;</span> <span class="o">+</span> \
                               <span class="n">f</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">error_or_warning</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
            
        <span class="n">time</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">this_time</span><span class="p">)</span>
        <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span>
<span class="c1">#        part = part.append(p, ignore_index=True)</span>
        <span class="n">fparrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ncin</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;foot&#39;</span><span class="p">][:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    
    <span class="n">fparrays</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">/</span><span class="mi">1000000</span><span class="p">,</span> <span class="n">fparrays</span><span class="p">)</span> <span class="c1"># convert ppm to mol/mol </span>
    
    <span class="c1"># compute particle domain exit statistics</span>
    
    <span class="n">dheights</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">heights</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">19001</span><span class="p">,</span> <span class="n">dheights</span><span class="p">)</span> <span class="o">+</span> <span class="n">dheights</span><span class="o">/</span><span class="mf">2.</span>
    
    <span class="n">particle_hist</span> <span class="o">=</span> <span class="n">particle_locations</span><span class="p">(</span><span class="n">exitfile</span><span class="p">,</span>
                                       <span class="n">time</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">levs</span><span class="p">,</span>
                                       <span class="n">heights</span><span class="p">,</span> <span class="n">id_is_lev</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># set up footprint dataset </span>
    <span class="n">ntime</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">xray</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s2">&quot;fp&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;lev&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">],</span>
                              <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntime</span><span class="p">,</span> <span class="n">nlev</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nlon</span><span class="p">)))},</span>
                        <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">lats</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span><span class="n">lons</span><span class="p">,</span> <span class="s2">&quot;lev&quot;</span><span class="p">:</span> <span class="n">levs</span><span class="p">,</span> 
                                <span class="s2">&quot;time&quot;</span><span class="p">:</span><span class="n">time</span><span class="p">})</span>
    
    <span class="n">fp</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;(mol/mol)/(mol/m2/s)&quot;</span><span class="p">}</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;degrees_east&quot;</span><span class="p">}</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;degrees_north&quot;</span><span class="p">}</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;start of time period&quot;</span><span class="p">}</span>
    
    <span class="c1"># assign dummy met variables </span>
    <span class="c1"># This met information is not from observations and is not used to interpret </span>
    <span class="c1"># STILT output, which is already given in ppm. It is here only to maintain the</span>
    <span class="c1"># expected format.</span>
    <span class="k">if</span> <span class="n">met</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">met</span> <span class="o">=</span> <span class="n">met_empty</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">met</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">met</span> <span class="o">=</span> <span class="p">[</span><span class="n">met</span><span class="p">]</span>
    
    <span class="n">met_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span> <span class="p">:</span> <span class="p">([</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;lev&quot;</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">levs</span><span class="p">))))</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">met</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">met_ds</span> <span class="o">=</span> <span class="n">xray</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">met_dict</span><span class="p">,</span>
                          <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">time</span><span class="p">),</span>
                                    <span class="s2">&quot;lev&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;lev&quot;</span><span class="p">],</span> <span class="n">levs</span><span class="p">)})</span>
    <span class="n">levi</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">levi_met</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">metr</span> <span class="o">=</span> <span class="n">met</span><span class="p">[</span><span class="n">levi_met</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">time</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;pad&quot;</span><span class="p">)</span>
    
    <span class="n">metr</span><span class="p">[</span><span class="s1">&#39;release_lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">release_lat</span>
    <span class="n">metr</span><span class="p">[</span><span class="s1">&#39;release_lon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">release_lon</span>
    
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">met</span><span class="p">[</span><span class="n">levi_met</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">met_ds</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="nb">dict</span><span class="p">(</span><span class="n">lev</span> <span class="o">=</span> <span class="p">[</span><span class="n">levi</span><span class="p">])]</span> <span class="o">=</span> \
        <span class="n">metr</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
            
    <span class="c1"># merge datasets</span>
        
    <span class="n">fp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">met_ds</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">particle_hist</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># insert footprint arrays into dataset</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)):</span>
        <span class="n">slice_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lev</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">fp</span><span class="p">[</span><span class="n">slice_dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">fparrays</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">fp</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, mrghg.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>