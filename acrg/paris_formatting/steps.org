#+title: Steps

* General
1. get list of RHIME output files
2. read in as xarray Datasets
3. drop/rename variables?

* Country totals
** Posterior traces
1. get country file(s)
2. get x-to-country matrices
3. apply ~get_country_traces~ to RHIME output datasets
4. add ~time~ coordinate (using min ~Ytime~ from datasets) and concatenate

** Prior traces
1. apply ~get_prior_samples~ to RHIME output datasets
   1. assuming truncated normal priors here
   2. need min model error
2. get prior x traces by selecting chain 0 of prior from idata
   1. need to rename ~x_dim_0~ (can do this at sampling stage)
   2. better variable names might mean we can merge this with the RHIME output and calculate traces all at once
3. apply ~get_country_trace~
4. add time dimension and concatenate

** Calculate mean, mode, quantiles (HDIs?)
- rename results to names from template
- merge into single Dataset

** If there are multiple country files...
- select desired countries
- concatenate along ~ncountries~

* Flux
** Posterior fluxes
1. get basis matrices
2. get fluxes (e.g. ~fluxapriori~ from RHIME output)
3. get x traces (rename dimension to match category dimension in basis matrices)
4. calculate mean, mode, quantiles, HDIs(?) *on traces*
5. multiply these statistics by the basis functions (using sparse product)

** Prior fluxes
Repeat calculations using prior x traces (calculated previously for country totals)

** Rename and merge

* Concentrations
** Need to convert ~nmeasure~ to site and time info...
** Observations and obs errors
** Prior/Posterior predictive distributions
- Could take similar approach... getting prior samples, combining with RHIME outputs, and using sensitivities to create predictive traces?
- NOTE: predictive traces include model error etc, so we can't just multiply x/bc traces by sensitivities...

** Ancillary info
1. site names
2. site lats/lons
